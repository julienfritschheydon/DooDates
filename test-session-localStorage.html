<!DOCTYPE html>
<html>
<head>
    <title>Test Session localStorage</title>
</head>
<body>
    <h1>Test r√©cup√©ration session depuis localStorage</h1>
    <button onclick="testSession()">Tester r√©cup√©ration session</button>
    <pre id="output"></pre>

    <script>
        function testSession() {
            const output = document.getElementById('output');
            output.textContent = 'Test en cours...\n\n';
            
            let session = null;
            const results = [];
            
            // M√©thode 1: supabase.auth.token
            try {
                const stored = localStorage.getItem('supabase.auth.token');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    const candidate = parsed.currentSession ?? parsed.session ?? parsed;
                    if (candidate?.user && candidate.access_token) {
                        session = candidate;
                        results.push('‚úÖ Session trouv√©e dans supabase.auth.token');
                        results.push(`   Token: ${candidate.access_token.substring(0, 50)}...`);
                        results.push(`   User ID: ${candidate.user?.id}`);
                    } else {
                        results.push('‚ö†Ô∏è supabase.auth.token existe mais format invalide');
                        results.push(`   Keys: ${Object.keys(parsed).join(', ')}`);
                    }
                } else {
                    results.push('‚ùå supabase.auth.token non trouv√©');
                }
            } catch (error) {
                results.push(`‚ùå Erreur parsing supabase.auth.token: ${error.message}`);
            }
            
            // M√©thode 2: Cl√©s legacy sb-*-auth-token
            if (!session) {
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('sb-') && key.endsWith('-auth-token')) {
                            const value = localStorage.getItem(key);
                            if (!value) continue;
                            const candidate = JSON.parse(value);
                            if (candidate?.user && candidate.access_token) {
                                session = candidate;
                                results.push(`‚úÖ Session trouv√©e dans ${key}`);
                                results.push(`   Token: ${candidate.access_token.substring(0, 50)}...`);
                                results.push(`   User ID: ${candidate.user?.id}`);
                                break;
                            }
                        }
                    }
                    if (!session) {
                        results.push('‚ùå Aucune cl√© sb-*-auth-token trouv√©e');
                    }
                } catch (error) {
                    results.push(`‚ùå Erreur parsing legacy session: ${error.message}`);
                }
            }
            
            // Test appel Edge Function si session trouv√©e
            if (session?.access_token) {
                results.push('\nüß™ Test appel Edge Function...');
                const supabaseUrl = 'https://outmbbisrrdiumlweira.supabase.co';
                const anonKey = 'sb_publishable_q17OiSDadRwo8L9Jsc_-Yg_2D6IGDEH';
                
                const body = JSON.stringify({
                    endpoint: 'checkQuota',
                    action: 'ai_message',
                    credits: 1
                });
                
                fetch(`${supabaseUrl}/functions/v1/quota-tracking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`,
                        'apikey': anonKey
                    },
                    body: body
                })
                .then(res => res.json())
                .then(data => {
                    results.push('‚úÖ Appel Edge Function r√©ussi!');
                    results.push(`   R√©ponse: ${JSON.stringify(data, null, 2)}`);
                    output.textContent = results.join('\n');
                })
                .catch(error => {
                    results.push(`‚ùå Erreur appel Edge Function: ${error.message}`);
                    output.textContent = results.join('\n');
                });
            } else {
                results.push('\n‚ùå Pas de session disponible pour tester l\'Edge Function');
                output.textContent = results.join('\n');
            }
        }
        
        // Afficher toutes les cl√©s localStorage qui contiennent "auth" ou "supabase"
        window.onload = function() {
            const output = document.getElementById('output');
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('auth') || key.includes('supabase'))) {
                    keys.push(key);
                }
            }
            output.textContent = `Cl√©s localStorage contenant 'auth' ou 'supabase':\n${keys.join('\n')}\n\nCliquez sur le bouton pour tester la r√©cup√©ration de session.`;
        };
    </script>
</body>
</html>

