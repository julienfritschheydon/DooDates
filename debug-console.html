<!DOCTYPE html>
<html>
<head>
    <title>Debug Console - DooDates Storage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .output { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; white-space: pre-wrap; }
        button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>üîç DooDates Storage Debug Console</h1>
    
    <button onclick="checkStorage()">Check Storage</button>
    <button onclick="createTestConversation()">Create Test Conversation</button>
    <button onclick="clearStorage()">Clear Storage</button>
    
    <div id="output" class="output"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += message + '\n';
            console.log(message);
        }

        function checkStorage() {
            document.getElementById('output').textContent = '';
            log('üß™ Checking localStorage for DooDates data...');
            
            try {
                const storageKey = 'doodates_conversations';
                const existingData = localStorage.getItem(storageKey);
                log('üîç Storage key: ' + storageKey);
                log('üîç Data exists: ' + (existingData ? 'Yes' : 'No'));
                
                if (existingData) {
                    log('üì¶ Raw data length: ' + existingData.length);
                    
                    try {
                        const decompressed = LZString.decompress(existingData);
                        if (decompressed) {
                            const parsed = JSON.parse(decompressed);
                            log('üì¶ Decompressed successfully');
                            log('üîë Available conversation IDs: ' + JSON.stringify(Object.keys(parsed.conversations || {})));
                            log('üí¨ Number of conversations: ' + Object.keys(parsed.conversations || {}).length);
                            log('üìù Number of message threads: ' + Object.keys(parsed.messages || {}).length);
                            
                            // Show first conversation details if any exist
                            const conversationIds = Object.keys(parsed.conversations || {});
                            if (conversationIds.length > 0) {
                                const firstId = conversationIds[0];
                                log('üìã First conversation details:');
                                log('   ID: ' + firstId);
                                log('   Title: ' + (parsed.conversations[firstId].title || 'No title'));
                                log('   Status: ' + (parsed.conversations[firstId].status || 'No status'));
                                log('   Resume URL: http://localhost:8086/chat?resume=' + firstId);
                            }
                        } else {
                            log('‚ùå Failed to decompress data');
                        }
                    } catch (e) {
                        log('‚ùå Failed to parse decompressed data: ' + e.message);
                    }
                } else {
                    log('‚ÑπÔ∏è No DooDates data found in localStorage');
                }
                
            } catch (error) {
                log('‚ùå Error checking storage: ' + error.message);
            }
        }

        function createTestConversation() {
            log('üß™ Creating test conversation...');
            
            try {
                const testId = 'test-' + Date.now();
                const testConversation = {
                    id: testId,
                    title: 'Test Conversation for Resume',
                    status: 'active',
                    firstMessage: 'This is a test conversation to verify resume functionality',
                    messageCount: 1,
                    isFavorite: false,
                    tags: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    metadata: {
                        pollGenerated: false,
                        errorOccurred: false,
                        aiModel: 'gemini-pro',
                        language: 'fr'
                    }
                };

                const testMessage = {
                    id: 'msg-' + Date.now(),
                    conversationId: testId,
                    content: 'This is a test conversation to verify resume functionality',
                    role: 'user',
                    timestamp: new Date().toISOString()
                };

                // Get existing data or create new structure
                const storageKey = 'doodates_conversations';
                let storageData = {
                    conversations: {},
                    messages: {},
                    metadata: {
                        version: '1.0.0',
                        createdAt: new Date().toISOString(),
                        lastAccessed: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                        isGuest: true
                    }
                };

                const existingData = localStorage.getItem(storageKey);
                if (existingData) {
                    try {
                        const decompressed = LZString.decompress(existingData);
                        if (decompressed) {
                            storageData = JSON.parse(decompressed);
                        }
                    } catch (e) {
                        log('‚ö†Ô∏è Using new storage structure due to parse error');
                    }
                }

                // Add test conversation and message
                storageData.conversations[testId] = testConversation;
                storageData.messages[testId] = [testMessage];
                storageData.metadata.lastAccessed = new Date().toISOString();

                // Compress and save
                const compressed = LZString.compress(JSON.stringify(storageData));
                localStorage.setItem(storageKey, compressed);

                log('‚úÖ Test conversation created with ID: ' + testId);
                log('üîó Resume URL: http://localhost:8086/chat?resume=' + testId);
                
            } catch (error) {
                log('‚ùå Error creating test conversation: ' + error.message);
            }
        }

        function clearStorage() {
            if (confirm('Clear all DooDates storage?')) {
                localStorage.removeItem('doodates_conversations');
                log('üóëÔ∏è Storage cleared');
            }
        }

        // Auto-check on load
        window.onload = function() {
            checkStorage();
        };
    </script>
</body>
</html>
