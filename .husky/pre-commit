#!/bin/sh
echo "ğŸ” DooDates - Validation pre-commit..."

# DÃ©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# ggshield secret scan (fail-fast sur toutes les branches, y compris test*)
GGSHIELD_RAN=0
if command -v ggshield >/dev/null 2>&1; then
  echo "ğŸ›¡ï¸ ggshield: scan des secrets (pre-commit)..."
  ggshield secret scan pre-commit
  if [ $? -ne 0 ]; then
    echo "âŒ Secrets dÃ©tectÃ©s - Commit bloquÃ©"
    exit 1
  fi
  GGSHIELD_RAN=1
else
  echo "â„¹ï¸ ggshield non installÃ© (skip)"
fi

# Skip tous les tests pour les branches de test (test, test-*)
if echo "$BRANCH" | grep -qE "^test"; then
  echo "âš¡ Branche TEST ($BRANCH): skip validation complÃ¨te (tests gÃ©rÃ©s par CI)"
  echo "âœ… Pre-commit (test branch) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche bug: validation ultra-rapide (formatage uniquement)
if [ "$BRANCH" = "bug" ]; then
  echo "ğŸ› Branche BUG: validation ultra-rapide..."
  
  # 1. Lint critique uniquement
  echo "ğŸ” ESLint critique..."
  npx eslint . --max-warnings 10 --quiet
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint critiques - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Formatage uniquement
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ¨ VÃ©rification formatage..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
      echo "âŒ Fichiers non formatÃ©s - Lancez 'npm run format'"
      exit 1
    fi
  fi
  
  echo "âœ… Pre-commit (bug) validÃ© ultra-rapide - Tests gÃ©rÃ©s par CI"
  exit 0
fi

# Branche testing: validation rapide (lint + format)
if [ "$BRANCH" = "testing" ]; then
  echo "ğŸ§ª Branche TESTING: validation rapide..."
  
  # 1. Lint lÃ©ger
  echo "ğŸ” ESLint lÃ©ger..."
  npx eslint . --max-warnings 30 --quiet
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint critiques - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Formatage uniquement
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ¨ VÃ©rification formatage..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
      echo "âŒ Fichiers non formatÃ©s - Lancez 'npm run format'"
      exit 1
    fi
  fi
  
  echo "âœ… Pre-commit (testing) validÃ© rapide - Tests complets gÃ©rÃ©s par CI"
  exit 0
fi

# Branche staging: validation intermÃ©diaire (lint + type-check + format)
if [ "$BRANCH" = "staging" ]; then
  echo "ğŸ­ Branche STAGING: validation intermÃ©diaire..."
  
  # 1. Lint standard
  echo "ğŸ” ESLint standard..."
  npx eslint . --max-warnings 100
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Type-check (important pour staging)
  echo "ğŸ” VÃ©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
    exit 1
  fi
  
  # 3. Formatage uniquement
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ¨ VÃ©rification formatage..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
      echo "âŒ Fichiers non formatÃ©s - Lancez 'npm run format'"
      exit 1
    fi
  fi
  
  echo "âœ… Pre-commit (staging) validÃ© - E2E et tests complets gÃ©rÃ©s par CI"
  exit 0
fi

# Branche pre-prod: validation rapide (essentiel uniquement)
if [ "$BRANCH" = "pre-prod" ]; then
  echo "ğŸš€ Branche PRE-PROD: validation RAPIDE (pre-commit)"
  echo "â„¹ï¸  Tests E2E complets seront exÃ©cutÃ©s dans GitHub Actions (version FULL)"
  echo "âš¡  Pre-commit: Lint + Format uniquement (~10s)"
  echo "ğŸ”„  GitHub Actions: Tests E2E complets (~56s)"
  echo ""
  
  # 1. Lint lÃ©ger
  echo "ğŸ” ESLint lÃ©ger..."
  npx eslint . --max-warnings 50 --quiet
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint critiques - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Formatage uniquement
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ¨ VÃ©rification formatage..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
      echo "âŒ Fichiers non formatÃ©s - Lancez 'npm run format' ou utilisez NO_FORMAT=1"
      exit 1
    fi
  fi
  
  echo "âœ… Pre-commit PREPROD terminÃ© (RAPIDE âœ…)"
  echo "ğŸ”„ Prochaine Ã©tape: GitHub Actions exÃ©cutera les tests E2E FULL"
  echo "ğŸ“Š RÃ©partition: Pre-commit (~10s) + GitHub Actions (~56s) = ~1min total"
  exit 0
fi

# ggshield secret scan (fail-fast sur toutes les branches)
if [ "$GGSHIELD_RAN" != "1" ]; then
  if command -v ggshield >/dev/null 2>&1; then
    echo "ğŸ›¡ï¸ ggshield: scan des secrets (pre-commit)..."
    ggshield secret scan pre-commit
    if [ $? -ne 0 ]; then
      echo "âŒ Secrets dÃ©tectÃ©s - Commit bloquÃ©"
      exit 1
    fi
  else
    echo "â„¹ï¸ ggshield non installÃ© (skip)"
  fi
fi

# Mode rapide optionnel pour accÃ©lÃ©rer les commits locaux
# Activez-le avec FAST_HOOKS=1 pour ignorer les vÃ©rifications lourdes
if [ "$FAST_HOOKS" = "1" ]; then
  echo "âš¡ Mode rapide activÃ© (FAST_HOOKS=1) - tests lourds ignorÃ©s"
  echo "ğŸ§ª Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi

  echo "ğŸ’… Formatage du code..."
  npm run format

  echo "âœ… Pre-commit (rapide) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Validation conditionnelle selon la branche
# Branches non-main (feature branches, etc.): validation rapide
if [ "$BRANCH" != "main" ]; then
  echo "âš¡ Branche $BRANCH: validation rapide (lint + format + error handling)..."

  # 0. VÃ©rification serveur local ET erreurs JavaScript (optionnel, activÃ© par dÃ©faut)
  # Skip automatiquement en CI (GitHub Actions, etc.)
  if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
    echo "â­ï¸ Environnement CI dÃ©tectÃ© - VÃ©rification serveur local ignorÃ©e"
  else
    if [ "$SKIP_LOCAL_SERVER_CHECK" = "1" ]; then
      echo "â­ï¸ VÃ©rification serveur local ignorÃ©e (SKIP_LOCAL_SERVER_CHECK=1)"
    else
      echo "ğŸŒ VÃ©rification serveur local et erreurs JavaScript..."
      if [ -f "scripts/verify-local-server-with-console-check.js" ]; then
        # Utiliser le script Node.js optimisÃ© qui vÃ©rifie aussi les erreurs console avec Playwright
        node scripts/verify-local-server-with-console-check.js
        if [ $? -ne 0 ]; then
          echo "âŒ Erreurs JavaScript dÃ©tectÃ©es - Le site ne fonctionne pas correctement"
          echo "ğŸ’¡ Corrigez les erreurs avant de commiter"
          echo "ğŸ’¡ Pour ignorer cette vÃ©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          exit 1  # Bloquer le commit si erreurs JS dÃ©tectÃ©es
        fi
      elif [ -f "scripts/verify-local-server.sh" ]; then
        bash scripts/verify-local-server.sh
        if [ $? -ne 0 ]; then
          echo "âš ï¸ Serveur local non disponible - VÃ©rifiez avec: npm run dev"
          echo "ğŸ’¡ Pour ignorer cette vÃ©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          # Ne pas bloquer le commit, juste avertir
        fi
      elif [ -f "scripts/verify-local-server.ps1" ]; then
        # Sur Windows avec PowerShell
        pwsh -File scripts/verify-local-server.ps1
        if [ $? -ne 0 ]; then
          echo "âš ï¸ Serveur local non disponible - VÃ©rifiez avec: npm run dev"
          echo "ğŸ’¡ Pour ignorer cette vÃ©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          # Ne pas bloquer le commit, juste avertir
        fi
      else
        echo "âš ï¸ Script de vÃ©rification serveur local non trouvÃ©"
      fi
    fi
  fi

  # 1. Lint strict (0 warnings, pas de any)
  echo "ğŸ” ESLint (Strict - 0 warnings autorisÃ©es)..."
  npm run lint -- --max-warnings=0
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs ou warnings lint - Commit bloquÃ©"
    echo "ğŸ’¡ Corrigez avec: npm run lint:fix"
    exit 1
  fi

  # 2. Error Handling Enforcement (rapide ~5s)
  echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "âŒ Violations Error Handling dÃ©tectÃ©es - Commit bloquÃ©"
    echo "ğŸ’¡ Utilisez ErrorFactory au lieu de 'throw new Error'"
    exit 1
  fi

  # 2b. VÃ©rification testabilitÃ© (data-testid, tests pour nouveau code)
  echo "ğŸ§ª VÃ©rification testabilitÃ©..."
  node scripts/verify-testability.cjs
  if [ $? -ne 0 ]; then
    echo "âš ï¸ ProblÃ¨mes de testabilitÃ© dÃ©tectÃ©s (non bloquant pour le moment)"
  fi

  # 2c. Validation rÃ¨gles E2E (bonnes pratiques)
  echo "ğŸ“‹ Validation rÃ¨gles E2E..."
  node scripts/validation/validate-e2e-rules.cjs --staged
  if [ $? -ne 0 ]; then
    echo "âŒ Violations des rÃ¨gles E2E dÃ©tectÃ©es - Commit bloquÃ©"
    echo "ğŸ’¡ Consultez Docs/TESTS/-Tests-Guide.md pour les bonnes pratiques"
    exit 1
  fi

  # 3. Tests E2E critiques (ultra-simple form + poll @critical)
  echo "ğŸŒ Tests E2E critiques (ultra-simple form + poll)..."
  E2E_FORCE_MOCKS=true npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E critiques Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi

  # 3b. Test CI Debug rapide (vÃ©rification NODE_ENV)
  echo "ğŸ” Test CI Debug rapide (vÃ©rification NODE_ENV)..."
  if [ -f "tests/e2e/ci-debug-chat-input.spec.ts" ]; then
    echo "âœ… Test CI Debug prÃ©sent - NODE_ENV sera vÃ©rifiÃ© en CI"
  else
    echo "âŒ Test CI Debug manquant - Commit bloquÃ©"
    echo "ğŸ’¡ Le test ci-debug-chat-input.spec.ts est requis pour vÃ©rifier NODE_ENV=development en CI"
    exit 1
  fi

  # 4. Formatage automatique
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ’… Formatage du code..."
    npm run format
    # Auto-stage les fichiers formatÃ©s pour Ã©viter les changements non commitÃ©s
    git add -u
  else
    echo "â­ï¸ Formatage ignorÃ© (NO_FORMAT=1)"
  fi

  echo "âœ… Pre-commit ($BRANCH) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche MAIN: validation complÃ¨te
echo "ğŸ”’ Branche MAIN: validation complÃ¨te..."

# 0. Lint strict (Main branch)
echo "ğŸ” ESLint (Strict)..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Erreurs lint - Commit bloquÃ©"
  exit 1
fi

# 0. Validation qualitÃ© du code (nouvelle rÃ¨gle)
echo "ğŸ” Validation qualitÃ© du code..."
npm run validate
if [ $? -ne 0 ]; then
  echo "âŒ Validation qualitÃ© Ã©chouÃ©e - Commit bloquÃ©"
  echo "ğŸ’¡ Consultez Docs/DEVELOPMENT-GUIDELINES.md"
  exit 1
fi

# 1. Tests unitaires rapides (< 30s)
echo "ğŸ§ª Tests unitaires rapides..."
npm run test:unit:fast
if [ $? -ne 0 ]; then
  echo "âŒ Tests unitaires Ã©chouÃ©s - Commit bloquÃ©"
  exit 1
fi

# 2. Validation TypeScript
echo "ğŸ” VÃ©rification TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
  exit 1
fi

# 3. Tests UX RÃ©gression (critique)
echo "ğŸ¨ Tests UX RÃ©gression..."
npm run test:ux-regression
if [ $? -ne 0 ]; then
  echo "âŒ RÃ©gression UX dÃ©tectÃ©e - Commit bloquÃ©"
  exit 1
fi

# 4. Tests d'intÃ©gration
echo "ğŸ”— Tests d'intÃ©gration..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Commit bloquÃ©"
  exit 1
fi

# 5. Error Handling Enforcement (CRITIQUE)
echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
npm run test:error-handling
if [ $? -ne 0 ]; then
  echo "âŒ Violations Error Handling dÃ©tectÃ©es - Commit bloquÃ©"
  echo "ğŸ’¡ Utilisez ErrorFactory au lieu de 'throw new Error'"
  exit 1
fi

# 5b. Validation rÃ¨gles E2E (bonnes pratiques)
echo "ğŸ“‹ Validation rÃ¨gles E2E..."
node scripts/validation/validate-e2e-rules.cjs --staged
if [ $? -ne 0 ]; then
  echo "âŒ Violations des rÃ¨gles E2E dÃ©tectÃ©es - Commit bloquÃ©"
  echo "ğŸ’¡ Consultez Docs/TESTS/-Tests-Guide.md pour les bonnes pratiques"
  exit 1
fi

# 5c. Audit Data-testid (multilingue)
echo "ğŸ” Audit Data-testid (multilingue)..."
node scripts/data-testid-auditor.cjs
if [ $? -ne 0 ]; then
  echo "âŒ Boutons sans data-testid dÃ©tectÃ©s - Commit bloquÃ©"
  echo "ğŸ’¡ Pour corriger automatiquement: npm run audit:data-testid:fix"
  echo "ğŸ’¡ Pour ignorer temporairement: git commit --no-verify"
  exit 1
fi

# 6. Formatage automatique (optionnel)
# DÃ©sactivez avec NO_FORMAT=1 pour Ã©viter les changements automatiques
if [ "$NO_FORMAT" != "1" ]; then
  echo "ğŸ’… Formatage du code..."
  npm run format
else
  echo "â­ï¸ Formatage ignorÃ© (NO_FORMAT=1)"
fi

echo "âœ… Pre-commit validÃ© - Commit autorisÃ©"
