#!/bin/sh
echo "üîç DooDates - Validation RAPIDE pre-commit..."

# D√©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# 1. Audit Data-testid (Boutons/Accessibilit√©) - ULTRA RAPIDE (<1s)
echo "üîç Audit Data-testid (Boutons)..."
node scripts/data-testid-auditor.cjs --fix
if [ $? -ne 0 ]; then
  echo "‚ùå Boutons sans data-testid d√©tect√©s et non-corrigibles automatiquement - Commit bloqu√©"
  exit 1
fi
# R√©-ajouter les fichiers modifi√©s par l'auditeur s'il y en a
git add src

# 2. Linting (Strict) - MOYEN (~5-10s)
echo "üîç ESLint (Strict)..."
npm run lint -- --quiet
if [ $? -ne 0 ]; then
  echo "‚ùå Erreurs lint d√©tect√©es - Commit bloqu√©"
  echo "üí° Pour corriger automatiquement: npm run lint:fix"
  exit 1
fi

# 3. Formatage (Prettier) - RAPIDE (~2-3s)
# 3. Formatage (Staged) via lint-staged
echo "üé® Formatage automatique (lint-staged)..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "‚ùå Erreur lint-staged - Commit bloqu√©"
  exit 1
fi

# 4. ggshield (Secrets) - S√©curit√©
if command -v ggshield >/dev/null 2>&1; then
  echo "üõ°Ô∏è ggshield: scan des secrets..."
  ggshield secret scan pre-commit
  if [ $? -ne 0 ]; then
    echo "‚ùå Secrets d√©tect√©s - Commit bloqu√©"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è ggshield non install√© (skip)"
fi

# 5. Type-check (TypeScript) - MOYEN (~15s)
# On le garde car c'est critique pour √©viter les bugs de compilation
echo "üîç V√©rification TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå Erreurs TypeScript - Commit bloqu√©"
  exit 1
fi

# NOTE: Les tests unitaires et E2E sont supprim√©s du pre-commit pour plus de rapidit√©.
# Ils restent obligatoires dans le pre-push et en CI.

echo "‚úÖ Pre-commit valid√© - Commit autoris√©"
exit 0
