#!/bin/sh
echo "üîç DooDates - Validation pre-commit..."

# D√©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# ggshield secret scan (fail-fast sur toutes les branches, y compris test*)
GGSHIELD_RAN=0
if command -v ggshield >/dev/null 2>&1; then
  echo "üõ°Ô∏è ggshield: scan des secrets (pre-commit)..."
  ggshield secret scan pre-commit
  if [ $? -ne 0 ]; then
    echo "‚ùå Secrets d√©tect√©s - Commit bloqu√©"
    exit 1
  fi
  GGSHIELD_RAN=1
else
  echo "‚ÑπÔ∏è ggshield non install√© (skip)"
fi

# Skip tous les tests pour les branches de test (test, test-*)
if echo "$BRANCH" | grep -qE "^test"; then
  echo "‚ö° Branche TEST ($BRANCH): skip validation compl√®te (tests g√©r√©s par CI)"
  echo "‚úÖ Pre-commit (test branch) valid√© - Commit autoris√©"
  exit 0
fi

# Branche bug: validation l√©g√®re (lint + error handling + format)
if [ "$BRANCH" = "bug" ]; then
  echo "üêõ Branche BUG: validation l√©g√®re..."
  
  # 1. Lint rapide (quiet = pas de warnings)
  echo "üîç ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 1000 --quiet
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs lint - Commit bloqu√©"
    exit 1
  fi
  
  # 1b. V√©rification Jest vs Vitest (√©viter les erreurs CI)
  echo "üß™ V√©rification Jest vs Vitest..."
  JEST_VIOLATIONS=$(git diff --cached --name-only | grep -E '\.test\.(ts|tsx)$' | xargs grep -l '@jest/globals\|jest\.mock\|jest\.fn' 2>/dev/null || true)
  if [ -n "$JEST_VIOLATIONS" ]; then
    echo "‚ùå Utilisation de Jest d√©tect√©e dans des fichiers Vitest:"
    echo "$JEST_VIOLATIONS"
    echo "üí° Remplacez '@jest/globals' par 'vitest'"
    echo "üí° Remplacez 'jest.mock' par 'vi.mock'"
    echo "üí° Remplacez 'jest.fn' par 'vi.fn'"
    exit 1
  fi
  
  # 2. Error Handling (CRITIQUE - sur toutes les branches)
  echo "üõ°Ô∏è V√©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations Error Handling - Commit bloqu√©"
    echo "üí° Utilisez ErrorFactory au lieu de 'throw new Error'"
    echo "üí° Utilisez logError() au lieu de 'console.error'"
    exit 1
  fi
  
  # 3. Tests unitaires rapides
  echo "üß™ Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests unitaires √©chou√©s - Commit bloqu√©"
    exit 1
  fi
  
  # 4. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "üíÖ Formatage du code..."
    npm run format
  fi
  
  echo "‚úÖ Pre-commit (bug) valid√© - Commit autoris√©"
  exit 0
fi

# Branche testing: validation l√©g√®re+ (lint + type-check + error handling)
if [ "$BRANCH" = "testing" ]; then
  echo "üß™ Branche TESTING: validation l√©g√®re+..."
  
  # 1. Lint rapide
  echo "üîç ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 1000 --quiet
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs lint - Commit bloqu√©"
    exit 1
  fi
  
  # 2. Type-check
  echo "üîç V√©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs TypeScript - Commit bloqu√©"
    exit 1
  fi
  
  # 3. Error Handling
  echo "üõ°Ô∏è V√©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations Error Handling - Commit bloqu√©"
    exit 1
  fi
  
  # 4. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "üíÖ Formatage du code..."
    npm run format
  fi
  
  echo "‚úÖ Pre-commit (testing) valid√© - Commit autoris√©"
  exit 0
fi

# Branche staging: validation interm√©diaire (lint + type-check + error handling + E2E critiques)
if [ "$BRANCH" = "staging" ]; then
  echo "üé≠ Branche STAGING: validation interm√©diaire..."
  
  # 1. Lint
  echo "üîç ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 500
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs lint - Commit bloqu√©"
    exit 1
  fi
  
  # 2. Type-check
  echo "üîç V√©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs TypeScript - Commit bloqu√©"
    exit 1
  fi
  
  # 3. Error Handling
  echo "üõ°Ô∏è V√©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations Error Handling - Commit bloqu√©"
    exit 1
  fi
  
  # 4. Tests E2E critiques
  echo "üåê Tests E2E critiques..."
  npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests E2E critiques √©chou√©s - Commit bloqu√©"
    exit 1
  fi
  
  # 5. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "üíÖ Formatage du code..."
    npm run format
  fi
  
  echo "‚úÖ Pre-commit (staging) valid√© - Commit autoris√©"
  exit 0
fi

# Branche pre-prod: validation compl√®te (comme main mais sans E2E smoke)
if [ "$BRANCH" = "pre-prod" ]; then
  echo "üöÄ Branche PRE-PROD: validation compl√®te..."
  
  # 1. Lint strict
  echo "üîç ESLint strict..."
  npx eslint . --report-unused-disable-directives --max-warnings 100
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs lint - Commit bloqu√©"
    exit 1
  fi
  
  # 2. Type-check
  echo "üîç V√©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs TypeScript - Commit bloqu√©"
    exit 1
  fi
  
  # 3. Tests unitaires rapides
  echo "üß™ Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests unitaires √©chou√©s - Commit bloqu√©"
    exit 1
  fi
  
  # 4. Error Handling
  echo "üõ°Ô∏è V√©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations Error Handling - Commit bloqu√©"
    exit 1
  fi
  
  # 5. Tests E2E critiques
  echo "üåê Tests E2E critiques..."
  npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests E2E critiques √©chou√©s - Commit bloqu√©"
    exit 1
  fi
  
  # 6. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "üíÖ Formatage du code..."
    npm run format
  fi
  
  echo "‚úÖ Pre-commit (pre-prod) valid√© - Commit autoris√©"
  exit 0
fi

# ggshield secret scan (fail-fast sur toutes les branches)
if [ "$GGSHIELD_RAN" != "1" ]; then
  if command -v ggshield >/dev/null 2>&1; then
    echo "üõ°Ô∏è ggshield: scan des secrets (pre-commit)..."
    ggshield secret scan pre-commit
    if [ $? -ne 0 ]; then
      echo "‚ùå Secrets d√©tect√©s - Commit bloqu√©"
      exit 1
    fi
  else
    echo "‚ÑπÔ∏è ggshield non install√© (skip)"
  fi
fi

# Mode rapide optionnel pour acc√©l√©rer les commits locaux
# Activez-le avec FAST_HOOKS=1 pour ignorer les v√©rifications lourdes
if [ "$FAST_HOOKS" = "1" ]; then
  echo "‚ö° Mode rapide activ√© (FAST_HOOKS=1) - tests lourds ignor√©s"
  echo "üß™ Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests unitaires √©chou√©s - Commit bloqu√©"
    exit 1
  fi

  echo "üíÖ Formatage du code..."
  npm run format

  echo "‚úÖ Pre-commit (rapide) valid√© - Commit autoris√©"
  exit 0
fi

# Validation conditionnelle selon la branche
# Branches non-main (feature branches, etc.): validation rapide
if [ "$BRANCH" != "main" ]; then
  echo "‚ö° Branche $BRANCH: validation rapide (lint + format + error handling)..."

  # 0. V√©rification serveur local ET erreurs JavaScript (optionnel, activ√© par d√©faut)
  # Skip automatiquement en CI (GitHub Actions, etc.)
  if [ "$CI" = "true" ] || [ "$GITHUB_ACTIONS" = "true" ]; then
    echo "‚è≠Ô∏è Environnement CI d√©tect√© - V√©rification serveur local ignor√©e"
  else
    if [ "$SKIP_LOCAL_SERVER_CHECK" = "1" ]; then
      echo "‚è≠Ô∏è V√©rification serveur local ignor√©e (SKIP_LOCAL_SERVER_CHECK=1)"
    else
      echo "üåê V√©rification serveur local et erreurs JavaScript..."
      if [ -f "scripts/verify-local-server-with-console-check.js" ]; then
        # Utiliser le script Node.js optimis√© qui v√©rifie aussi les erreurs console avec Playwright
        node scripts/verify-local-server-with-console-check.js
        if [ $? -ne 0 ]; then
          echo "‚ùå Erreurs JavaScript d√©tect√©es - Le site ne fonctionne pas correctement"
          echo "üí° Corrigez les erreurs avant de commiter"
          echo "üí° Pour ignorer cette v√©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          exit 1  # Bloquer le commit si erreurs JS d√©tect√©es
        fi
      elif [ -f "scripts/verify-local-server.sh" ]; then
        bash scripts/verify-local-server.sh
        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Serveur local non disponible - V√©rifiez avec: npm run dev"
          echo "üí° Pour ignorer cette v√©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          # Ne pas bloquer le commit, juste avertir
        fi
      elif [ -f "scripts/verify-local-server.ps1" ]; then
        # Sur Windows avec PowerShell
        pwsh -File scripts/verify-local-server.ps1
        if [ $? -ne 0 ]; then
          echo "‚ö†Ô∏è Serveur local non disponible - V√©rifiez avec: npm run dev"
          echo "üí° Pour ignorer cette v√©rification: SKIP_LOCAL_SERVER_CHECK=1 git commit"
          # Ne pas bloquer le commit, juste avertir
        fi
      else
        echo "‚ö†Ô∏è Script de v√©rification serveur local non trouv√©"
      fi
    fi
  fi

  # 1. Lint strict (0 warnings, pas de any)
  echo "üîç ESLint (Strict)..."
  npm run lint
  if [ $? -ne 0 ]; then
    echo "‚ùå Erreurs lint - Commit bloqu√©"
    exit 1
  fi

  # 2. Error Handling Enforcement (rapide ~5s)
  echo "üõ°Ô∏è V√©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations Error Handling d√©tect√©es - Commit bloqu√©"
    echo "üí° Utilisez ErrorFactory au lieu de 'throw new Error'"
    exit 1
  fi

  # 2b. V√©rification testabilit√© (data-testid, tests pour nouveau code)
  echo "üß™ V√©rification testabilit√©..."
  node scripts/verify-testability.cjs
  if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è Probl√®mes de testabilit√© d√©tect√©s (non bloquant pour le moment)"
  fi

  # 2c. Validation r√®gles E2E (bonnes pratiques)
  echo "üìã Validation r√®gles E2E..."
  node scripts/validation/validate-e2e-rules.cjs --staged
  if [ $? -ne 0 ]; then
    echo "‚ùå Violations des r√®gles E2E d√©tect√©es - Commit bloqu√©"
    echo "üí° Consultez Docs/TESTS/-Tests-Guide.md pour les bonnes pratiques"
    exit 1
  fi

  # 3. Tests E2E critiques (ultra-simple form + poll @critical)
  echo "üåê Tests E2E critiques (ultra-simple form + poll)..."
  npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests E2E critiques √©chou√©s - Commit bloqu√©"
    exit 1
  fi

  # 4. Formatage automatique
  if [ "$NO_FORMAT" != "1" ]; then
    echo "üíÖ Formatage du code..."
    npm run format
    # Auto-stage les fichiers format√©s pour √©viter les changements non commit√©s
    git add -u
  else
    echo "‚è≠Ô∏è Formatage ignor√© (NO_FORMAT=1)"
  fi

  echo "‚úÖ Pre-commit ($BRANCH) valid√© - Commit autoris√©"
  exit 0
fi

# Branche MAIN: validation compl√®te
echo "üîí Branche MAIN: validation compl√®te..."

# 0. Lint strict (Main branch)
echo "üîç ESLint (Strict)..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå Erreurs lint - Commit bloqu√©"
  exit 1
fi

# 1. Tests unitaires rapides (< 30s)
echo "üß™ Tests unitaires rapides..."
npm run test:unit:fast
if [ $? -ne 0 ]; then
  echo "‚ùå Tests unitaires √©chou√©s - Commit bloqu√©"
  exit 1
fi

# 2. Validation TypeScript
echo "üîç V√©rification TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå Erreurs TypeScript - Commit bloqu√©"
  exit 1
fi

# 3. Tests UX R√©gression (critique)
echo "üé® Tests UX R√©gression..."
npm run test:ux-regression
if [ $? -ne 0 ]; then
  echo "‚ùå R√©gression UX d√©tect√©e - Commit bloqu√©"
  exit 1
fi

# 4. Tests d'int√©gration
echo "üîó Tests d'int√©gration..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "‚ùå Tests d'int√©gration √©chou√©s - Commit bloqu√©"
  exit 1
fi

# 5. Error Handling Enforcement (CRITIQUE)
echo "üõ°Ô∏è V√©rification Error Handling..."
npm run test:error-handling
if [ $? -ne 0 ]; then
  echo "‚ùå Violations Error Handling d√©tect√©es - Commit bloqu√©"
  echo "üí° Utilisez ErrorFactory au lieu de 'throw new Error'"
  exit 1
fi

# 5b. Validation r√®gles E2E (bonnes pratiques)
echo "üìã Validation r√®gles E2E..."
node scripts/validation/validate-e2e-rules.cjs --staged
if [ $? -ne 0 ]; then
  echo "‚ùå Violations des r√®gles E2E d√©tect√©es - Commit bloqu√©"
  echo "üí° Consultez Docs/TESTS/-Tests-Guide.md pour les bonnes pratiques"
  exit 1
fi

# 6. Formatage automatique (optionnel)
# D√©sactivez avec NO_FORMAT=1 pour √©viter les changements automatiques
if [ "$NO_FORMAT" != "1" ]; then
  echo "üíÖ Formatage du code..."
  npm run format
else
  echo "‚è≠Ô∏è Formatage ignor√© (NO_FORMAT=1)"
fi

echo "‚úÖ Pre-commit valid√© - Commit autoris√©"
