#!/bin/sh
echo "ğŸ” DooDates - Validation pre-commit..."

# DÃ©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# Skip tous les tests pour les branches de test (test, test-*)
if echo "$BRANCH" | grep -qE "^test"; then
  echo "âš¡ Branche TEST ($BRANCH): skip validation complÃ¨te (tests gÃ©rÃ©s par CI)"
  echo "âœ… Pre-commit (test branch) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche bug: validation ultra-lÃ©gÃ¨re (lint + format seulement)
if [ "$BRANCH" = "bug" ]; then
  echo "ğŸ› Branche BUG: validation ultra-lÃ©gÃ¨re..."
  
  # 1. Lint rapide (quiet = pas de warnings)
  echo "ğŸ” ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 1000 --quiet
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ’… Formatage du code..."
    npm run format
  fi
  
  echo "âœ… Pre-commit (bug) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche testing: validation lÃ©gÃ¨re+ (lint + type-check + error handling)
if [ "$BRANCH" = "testing" ]; then
  echo "ğŸ§ª Branche TESTING: validation lÃ©gÃ¨re+..."
  
  # 1. Lint rapide
  echo "ğŸ” ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 1000 --quiet
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Type-check
  echo "ğŸ” VÃ©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
    exit 1
  fi
  
  # 3. Error Handling
  echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "âŒ Violations Error Handling - Commit bloquÃ©"
    exit 1
  fi
  
  # 4. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ’… Formatage du code..."
    npm run format
  fi
  
  echo "âœ… Pre-commit (testing) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche staging: validation intermÃ©diaire (lint + type-check + error handling + E2E critiques)
if [ "$BRANCH" = "staging" ]; then
  echo "ğŸ­ Branche STAGING: validation intermÃ©diaire..."
  
  # 1. Lint
  echo "ğŸ” ESLint..."
  npx eslint . --report-unused-disable-directives --max-warnings 500
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Type-check
  echo "ğŸ” VÃ©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
    exit 1
  fi
  
  # 3. Error Handling
  echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "âŒ Violations Error Handling - Commit bloquÃ©"
    exit 1
  fi
  
  # 4. Tests E2E critiques
  echo "ğŸŒ Tests E2E critiques..."
  npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E critiques Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi
  
  # 5. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ’… Formatage du code..."
    npm run format
  fi
  
  echo "âœ… Pre-commit (staging) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche pre-prod: validation complÃ¨te (comme main mais sans E2E smoke)
if [ "$BRANCH" = "pre-prod" ]; then
  echo "ğŸš€ Branche PRE-PROD: validation complÃ¨te..."
  
  # 1. Lint strict
  echo "ğŸ” ESLint strict..."
  npx eslint . --report-unused-disable-directives --max-warnings 100
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs lint - Commit bloquÃ©"
    exit 1
  fi
  
  # 2. Type-check
  echo "ğŸ” VÃ©rification TypeScript..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
    exit 1
  fi
  
  # 3. Tests unitaires rapides
  echo "ğŸ§ª Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi
  
  # 4. Error Handling
  echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
  npm run test:error-handling
  if [ $? -ne 0 ]; then
    echo "âŒ Violations Error Handling - Commit bloquÃ©"
    exit 1
  fi
  
  # 5. Tests E2E critiques
  echo "ğŸŒ Tests E2E critiques..."
  npx playwright test tests/e2e/ultra-simple-form.spec.ts tests/e2e/ultra-simple-poll.spec.ts --project=chromium --grep "@critical"
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E critiques Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi
  
  # 6. Formatage
  if [ "$NO_FORMAT" != "1" ]; then
    echo "ğŸ’… Formatage du code..."
    npm run format
  fi
  
  echo "âœ… Pre-commit (pre-prod) validÃ© - Commit autorisÃ©"
  exit 0
fi

# ggshield secret scan (fail-fast sur toutes les branches)
if command -v ggshield >/dev/null 2>&1; then
  echo "ğŸ›¡ï¸ ggshield: scan des secrets (pre-commit)..."
  ggshield secret scan pre-commit
  if [ $? -ne 0 ]; then
    echo "âŒ Secrets dÃ©tectÃ©s - Commit bloquÃ©"
    exit 1
  fi
else
  echo "â„¹ï¸ ggshield non installÃ© (skip)"
fi

# Mode rapide optionnel pour accÃ©lÃ©rer les commits locaux
# Activez-le avec FAST_HOOKS=1 pour ignorer les vÃ©rifications lourdes
if [ "$FAST_HOOKS" = "1" ]; then
  echo "âš¡ Mode rapide activÃ© (FAST_HOOKS=1) - tests lourds ignorÃ©s"
  echo "ğŸ§ª Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Commit bloquÃ©"
    exit 1
  fi

  echo "ğŸ’… Formatage du code..."
  npm run format

  echo "âœ… Pre-commit (rapide) validÃ© - Commit autorisÃ©"
  exit 0
fi

# Branche main: validation complÃ¨te (fallback pour toutes les autres branches non gÃ©rÃ©es)
# Les 5 branches officielles (bug, testing, staging, pre-prod, main) sont gÃ©rÃ©es ci-dessus
echo "ğŸ”’ Branche MAIN (ou autre): validation complÃ¨te..."

# 1. Tests unitaires rapides (< 30s)
echo "ğŸ§ª Tests unitaires rapides..."
npm run test:unit:fast
if [ $? -ne 0 ]; then
  echo "âŒ Tests unitaires Ã©chouÃ©s - Commit bloquÃ©"
  exit 1
fi

# 2. Validation TypeScript
echo "ğŸ” VÃ©rification TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Erreurs TypeScript - Commit bloquÃ©"
  exit 1
fi

# 3. Tests UX RÃ©gression (critique)
echo "ğŸ¨ Tests UX RÃ©gression..."
npm run test:ux-regression
if [ $? -ne 0 ]; then
  echo "âŒ RÃ©gression UX dÃ©tectÃ©e - Commit bloquÃ©"
  exit 1
fi

# 4. Tests d'intÃ©gration
echo "ğŸ”— Tests d'intÃ©gration..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Commit bloquÃ©"
  exit 1
fi

# 5. Error Handling Enforcement (CRITIQUE)
echo "ğŸ›¡ï¸ VÃ©rification Error Handling..."
npm run test:error-handling
if [ $? -ne 0 ]; then
  echo "âŒ Violations Error Handling dÃ©tectÃ©es - Commit bloquÃ©"
  echo "ğŸ’¡ Utilisez ErrorFactory au lieu de 'throw new Error'"
  exit 1
fi

# 5b. Validation rÃ¨gles E2E (bonnes pratiques)
echo "ğŸ“‹ Validation rÃ¨gles E2E..."
node scripts/validation/validate-e2e-rules.cjs --staged
if [ $? -ne 0 ]; then
  echo "âŒ Violations des rÃ¨gles E2E dÃ©tectÃ©es - Commit bloquÃ©"
  echo "ğŸ’¡ Consultez Docs/TESTS/-Tests-Guide.md pour les bonnes pratiques"
  exit 1
fi

# 6. Formatage automatique (optionnel)
# DÃ©sactivez avec NO_FORMAT=1 pour Ã©viter les changements automatiques
if [ "$NO_FORMAT" != "1" ]; then
  echo "ğŸ’… Formatage du code..."
  npm run format
else
  echo "â­ï¸ Formatage ignorÃ© (NO_FORMAT=1)"
fi

echo "âœ… Pre-commit validÃ© - Commit autorisÃ©"
