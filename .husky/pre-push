#!/bin/sh
echo "ğŸš€ DooDates - Validation pre-push..."

# DÃ©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# Skip tous les tests pour les branches de test (test, test-*)
if echo "$BRANCH" | grep -qE "^test"; then
  echo "âš¡ Branche TEST ($BRANCH): skip validation complÃ¨te (tests gÃ©rÃ©s par CI)"
  echo "âœ… Pre-push (test branch) validÃ© - Push autorisÃ©"
  exit 0
fi

# Branche bug: validation lÃ©gÃ¨re (build seulement)
if [ "$BRANCH" = "bug" ]; then
  echo "ğŸ› Branche BUG: validation lÃ©gÃ¨re (CI fera les tests complets)..."
  
  # Build seulement
  echo "ğŸ—ï¸ Build production..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
    exit 1
  fi
  
  echo "âœ… Pre-push (bug) validÃ© - Push autorisÃ©"
  exit 0
fi

# Branche testing: validation lÃ©gÃ¨re+ (build + tests unitaires rapides)
if [ "$BRANCH" = "testing" ]; then
  echo "ğŸ§ª Branche TESTING: validation lÃ©gÃ¨re+..."
  
  # 1. Build production
  echo "ğŸ—ï¸ Build production..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
    exit 1
  fi
  
  # 2. Tests unitaires rapides
  echo "ğŸ§ª Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  echo "âœ… Pre-push (testing) validÃ© - Push autorisÃ©"
  exit 0
fi

# Branche staging: validation intermÃ©diaire (build + tests unitaires + intÃ©gration)
if [ "$BRANCH" = "staging" ]; then
  echo "ğŸ­ Branche STAGING: validation intermÃ©diaire..."
  
  # 1. Build production
  echo "ğŸ—ï¸ Build production..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
    exit 1
  fi
  
  # 2. Tests unitaires rapides
  echo "ğŸ§ª Tests unitaires rapides..."
  npm run test:unit:fast
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  # 3. Tests d'intÃ©gration
  echo "ğŸ”— Tests d'intÃ©gration..."
  npm run test:integration
  if [ $? -ne 0 ]; then
    echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  echo "âœ… Pre-push (staging) validÃ© - Push autorisÃ©"
  exit 0
fi

# Branche pre-prod: validation complÃ¨te (build + tests unitaires + intÃ©gration + E2E smoke)
if [ "$BRANCH" = "pre-prod" ]; then
  echo "ğŸš€ Branche PRE-PROD: validation complÃ¨te..."
  
  # Ressources accrues
  export NODE_OPTIONS="--max-old-space-size=4096"
  
  # 1. Build production
  echo "ğŸ—ï¸ Build production..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
    exit 1
  fi
  
  # 2. Tests unitaires complets
  echo "ğŸ§ª Tests unitaires complets..."
  npm run test:unit
  if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaires Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  # 3. Tests d'intÃ©gration
  echo "ğŸ”— Tests d'intÃ©gration..."
  npm run test:integration
  if [ $? -ne 0 ]; then
    echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  # 4. Tests E2E Smoke
  echo "ğŸ”¥ Tests E2E Smoke..."
  npm run test:e2e:smoke
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E Smoke Ã©chouÃ©s - Push bloquÃ©"
    exit 1
  fi
  
  echo "âœ… Pre-push (pre-prod) validÃ© - Push autorisÃ©"
  exit 0
fi

# Ressources accrues pour Ã©viter OOM et fiabiliser Vitest
export NODE_OPTIONS="--max-old-space-size=4096"
export VITEST_MAX_THREADS=1
export VITEST_POOL=forks

# 1. Suite complÃ¨te de tests unitaires
echo "ğŸ§ª Tests unitaires complets..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Tests unitaires complets Ã©chouÃ©s - Push bloquÃ©"
  exit 1
fi

# 2. Tests d'intÃ©gration
echo "ğŸ”— Tests d'intÃ©gration..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Push bloquÃ©"
  exit 1
fi

# 3. Build de production
echo "ğŸ—ï¸ Build production..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
  exit 1
fi

# 4. Tests E2E Smoke (uniquement si push vers main)
if [ "$PUSHING_TO_MAIN" = "true" ]; then
  echo "ğŸ”¥ Tests E2E Smoke (protection branche main)..."
  npm run test:e2e:smoke
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E Smoke Ã©chouÃ©s - Push vers main bloquÃ©"
    echo "ğŸ’¡ Les tests critiques doivent passer avant de pusher vers main"
    exit 1
  fi
  echo "âœ… Tests E2E Smoke passÃ©s"
fi

echo "âœ… Pre-push validÃ© - Push autorisÃ©"
exit 0
