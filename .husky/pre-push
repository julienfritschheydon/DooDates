#!/bin/sh
echo "ğŸš€ DooDates - Validation pre-push..."

# DÃ©tection branche courante
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")

# Skip tous les tests pour les branches de test (test, test-*)
if echo "$BRANCH" | grep -qE "^test"; then
  echo "âš¡ Branche TEST ($BRANCH): skip validation complÃ¨te (tests gÃ©rÃ©s par CI)"
  echo "âœ… Pre-push (test branch) validÃ© - Push autorisÃ©"
  exit 0
fi

# RÃ©cupÃ©rer la branche cible du push
while read local_ref local_sha remote_ref remote_sha
do
  if [ "$remote_ref" = "refs/heads/main" ]; then
    PUSHING_TO_MAIN=true
  fi
done

# Si push vers develop â†’ validation lÃ©gÃ¨re (CI fera le reste)
if [ "$BRANCH" = "develop" ]; then
  echo "âš¡ Push vers DEVELOP: validation lÃ©gÃ¨re (CI complÃ¨te sur GitHub)..."
  echo "âœ… Pre-push (develop) validÃ© - Push autorisÃ©"
  exit 0
fi

# Ressources accrues pour Ã©viter OOM et fiabiliser Vitest
export NODE_OPTIONS="--max-old-space-size=4096"
export VITEST_MAX_THREADS=1
export VITEST_POOL=forks

# 1. Suite complÃ¨te de tests unitaires
echo "ğŸ§ª Tests unitaires complets..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Tests unitaires complets Ã©chouÃ©s - Push bloquÃ©"
  exit 1
fi

# 2. Tests d'intÃ©gration
echo "ğŸ”— Tests d'intÃ©gration..."
npm run test:integration
if [ $? -ne 0 ]; then
  echo "âŒ Tests d'intÃ©gration Ã©chouÃ©s - Push bloquÃ©"
  exit 1
fi

# 3. Build de production
echo "ğŸ—ï¸ Build production..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build production Ã©chouÃ© - Push bloquÃ©"
  exit 1
fi

# 4. Tests E2E Smoke (uniquement si push vers main)
if [ "$PUSHING_TO_MAIN" = "true" ]; then
  echo "ğŸ”¥ Tests E2E Smoke (protection branche main)..."
  npm run test:e2e:smoke
  if [ $? -ne 0 ]; then
    echo "âŒ Tests E2E Smoke Ã©chouÃ©s - Push vers main bloquÃ©"
    echo "ğŸ’¡ Les tests critiques doivent passer avant de pusher vers main"
    exit 1
  fi
  echo "âœ… Tests E2E Smoke passÃ©s"
fi

echo "âœ… Pre-push validÃ© - Push autorisÃ©"
