name: Notify Nightly E2E Failures

on:
  workflow_run:
    workflows: ["ðŸŒ™ Nightly E2E Matrix"]
    types: [completed]

jobs:
  email-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare email payload
        id: prep
        env:
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          NAME: ${{ github.event.workflow_run.name }}
          STATUS: ${{ github.event.workflow_run.conclusion }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          echo "RUN_URL=$RUN_URL" >> $GITHUB_OUTPUT
          echo "SUBJECT=ðŸš¨ Nightly E2E failed: $NAME" >> $GITHUB_OUTPUT
          cat > payload.json << 'EOF'
          {
            "from": "DooDates CI <noreply@doodates.app>",
            "to": ["${{ secrets.ALERT_EMAIL_TO }}"],
            "subject": "${{ steps.prep.outputs.SUBJECT }}",
            "html": "<h2>Nightly E2E Failure</h2><p>Workflow: $NAME</p><p>Status: <b>$STATUS</b></p><p>Branch: $BRANCH</p><p>Commit: $COMMIT_SHA</p><p><a href='$RUN_URL'>View run</a></p>"
          }
          EOF
      - name: Send email via Resend
        if: ${{ secrets.RESEND_API_KEY && secrets.ALERT_EMAIL_TO }}
        run: |
          curl -sS -X POST https://api.resend.com/emails \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
      - name: Skip notice (missing secrets)
        if: ${{ !secrets.RESEND_API_KEY || !secrets.ALERT_EMAIL_TO }}
        run: |
          echo "Missing RESEND_API_KEY or ALERT_EMAIL_TO secrets. Configure repository secrets to enable email alerts."
