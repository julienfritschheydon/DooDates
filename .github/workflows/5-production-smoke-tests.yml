name: 5Ô∏è‚É£ Production Smoke Tests

# üî• CE WORKFLOW EST CRITIQUE - Il d√©tecte si l'application d√©ploy√©e est cass√©e
# 
# D√©clench√© APR√àS le d√©ploiement sur GitHub Pages
# Teste la VRAIE application en production, PAS DE MOCKS
#
# Si ces tests √©chouent:
# - L'application est cass√©e en production
# - Une issue critique est cr√©√©e automatiquement
# - Une alerte est envoy√©e

on:
  # D√©clench√© apr√®s le d√©ploiement GitHub Pages
  workflow_run:
    workflows: ["4Ô∏è‚É£ Main Deploy to GitHub Pages"]
    types: [completed]
  
  # Permet de lancer manuellement pour tester
  workflow_dispatch:
    inputs:
      production_url:
        description: 'URL de production √† tester (laisser vide pour utiliser GitHub Pages)'
        required: false
        type: string

# Permissions n√©cessaires pour cr√©er des issues
permissions:
  contents: read
  issues: write

jobs:
  smoke-tests-production:
    name: üî• Tests de Smoke en Production
    runs-on: ubuntu-latest
    
    # N'ex√©cuter que si le d√©ploiement a r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install
          # Ensure Rollup native dependencies are properly installed (known npm bug)
          npm install @rollup/rollup-linux-x64-gnu || true

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright (Chromium only - suffisant pour smoke tests)
        run: |
          echo "üì¶ Installation de chromium avec d√©pendances syst√®me..."
          npx playwright install --with-deps chromium

      - name: ‚è∞ Attendre que le d√©ploiement soit effectif
        run: |
          echo "‚è≥ Attente de 30 secondes pour que GitHub Pages propage le d√©ploiement..."
          sleep 30

      - name: üîç D√©terminer l'URL de production
        id: production-url
        run: |
          if [ -n "${{ github.event.inputs.production_url }}" ]; then
            PROD_URL="${{ github.event.inputs.production_url }}"
          else
            # Extraire le nom du repo depuis github.repository (format: owner/repo)
            REPO_NAME="${{ github.repository }}"
            REPO_NAME="${REPO_NAME#*/}"  # Retire "owner/" pour ne garder que "repo"
            
            # URL GitHub Pages par d√©faut
            PROD_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          fi
          echo "url=${PROD_URL}" >> $GITHUB_OUTPUT
          echo "üåê URL de production: ${PROD_URL}"

      - name: üî• Run Production Smoke Tests
        id: smoke-tests
        run: |
          echo "üî• Ex√©cution des tests de smoke contre la production..."
          echo "üåê URL: ${{ steps.production-url.outputs.url }}"
          npx playwright test tests/e2e/production-smoke.spec.ts \
            --project=chromium \
            --reporter=html,json \
            --retries=2
        env:
          # Mode production - pas de mocks
          NODE_ENV: production
          CI: true
          BASE_URL: ${{ steps.production-url.outputs.url }}
        continue-on-error: true

      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-production-smoke
          path: playwright-report
          retention-days: 30  # Garder plus longtemps pour les tests de production

      - name: üì§ Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-production-smoke
          path: |
            test-results
            test-results.json
          retention-days: 30

      - name: üì∏ Upload screenshots (si √©chec)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: production-smoke-screenshots
          path: test-results/**/*.png
          if-no-files-found: ignore
          retention-days: 30

      # üö® CRITIQUE: Cr√©er une issue si les tests √©chouent
      - name: üö® Create Critical Issue on Failure
        if: steps.smoke-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lire les r√©sultats des tests si disponibles
            let failedTests = [];
            let testDetails = '';
            
            try {
              const resultsPath = path.join(process.cwd(), 'test-results');
              if (fs.existsSync(resultsPath)) {
                testDetails = '\n\n## üìã D√©tails des Tests\n\n';
                testDetails += 'Les rapports d√©taill√©s sont disponibles dans les artefacts.\n';
              }
            } catch (error) {
              console.log('Could not read test results:', error);
            }
            
            const prodUrl = '${{ steps.production-url.outputs.url }}';
            const workflowUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            const commitSha = context.sha.substring(0, 7);
            
            const issueBody = [
              '## üö® ALERTE CRITIQUE: APPLICATION EN PRODUCTION NON FONCTIONNELLE',
              '',
              '### ‚ùå Probl√®me D√©tect√©',
              'Les tests de smoke en production ont √©chou√©. L\'application d√©ploy√©e ne fonctionne pas correctement.',
              '',
              '### üìä Informations',
              `- URL test√©e: ${prodUrl}`,
              `- Commit: \`${commitSha}\``,
              `- D√©ploy√© par: ${context.actor}`,
              `- Date: ${new Date().toISOString()}`,
              `- Workflow: [Voir les logs](${workflowUrl})`,
              '',
              '### üîç Tests √âchou√©s',
              'Les tests de smoke ont √©chou√©. Voir les artefacts pour les d√©tails complets.',
              testDetails,
              '',
              '### üì∏ Captures d\'√©cran',
              'Les captures d\'√©cran des √©checs sont disponibles dans les artefacts du workflow.',
              '',
              '### ‚ö° Actions Requises IMM√âDIATEMENT',
              '',
              `1. V√©rifier l'application en production - [Ouvrir l'app](${prodUrl})`,
              `2. Consulter les logs - [Workflow logs](${workflowUrl})`,
              '3. T√©l√©charger les rapports - Voir les artefacts du workflow',
              '4. Consid√©rer un rollback si le probl√®me est critique',
              '',
              '### üîß Actions Possibles',
              '',
              '#### Option 1: Rollback (Recommand√© si critique)',
              '```bash',
              '# Revenir au commit pr√©c√©dent',
              `git revert ${context.sha}`,
              'git push origin main',
              '```',
              '',
              '#### Option 2: Hotfix',
              '1. Identifier le probl√®me dans les logs',
              '2. Cr√©er une branche hotfix/production-smoke-fix',
              '3. Fix et tester localement avec npm run build && npm run preview',
              '4. D√©ployer le fix',
              '',
              '### üìä M√©triques de Sant√©',
              '- Tests de smoke: √âCHEC',
              '- Production: POTENTIELLEMENT CASS√âE',
              '- Priorit√©: CRITIQUE',
              '',
              '### üìã Checklist de R√©solution',
              '- [ ] Probl√®me identifi√©',
              '- [ ] Solution impl√©ment√©e',
              '- [ ] Tests passent localement',
              '- [ ] D√©ploy√© et v√©rifi√© en production',
              '- [ ] Tests de smoke passent',
              '- [ ] Issue ferm√©e',
              '',
              '---',
              '',
              'AVERTISSEMENT: Cette issue a √©t√© cr√©√©e automatiquement par le syst√®me de monitoring de production.',
              'Ne pas fermer tant que les tests de smoke ne passent pas en production.'
            ].join('\n');

            // Cr√©er l'issue critique
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® PRODUCTION CASS√âE - Tests de Smoke √âchou√©s',
              body: issueBody,
              labels: ['critical', 'production', 'bug', 'incident', 'automated', 'urgent', 'smoke-tests'],
              assignees: [context.actor]
            });
            
            console.log(`üö® Issue critique cr√©√©e: #${issue.data.number}`);
            
            // Ajouter un commentaire avec le lien vers les artefacts
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `üì¶ Artefacts disponibles:\n\n` +
                    `- [Rapport Playwright HTML](${context.payload.repository.html_url}/actions/runs/${context.runId})\n` +
                    `- [R√©sultats JSON](${context.payload.repository.html_url}/actions/runs/${context.runId})\n` +
                    `- [Screenshots](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n` +
                    `Ces artefacts sont conserv√©s pendant 30 jours.`
            });

      # ‚úÖ Succ√®s: Confirmer que la production fonctionne
      - name: ‚úÖ Confirmer le succ√®s du d√©ploiement
        if: steps.smoke-tests.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('‚úÖ Tests de smoke r√©ussis!');
            console.log('üöÄ L\'application en production fonctionne correctement.');
            console.log('üåê URL: ${{ steps.production-url.outputs.url }}');

      # ‚ùå √âchec: Marquer le workflow comme √©chou√©
      - name: ‚ùå Marquer comme √©chou√© si les tests ont √©chou√©
        if: steps.smoke-tests.outcome == 'failure'
        run: |
          echo "‚ùå Les tests de smoke en production ont √©chou√©!"
          echo "üö® Une issue critique a √©t√© cr√©√©e."
          echo "‚ö†Ô∏è L'application en production est potentiellement cass√©e."
          exit 1

# ========================================
# üìã NOTES SUR CE WORKFLOW
# ========================================
#
# Ce workflow est la derni√®re ligne de d√©fense contre les d√©ploiements cass√©s.
#
# Il teste:
# - Que la page se charge
# - Que les assets sont pr√©sents
# - Qu'il n'y a pas d'erreurs JS critiques
# - Que la configuration Supabase fonctionne
# - Que le routing SPA fonctionne
# - Que les fonctionnalit√©s de base sont accessibles
#
# Si ces tests √©chouent:
# - Une issue critique est cr√©√©e automatiquement
# - L'√©quipe est alert√©e
# - Un rollback doit √™tre envisag√©
#
# Temps d'ex√©cution: ~2-3 minutes
# Critique: OUI - Ne pas d√©sactiver
# Retries: 2 (pour √©viter les faux positifs dus au r√©seau)

