on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [test/workflows-validation]

jobs:
  # Job 1: Tests Rapides (Parall√®le)
  quick-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, ux-regression]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}
      
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: test-results/
      
      - name: Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # Job 2: Tests IA (Critique)
  ai-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run AI Tests (Quick)
        run: npm run test:gemini:quick
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
      
      - name: Validate AI Performance
        run: |
          if [ ! -f ./tests/reports/quick-report.json ]; then
            echo "Aucun rapport AI d√©tect√© (tests IA ignor√©s). Validation AI saut√©e."
            exit 0
          fi
          SCORE=$(node -e "
            const fs = require('fs');
            const report = require('./tests/reports/quick-report.json');
            console.log(report.percentage || 0);
          ")
          echo "Score IA: $SCORE%"
          if (( $(echo "$SCORE < 70" | bc -l) )); then
            echo "Performance IA insuffisante: $SCORE%"
            exit 1
          fi
          echo "Performance IA valid√©e: $SCORE%"
      
      - name: Upload AI test results
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-results
          path: tests/reports/

  # Job 3: Build & Type Check
  build-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript Check
        run: npm run type-check
      
      - name: Build production
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/

  # Job 4: Code Quality
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint check
        run: npm run lint || echo "Lint errors ignored for test branch"
        continue-on-error: true
      
      - name: Format check
        run: npm run format:check || echo "Format errors ignored for test branch"
        continue-on-error: true
      
      - name: Security audit
        run: npm audit --audit-level moderate

  # Job 5: E2E Smoke (Chromium only - Tests critiques rapides)
  e2e-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: üî• Run Smoke Tests (Critical paths only)
        run: npm run test:e2e:smoke

      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke
          path: playwright-report
          retention-days: 7

  # Job 5b: E2E Functional (Chromium only - Tests fonctionnels complets)
  e2e-functional:
    runs-on: ubuntu-latest
    needs: [e2e-smoke]  # Ex√©cuter apr√®s smoke tests
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ‚ö° Run Functional Tests (Complete user flows)
        run: npm run test:e2e:functional

      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-functional
          path: playwright-report
          retention-days: 7

  # Job 5c: E2E Matrix (Desktop + Mobile - Tests multi-navigateurs)
  e2e-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: [
          'chromium',
          'firefox',
          'webkit',
          'Mobile Chrome',
          'Mobile Safari'
        ]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: üß™ Run Playwright E2E (${{ matrix.project }})
        run: |
          npx playwright test --project="${{ matrix.project }}" --reporter=html --ignore-snapshots --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow"

      - name: üìä Upload Playwright report (${{ matrix.project }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.project }}
          path: playwright-report
          retention-days: 7

  # Job 6: Summary
  validation-summary:
    needs: [quick-tests, ai-validation, build-validation, code-quality, e2e-smoke, e2e-functional, e2e-matrix]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: üìä Validation Summary
        uses: actions/github-script@v6
        with:
          script: |
            const jobs = [
              { name: 'Tests Rapides', status: '${{ needs.quick-tests.result }}' },
              { name: 'Validation IA', status: '${{ needs.ai-validation.result }}' },
              { name: 'Build & Types', status: '${{ needs.build-validation.result }}' },
              { name: 'Code Quality', status: '${{ needs.code-quality.result }}' },
              { name: 'E2E Smoke (Critical)', status: '${{ needs.e2e-smoke.result }}' },
              { name: 'E2E Functional (Complete)', status: '${{ needs.e2e-functional.result }}' },
              { name: 'E2E Matrix (All Browsers)', status: '${{ needs.e2e-matrix.result }}' }
            ];
            
            const passed = jobs.filter(j => j.status === 'success').length;
            const total = jobs.length;
            const status = passed === total ? '‚úÖ' : '‚ùå';
            
            const summary = `## ${status} Validation PR - ${passed}/${total} jobs r√©ussis
            
            ${jobs.map(j => `- ${j.status === 'success' ? '‚úÖ' : '‚ùå'} ${j.name}`).join('\n')}
            
            ${passed === total ? 
              'üöÄ **Toutes les validations sont pass√©es ! Cette PR peut √™tre merg√©e.**' : 
              '‚ö†Ô∏è **Des validations ont √©chou√©. Veuillez corriger avant de merger.**'
            }`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            }); 