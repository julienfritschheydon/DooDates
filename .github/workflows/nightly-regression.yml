name: Nightly Regression Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours Ã  2h du matin (UTC)
  workflow_dispatch:  # Permet exÃ©cution manuelle

jobs:
  full-regression:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ['chromium', 'firefox', 'webkit', 'Mobile Chrome', 'Mobile Safari']
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ§­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ğŸ” Run Full Regression Suite (${{ matrix.project }})
        run: npx playwright test --project="${{ matrix.project }}" --reporter=html

      - name: ğŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nightly-${{ matrix.project }}
          path: playwright-report
          retention-days: 30

  regression-summary:
    needs: [full-regression]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ needs.full-regression.result }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            const message = status === 'success' 
              ? 'Tous les tests de rÃ©gression sont passÃ©s !' 
              : 'âš ï¸ Des tests de rÃ©gression ont Ã©chouÃ©. VÃ©rifiez les rapports.';
            
            console.log(`${emoji} ${message}`);
            
            // CrÃ©er une issue si Ã©chec
            if (status !== 'success') {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ Nightly Regression Tests Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `## Tests de RÃ©gression Ã‰chouÃ©s
                
Les tests de rÃ©gression nocturnes ont Ã©chouÃ©.

**Date:** ${new Date().toISOString()}
**Workflow:** [Voir les dÃ©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Actions Ã  prendre:
1. Consulter les rapports Playwright dans les artifacts
2. Identifier les tests qui Ã©chouent
3. Corriger les rÃ©gressions identifiÃ©es
4. Re-exÃ©cuter les tests manuellement

### Rapports disponibles:
- Chromium
- Firefox
- WebKit
- Mobile Chrome
- Mobile Safari

Cette issue sera automatiquement fermÃ©e lors du prochain succÃ¨s.`,
                labels: ['bug', 'regression', 'automated']
              });
            }
