name: Nightly Regression Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours √† 2h du matin (UTC)
  workflow_dispatch:  # Permet ex√©cution manuelle

jobs:
  full-regression:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ['chromium', 'firefox', 'webkit', 'Mobile Chrome', 'Mobile Safari']
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: üîç Run Full Regression Suite (${{ matrix.project }})
        run: npx playwright test --project="${{ matrix.project }}" --reporter=html

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nightly-${{ matrix.project }}
          path: playwright-report
          retention-days: 30

  regression-summary:
    needs: [full-regression]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üìä Generate Summary
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ needs.full-regression.result }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success' 
              ? 'Tous les tests de r√©gression sont pass√©s !' 
              : '‚ö†Ô∏è Des tests de r√©gression ont √©chou√©. V√©rifiez les rapports.';
            
            console.log(`${emoji} ${message}`);
            
            // Cr√©er une issue si √©chec
            if (status !== 'success') {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Nightly Regression Tests Failed - ' + new Date().toISOString().split('T')[0],
                body: `## Tests de R√©gression √âchou√©s

Les tests de r√©gression nocturnes ont √©chou√©.

Date: ${new Date().toISOString()}
Workflow: [Voir les d√©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Actions √† prendre:
- Consulter les rapports Playwright dans les artifacts
- Identifier les tests qui √©chouent
- Corriger les r√©gressions identifi√©es
- Re-ex√©cuter les tests manuellement

### Rapports disponibles:
- Chromium
- Firefox
- WebKit
- Mobile Chrome
- Mobile Safari

Cette issue sera automatiquement ferm√©e lors du prochain succ√®s.`,
                labels: ['bug', 'regression', 'automated']
              });
            }
