name: Post-Merge Validation

on:
  push:
    branches: [main]

jobs:
  quick-validation:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: üî• Run Smoke Tests (Post-merge safety check)
        run: npm run test:e2e:smoke

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge
          path: playwright-report
          retention-days: 7

      - name: Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Post-Merge Smoke Tests Failed on Main Branch',
              body: `## Tests Critiques √âchou√©s Apr√®s Merge

URGENT: Les tests smoke ont √©chou√© sur la branche main apr√®s un merge.

Commit: ${context.sha}
Auteur: ${context.payload.pusher.name}
Workflow: [Voir les d√©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Actions imm√©diates requises:
- NE PAS merger d'autres PRs jusqu'√† r√©solution
- Consulter le rapport Playwright dans les artifacts
- Identifier la cause de l'√©chec
- Corriger en priorit√© ou revert le commit probl√©matique

### Commit concern√©:
${context.payload.head_commit.message}

Cette situation indique que les tests PR n'ont pas d√©tect√© un probl√®me critique.
Il faut investiguer pourquoi les tests PR ont pass√© mais les tests post-merge √©chouent.`,
              labels: ['critical', 'bug', 'main-branch', 'automated'],
              assignees: ['${context.payload.pusher.name}']
            });

  functional-validation:
    runs-on: ubuntu-latest
    needs: [quick-validation]
    if: success()
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ‚ö° Run Functional Tests (Extended validation)
        run: npm run test:e2e:functional

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge-functional
          path: playwright-report
          retention-days: 7

      - name: Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Post-Merge Functional Tests Failed on Main Branch',
              body: `## Tests Fonctionnels √âchou√©s Apr√®s Merge
              
Les tests fonctionnels ont √©chou√© sur la branche main apr√®s un merge.

**Commit:** ${context.sha}
**Auteur:** ${context.payload.pusher.name}
**Workflow:** [Voir les d√©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Note:
Les tests smoke ont pass√©, mais les tests fonctionnels ont √©chou√©.
Cela indique un probl√®me dans un parcours utilisateur complet.

### Actions requises:
1. Consulter le rapport Playwright dans les artifacts
2. Identifier le parcours utilisateur qui √©choue
3. Corriger ou revert si critique

### Commit concern√©:
\`\`\`
${context.payload.head_commit.message}
\`\`\``,
              labels: ['bug', 'main-branch', 'automated'],
              assignees: ['${context.payload.pusher.name}']
            });
