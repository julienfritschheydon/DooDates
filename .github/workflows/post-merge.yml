name: Post-Merge Validation

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write

jobs:
  quick-validation:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸ§­ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ðŸ”¥ Run Smoke Tests (Post-merge safety check)
        run: npm run test:e2e:smoke

      - name: ðŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge
          path: playwright-report
          retention-days: 7

      - name: Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Post-Merge Smoke Tests Failed',
              body: 'Tests smoke echoues sur main. Commit: ' + context.sha + ' - Auteur: ' + context.payload.pusher.name + ' - Workflow: ' + context.payload.repository.html_url + '/actions/runs/' + context.runId,
              labels: ['critical', 'bug', 'main-branch', 'automated'],
              assignees: ['${context.payload.pusher.name}']
            });

  functional-validation:
    runs-on: ubuntu-latest
    needs: [quick-validation]
    if: success()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸ§­ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: âš¡ Run Functional Tests (Extended validation)
        run: npx playwright test --project=chromium --grep @functional --grep-invert "@wip|@flaky"

      - name: ðŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge-functional
          path: playwright-report
          retention-days: 7

      - name: Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Post-Merge Functional Tests Failed',
              body: 'Tests fonctionnels echoues sur main. Commit: ' + context.sha + ' - Auteur: ' + context.actor + ' - Workflow: ' + context.payload.repository.html_url + '/actions/runs/' + context.runId,
              labels: ['bug', 'main-branch', 'automated']
            });
