name: Post-Merge Validation

on:
  push:
    branches: [main]

jobs:
  quick-validation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ§­ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ğŸ”¥ Run Smoke Tests (Post-merge safety check)
        run: npm run test:e2e:smoke

      - name: ğŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge
          path: playwright-report
          retention-days: 7

      - name: ğŸš¨ Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Post-Merge Smoke Tests Failed on Main Branch',
              body: `## Tests Critiques Ã‰chouÃ©s AprÃ¨s Merge

URGENT: Les tests smoke ont Ã©chouÃ© sur la branche main aprÃ¨s un merge.

Commit: ${context.sha}
Auteur: ${context.payload.pusher.name}
Workflow: [Voir les dÃ©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Actions immÃ©diates requises:
1. NE PAS merger d'autres PRs jusqu'Ã  rÃ©solution
2. Consulter le rapport Playwright dans les artifacts
3. Identifier la cause de l'Ã©chec
4. Corriger en prioritÃ© ou revert le commit problÃ©matique

### Commit concernÃ©:
\`\`\`
${context.payload.head_commit.message}
\`\`\`

Cette situation indique que les tests PR n'ont pas dÃ©tectÃ© un problÃ¨me critique.
Il faut investiguer pourquoi les tests PR ont passÃ© mais les tests post-merge Ã©chouent.`,
              labels: ['critical', 'bug', 'main-branch', 'automated'],
              assignees: ['${context.payload.pusher.name}']
            });

  functional-validation:
    runs-on: ubuntu-latest
    needs: [quick-validation]
    if: success()
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ§­ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: âš¡ Run Functional Tests (Extended validation)
        run: npm run test:e2e:functional

      - name: ğŸ“Š Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-merge-functional
          path: playwright-report
          retention-days: 7

      - name: ğŸš¨ Create Issue if Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Post-Merge Functional Tests Failed on Main Branch`,
              body: `## âš ï¸ Tests Fonctionnels Ã‰chouÃ©s AprÃ¨s Merge
              
Les tests fonctionnels ont Ã©chouÃ© sur la branche main aprÃ¨s un merge.

**Commit:** ${context.sha}
**Auteur:** ${context.payload.pusher.name}
**Workflow:** [Voir les dÃ©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Note:
Les tests smoke ont passÃ©, mais les tests fonctionnels ont Ã©chouÃ©.
Cela indique un problÃ¨me dans un parcours utilisateur complet.

### Actions requises:
1. Consulter le rapport Playwright dans les artifacts
2. Identifier le parcours utilisateur qui Ã©choue
3. Corriger ou revert si critique

### Commit concernÃ©:
\`\`\`
${context.payload.head_commit.message}
\`\`\``,
              labels: ['bug', 'main-branch', 'automated'],
              assignees: ['${context.payload.pusher.name}']
            });
