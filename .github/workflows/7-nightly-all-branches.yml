name: ğŸŒ™ Nightly All Branches - Complete Tests

on:
  schedule:
    - cron: "0 2 * * *" # Tous les jours Ã  2h du matin (UTC)
  workflow_dispatch: # Permet exÃ©cution manuelle pour tester
    inputs:
      dry_run:
        description: "Dry run (ne crÃ©e pas d'issue GitHub)"
        required: false
        default: false
        type: boolean
      max_branches:
        description: "Nombre maximum de branches Ã  tester"
        required: false
        default: "10"
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ========================================
  # DÃ‰COUVERTE DES BRANCHES ACTIVES
  # ========================================
  discover-branches:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.list.outputs.branches }}
      branch_count: ${{ steps.list.outputs.count }}
      execution_id: ${{ steps.meta.outputs.execution_id }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NÃ©cessaire pour l'historique des branches

      - name: ğŸ” List active branches
        id: list
        run: |
          # Configuration - Branches spÃ©cifiques Ã  tester
          BRANCHES_TO_TEST='["main", "staging", "pre-prod", "testing", "bug"]'

          echo "ğŸ” Branches spÃ©cifiÃ©es pour les tests:"
          echo "$BRANCHES_TO_TEST" | jq -r '.[]' | while read branch; do
            echo "  - $branch"
          done

          branch_count=$(echo "$BRANCHES_TO_TEST" | jq '. | length')

          echo "branches=$BRANCHES_TO_TEST" >> $GITHUB_OUTPUT
          echo "count=$branch_count" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate execution metadata
        id: meta
        run: |
          EXECUTION_ID="nightly-$(date +%Y%m%d-%H%M%S)"
          echo "execution_id=$EXECUTION_ID" >> $GITHUB_OUTPUT
          echo "ğŸ†” Execution ID: $EXECUTION_ID"

  # ========================================
  # TESTS COMPLETS PAR BRANCHE (PARALLÃˆLE)
  # ========================================
  complete-tests-per-branch:
    needs: discover-branches
    if: needs.discover-branches.outputs.branch_count > 0
    strategy:
      fail-fast: false # Continue mÃªme si certaines branches Ã©chouent
      matrix:
        branch: ${{ fromJson(needs.discover-branches.outputs.branches) }}

    runs-on: ubuntu-latest
    env:
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      INTEGRATION_TEST_PASSWORD: ${{ secrets.INTEGRATION_TEST_PASSWORD }}
      BRANCH_NAME: ${{ matrix.branch }}
      EXECUTION_ID: ${{ needs.discover-branches.outputs.execution_id }}

    steps:
      - name: ğŸ“¥ Checkout branch ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: ğŸ” Branch info
        run: |
          echo "ğŸŒ¿ Testing branch: ${{ matrix.branch }}"
          echo "ğŸ“… Last commit: $(git log -1 --format='%h - %s (%cr)' ${{ matrix.branch }})"
          echo "ğŸ“Š Branch age: $(git log -1 --format='%cr' ${{ matrix.branch }})"

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: ğŸ­ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ matrix.branch }}-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-${{ matrix.branch }}-
            ${{ runner.os }}-playwright-

      - name: ğŸ§­ Install Playwright browsers
        run: |
          if [ "${{ steps.cache-playwright.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache hit - installation rapide"
            npx playwright install chromium firefox webkit --force
          else
            echo "âš ï¸ Cache miss - installation complÃ¨te"
            npx playwright install --with-deps chromium firefox webkit
          fi

      # ========================================
      # TESTS UNITAIRES + INTEGRATION
      # ========================================
      - name: ğŸ§ª Tests Unitaires Complets
        run: npm run test:unit
        timeout-minutes: 10
        continue-on-error: false

      - name: ğŸ”— Tests d'IntÃ©gration
        run: npm run test:integration
        timeout-minutes: 10
        continue-on-error: false

      - name: ğŸ“ TypeScript Check
        run: npm run type-check
        timeout-minutes: 5
        continue-on-error: false

      - name: ğŸ§¹ Linting
        run: npm run lint -- --max-warnings 30
        timeout-minutes: 5
        continue-on-error: false

      - name: ğŸ—ï¸ Build Validation
        run: npm run build
        timeout-minutes: 5
        continue-on-error: false

      # ========================================
      # E2E COMPLETE SUITE (TOUS NAVIGATEURS)
      # ========================================
      - name: Run Full E2E Suite (45 min - 5 navigateurs)
        run: |
          E2E_FORCE_MOCKS=true npx playwright test \
            --config=playwright.config.full.ts \
            --reporter=html,json \
            --grep-invert "RGPD|RGPD-"
        timeout-minutes: 45
        continue-on-error: false
        env:
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      # ========================================
      # UPLOAD RÃ‰SULTATS
      # ========================================
      - name: ğŸ“Š Upload Playwright reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.branch }}-${{ needs.discover-branches.outputs.execution_id }}
          path: playwright-report/
          retention-days: 7

      - name: ğŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.branch }}-${{ needs.discover-branches.outputs.execution_id }}
          path: |
            test-results/
            test-results.json
          retention-days: 7

      - name: âœ… Branch success notification
        if: success()
        run: |
          echo "ğŸ‰ Branch ${{ matrix.branch }}: TOUS LES TESTS PASSÃ‰S"
          echo "âœ… Unitaires: OK"
          echo "âœ… Integration: OK"
          echo "âœ… E2E (5 browsers): OK"
          echo "âœ… Build: OK"
          echo "âœ… TypeScript: OK"

  # ========================================
  # RAPPORT CONSOLIDÃ‰
  # ========================================
  generate-branch-health-report:
    needs: [discover-branches, complete-tests-per-branch]
    if: always() && needs.discover-branches.outputs.branch_count > 0
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“¥ Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: all-test-results
        continue-on-error: true

      - name: ğŸ“Š Generate Branch Health Report
        id: report
        run: |
          EXECUTION_ID="${{ needs.discover-branches.outputs.execution_id }}"
          REPORT_DATE="$(date '+%Y-%m-%d %H:%M:%S UTC')"

          cat > branch-health-report.md << EOF
          # ğŸŒ™ Nightly Branch Health Report

          **Date:** $REPORT_DATE  
          **Execution ID:** $EXECUTION_ID  
          **Branches testÃ©es:** ${{ needs.discover-branches.outputs.branch_count }}

          ## ğŸ“Š RÃ©sultats par Branche

          | Branche | Status | Unitaires | Integration | E2E (5 browsers) | Build | TypeScript | Lint |
          |---------|--------|-----------|-------------|------------------|-------|------------|------|
          EOF

          # Parser les rÃ©sultats et complÃ©ter le tableau
          branches='${{ needs.discover-branches.outputs.branches }}'
          echo "$branches" | jq -r '.[]' | while read branch; do
            # DÃ©terminer le status en vÃ©rifiant les rÃ©sultats
            if [ -f "all-test-results/${branch}-summary.json" ]; then
              status="âœ… PASS"
              unit="âœ…"
              integration="âœ…"
              e2e="âœ…"
              build="âœ…"
              typescript="âœ…"
              lint="âœ…"
            else
              status="âŒ FAIL"
              unit="âŒ"
              integration="âŒ"
              e2e="âŒ"
              build="âŒ"
              typescript="âŒ"
              lint="âŒ"
            fi
            
            echo "| $branch | $status | $unit | $integration | $e2e | $build | $typescript | $lint |" >> branch-health-report.md
          done

          cat >> branch-health-report.md << EOF

          ## ğŸ“ˆ Statistiques Globales

          - **Branches testÃ©es:** ${{ needs.discover-branches.outputs.branch_count }}
          - **Taux de succÃ¨s:** Ã€ calculer
          - **DurÃ©e totale:** Ã€ calculer

          ## ğŸ” DÃ©tails des Ã‰checs

          EOF

          # Ajouter les dÃ©tails des branches en Ã©chec
          echo "$branches" | jq -r '.[]' | while read branch; do
            if [ ! -f "all-test-results/${branch}-summary.json" ]; then
              echo "### âŒ $branch" >> branch-health-report.md
              echo "Tests Ã©chouÃ©s sur cette branche." >> branch-health-report.md
              echo "" >> branch-health-report.md
            fi
          done

          echo "ğŸ“Š Rapport gÃ©nÃ©rÃ©: branch-health-report.md"
          cat branch-health-report.md

      - name: ğŸ“¤ Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: branch-health-report-${{ needs.discover-branches.outputs.execution_id }}
          path: branch-health-report.md
          retention-days: 30

      - name: ğŸ“ Create GitHub Issue (si Ã©checs)
        if: failure() && github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = path.join(process.cwd(), 'branch-health-report.md');
            if (!fs.existsSync(reportPath)) {
              console.log('âŒ Rapport non trouvÃ©');
              return;
            }

            const reportContent = fs.readFileSync(reportPath, 'utf-8');
            const today = new Date().toISOString().split('T')[0];
            const executionId = '${{ needs.discover-branches.outputs.execution_id }}';

            const issueTitle = `ğŸŒ™ Nightly Branch Health Report - ${today}`;
            const issueBody = reportContent + `\n\n---\n\n**Execution ID:** ${executionId}\n**Workflow:** [Voir les dÃ©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            try {
              // Chercher une issue existante pour aujourd'hui
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'nightly-report,branch-health',
                per_page: 10
              });
              
              const todayIssue = issues.find(issue => 
                issue.title.includes('Nightly Branch Health Report') && 
                issue.title.includes(today)
              );
              
              if (todayIssue) {
                // Mettre Ã  jour l'issue existante
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: issueBody
                });
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: `## ğŸ”„ Rapport mis Ã  jour - ${new Date().toISOString()}\n\n${issueBody}`
                });
                
                console.log(`âœ… Issue #${todayIssue.number} mise Ã  jour`);
              } else {
                // CrÃ©er une nouvelle issue
                const { data: issue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['nightly-report', 'branch-health', 'automated']
                });
                
                console.log(`âœ… Issue #${issue.number} crÃ©Ã©e pour le rapport de santÃ© des branches`);
              }
            } catch (error) {
              console.error('âŒ Erreur lors de la crÃ©ation/mise Ã  jour de l\'issue:', error);
            }

      - name: ğŸ‰ Success Summary
        if: success()
        run: |
          echo "ğŸ‰ Nightly All Branches Tests Completed Successfully!"
          echo "ğŸ“Š Branches testÃ©es: ${{ needs.discover-branches.outputs.branch_count }}"
          echo "ğŸ†” Execution ID: ${{ needs.discover-branches.outputs.execution_id }}"
          echo "ğŸ“‹ Rapport disponible dans l'issue GitHub et les artefacts"
