name: 8ï¸âƒ£ Workflow Monitoring & Health Report

on:
  schedule:
    # ExÃ©cution toutes les heures pour un suivi rÃ©gulier
    - cron: '0 * * * *'
  workflow_dispatch:  # Permet exÃ©cution manuelle
  # DÃ©clenchement aprÃ¨s chaque workflow important
  workflow_run:
    workflows:
      - "1ï¸âƒ£ PR Complete Validation"
      - "2ï¸âƒ£ Develop â†’ Main (Auto-merge)"
      - "3ï¸âƒ£ Main Post-Merge E2E"
      - "6ï¸âƒ£ Nightly Full Regression"
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-monitoring
  cancel-in-progress: false  # Ne pas annuler, laisser s'accumuler pour avoir l'historique

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  generate-health-report:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“Š Generate Workflow Health Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
        run: node scripts/monitor-workflow-failures.js

      - name: ğŸ“¤ Commit and push report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # DÃ©terminer la branche cible
          # Si dÃ©clenchÃ© par workflow_run, utiliser la branche du workflow dÃ©clencheur depuis l'Ã©vÃ©nement
          # Sinon, utiliser la branche par dÃ©faut
          if [ -n "${{ github.event.workflow_run.head_branch }}" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          elif [ -n "${{ github.ref_name }}" ]; then
            BRANCH="${{ github.ref_name }}"
          else
            BRANCH="main"
          fi
          
          echo "Branche cible: $BRANCH"
          
          # S'assurer qu'on est sur la bonne branche et Ã  jour
          git fetch origin $BRANCH || git fetch origin main || git fetch origin develop
          git checkout $BRANCH 2>/dev/null || git checkout -b $BRANCH origin/$BRANCH 2>/dev/null || echo "âš ï¸ Impossible de checkout $BRANCH, utilisation de la branche actuelle"
          git pull origin $BRANCH 2>/dev/null || true
          
          # Ajouter les fichiers de monitoring
          git add "Docs/monitoring/workflow-failures-report.md" "Docs/monitoring/workflow-status.json" 2>/dev/null || true
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "âœ… Aucun changement dans le rapport"
          else
            git commit -m "docs: mise Ã  jour du rapport de monitoring des workflows [skip ci]"
            git push origin $BRANCH || {
              echo "âŒ Erreur lors du push, tentative avec HEAD"
              git push origin HEAD:$BRANCH || echo "âŒ Ã‰chec du push"
            }
          fi

      - name: ğŸ“‹ Display Report Summary
        if: always()
        run: |
          if [ -f "Docs/monitoring/workflow-failures-report.md" ]; then
            echo "## ğŸ“Š RÃ©sumÃ© du Rapport de Monitoring"
            echo ""
            head -n 50 "Docs/monitoring/workflow-failures-report.md"
          fi

