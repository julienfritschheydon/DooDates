name: 8ï¸âƒ£ Workflow Monitoring & Health Report

on:
  # ğŸ”¥ Monitoring hybride intelligent:
  # 1ï¸âƒ£ DÃ©clenchÃ© immÃ©diatement aprÃ¨s TOUS les workflows CRITIQUES
  workflow_run:
    workflows:
      - "1ï¸âƒ£ PR Complete Validation" # PR validation (+ production-smoke)
      - "2ï¸âƒ£ Develop â†’ Main (Auto-merge)" # Auto-merge develop
      - "3ï¸âƒ£ Main Complete Validation (Production Protection)" # Tests post-merge
      - "4ï¸âƒ£ Main Deploy to GitHub Pages" # DÃ©ploiement production
      - "5ï¸âƒ£ Production Smoke Tests" # Tests production rÃ©elle
      - "5ï¸âƒ£ YAML Workflows Validation" # Validation YAML workflows
      - "6. Integration Tests (Real Supabase)" # Tests d'intÃ©gration rÃ©els
    types: [completed]

  # 2ï¸âƒ£ Backup pÃ©riodique (dÃ©tecte workflows bloquÃ©s/jamais terminÃ©s)
  # âš ï¸ Pas toutes les heures - exÃ©cution toutes les 6h (4x/jour)
  schedule:
    - cron: "0 */6 * * *"

  # 3ï¸âƒ£ Manuel (toujours pratique pour debug)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-monitoring
  cancel-in-progress: false # Ne pas annuler, laisser s'accumuler pour avoir l'historique

permissions:
  contents: write
  actions: read
  issues: write

jobs:
  generate-health-report:
    runs-on: ubuntu-latest

    # ğŸ¯ S'exÃ©cute aprÃ¨s tous les workflows critiques (succÃ¨s ou Ã©chec)
    # Permet de gÃ©nÃ©rer le rapport de santÃ© aprÃ¨s chaque workflow surveillÃ©
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_run'

    steps:
      - name: ğŸ“Š Contexte de dÃ©clenchement
        run: |
          echo "ğŸ”” Monitoring dÃ©clenchÃ© par: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "ğŸ“‹ Workflow surveillÃ©: ${{ github.event.workflow_run.name }}"
            echo "âœ… Status: ${{ github.event.workflow_run.conclusion }}"
            echo "ğŸ¯ SHA du commit dÃ©clencheur: ${{ github.event.workflow_run.head_sha }}"
            echo "ğŸ¯ Branche dÃ©clencheuse: ${{ github.event.workflow_run.head_branch }}"
            echo "ğŸ¯ Raison: Ã‰chec dÃ©tectÃ© sur le commit ${{ github.event.workflow_run.head_sha }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â° ExÃ©cution pÃ©riodique (backup 6h)"
          else
            echo "ğŸ‘¤ ExÃ©cution manuelle"
          fi

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --ignore-scripts

      - name: ğŸ­ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-
            ${{ runner.os }}-playwright-

      - name: ğŸ­ Install Playwright browsers
        run: |
          echo "ğŸ“¦ Installation de chromium avec dÃ©pendances systÃ¨me..."
          npx playwright install --with-deps chromium

      - name: ğŸ¤– AI Analysis of Failures
        run: |
          echo "ğŸ¤– Analyse IA automatique des Ã©checs..."
          node scripts/auto-workflow-analyzer.js --check || echo "âš ï¸ Analyse IA non disponible (mode dÃ©veloppement)"

      - name: ğŸ“Š Generate Workflow Health Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
        run: node scripts/monitor-workflow-failures.js

      - name: ğŸ“‹ Display Report Summary
        if: always()
        run: |
          if [ -f "Docs/monitoring/workflow-failures-report.md" ]; then
            echo "## ğŸ“Š RÃ©sumÃ© du Rapport de Monitoring"
            echo ""
            head -n 50 "Docs/monitoring/workflow-failures-report.md"
          fi
