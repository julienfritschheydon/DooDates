name: 1Ô∏è‚É£ PR Complete Validation

on:
  pull_request:
    branches: [main, pre-main]
  push:
    branches: [test/workflows-validation]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Job 0: Quick Fail Layer (5 min max)
  # ‚ö° √âchoue rapidement si probl√®mes critiques d√©tect√©s
  # Si ce job √©choue, tous les autres jobs sont bloqu√©s
  quick-fail:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üß™ Tests Unitaires Ultra-Rapides
        run: npm run test:unit:fast
        timeout-minutes: 2

      - name: üìù TypeScript Check
        run: npm run type-check
        timeout-minutes: 2

      - name: üèóÔ∏è Build Validation
        run: npm run build
        timeout-minutes: 1

      - name: ‚úÖ Quick validation passed
        run: |
          echo "‚ö° Quick validation passed - proceeding with comprehensive tests"
          echo "‚úÖ Unit tests: OK"
          echo "‚úÖ TypeScript: OK" 
          echo "‚úÖ Build: OK"

  # Job 1: Tests Production Build (d√©pend de quick-fail)
  # üî• CRITIQUE: Teste le build de production AVANT tous les autres tests
  # Si ce job √©choue, tous les autres jobs sont bloqu√©s (le merge est impossible)
  production-smoke:
    needs: [quick-fail]
    if: needs.quick-fail.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üß™ Tests Unitaires Rapides
        run: npm run test:unit:fast
        timeout-minutes: 2

      - name: üìù TypeScript Check
        run: npm run type-check
        timeout-minutes: 2

      - name: üèóÔ∏è Build Validation
        run: npm run build
        timeout-minutes: 1

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright-smoke
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright (only if tests pass)
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Tests pass√©s, installation Playwright pour E2E..."
            npx playwright install --with-deps
          else
            echo "‚ùå Tests √©chou√©s, skip Playwright installation"
            exit 1
          fi
        timeout-minutes: 3

      - name: üì¶ Build production (avec base path local pour tests)
        run: npm run build
        env:
          NODE_ENV: production
          VITE_BASE_PATH: /
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: üöÄ Start preview server
        run: |
          npm run preview -- --port 4173 --host &
          echo $! > preview.pid
          sleep 5
      - name: ‚è≥ Wait for server to be ready
        run: npx wait-on http://localhost:4173/ --timeout 60000

      - name: üî• Run Smoke Tests Suite (5 min)
        run: |
          E2E_FORCE_MOCKS=true npx playwright test \
            --config=playwright.config.smoke.ts \
            --project=chromium \
            --reporter=html,json
        env:
          BASE_URL: http://localhost:4173/
          CI: true

      - name: üõë Stop preview server
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
            rm preview.pid
          fi

      - name: üìä Upload Playwright report (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-production-smoke
          path: playwright-report
          retention-days: 7

      - name: üì§ Upload test results (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-production-smoke
          path: |
            test-results
            test-results.json
          retention-days: 7

  # Job 5d: Supabase Health Check (APIs critiques uniquement)
  supabase-health:
    needs: [quick-fail, production-smoke]
    if: |
      needs.quick-fail.result == 'success' && 
      needs.production-smoke.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright-health
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright (Optimized)
        run: |
          if [ "${{ steps.cache-playwright-health.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ Cache hit - installation rapide (~10s)"
            npx playwright install chromium firefox webkit --force
          else
            echo "‚ö†Ô∏è Cache miss - installation compl√®te (~52s)"
            npx playwright install --with-deps chromium firefox webkit
          fi

      - name: üß™ Run Supabase Health Check (APIs critiques)
        run: E2E_FORCE_MOCKS=true npx playwright test tests/integration/api-security-performance.spec.ts --project=chromium --reporter=html,json
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          INTEGRATION_TEST_PASSWORD: ${{ secrets.INTEGRATION_TEST_PASSWORD }}

      - name: üß™ Run E2E Smoke Tests (Chromium)
        run: E2E_FORCE_MOCKS=true npx playwright test tests/e2e/production-smoke.spec.ts --project=chromium --reporter=html,json
        env:
          BASE_URL: http://localhost:4173/
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: üß™ Run E2E Functional Tests (Chromium)
        run: E2E_FORCE_MOCKS=true npx playwright test --project=chromium --reporter=html,json --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-"
        env:
          BASE_URL: http://localhost:4173/
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: üß™ Run E2E Matrix Tests (Multi-navigateurs)
        run: |
          # Ex√©cuter sur tous les navigateurs en parall√®le
          E2E_FORCE_MOCKS=true npx playwright test --project=firefox --reporter=html,json --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-" &
          E2E_FORCE_MOCKS=true npx playwright test --project=webkit --reporter=html,json --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-" &
          E2E_FORCE_MOCKS=true npx playwright test --project="Mobile Chrome" --reporter=html,json --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-" &
          E2E_FORCE_MOCKS=true npx playwright test --project="Mobile Safari" --reporter=html,json --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-" &
          wait
        env:
          BASE_URL: http://localhost:4173/
          CI: true
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: üìä Upload Playwright report (Supabase Health)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-supabase-health
          path: playwright-report
          retention-days: 7

  # Job 1: Tests Rapides (Parall√®le)
  quick-tests:
    needs: [quick-fail, production-smoke]
    if: |
      needs.quick-fail.result == 'success' && 
      needs.production-smoke.result == 'success'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, ux-regression]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: test-results/

      - name: Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # Job 2: Tests IA (Critique)
  ai-validation:
    needs: [quick-fail, production-smoke]
    if: |
      needs.quick-fail.result == 'success' && 
      needs.production-smoke.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: Run AI Tests (Quick)
        run: npm run test:gemini:quick
        env:

      - name: Validate AI Performance
        run: |
          if [ ! -f ./tests/reports/quick-report.json ]; then
            echo "Aucun rapport AI d√©tect√© (tests IA ignor√©s). Validation AI saut√©e."
            exit 0
          fi
          SCORE=$(node -e "
            const fs = require('fs');
            const report = require('./tests/reports/quick-report.json');
            console.log(report.percentage || 0);
          ")
          echo "Score IA: $SCORE%"
          if (( $(echo "$SCORE < 70" | bc -l) )); then
            echo "Performance IA insuffisante: $SCORE%"
            exit 1
          fi
          echo "Performance IA valid√©e: $SCORE%"

      - name: Upload AI test results
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-results
          path: tests/reports/

  # Job 3: Build & Type Check
  build-validation:
    needs: [quick-fail, production-smoke]
    if: |
      needs.quick-fail.result == 'success' && 
      needs.production-smoke.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: TypeScript Check
        run: npm run type-check

      - name: Build production
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/

  # Job 4: Code Quality
  code-quality:
    needs: [quick-fail, production-smoke]
    if: |
      needs.quick-fail.result == 'success' && 
      needs.production-smoke.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: Lint check
        run: npm run lint -- --max-warnings 1000

      - name: Format check
        run: npm run format:check

      - name: Security audit
        run: npm audit --audit-level moderate

  # Job 6: Summary
  validation-summary:
    needs:
      [
        quick-fail,
        production-smoke,
        quick-tests,
        ai-validation,
        build-validation,
        code-quality,
        supabase-health,
      ]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üì• Download test results (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: üìä Generate E2E Summary (if failures)
        id: e2e-summary
        if: needs.production-smoke.result == 'failure'
        run: |
          if [ -d test-results ]; then
            node scripts/generate-regression-summary.js pr || echo "Summary generation failed"
          else
            echo "No test results available"
          fi
        continue-on-error: true

      - name: üìä Validation Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const jobs = [
              { name: '‚ö° Quick Fail (Ultra-rapide)', status: '${{ needs.quick-fail.result }}' },
              { name: 'üî• Production Smoke + E2E (CRITIQUE)', status: '${{ needs.production-smoke.result }}' },
              { name: 'Tests Rapides', status: '${{ needs.quick-tests.result }}' },
              { name: 'Validation IA', status: '${{ needs.ai-validation.result }}' },
              { name: 'Build & Types', status: '${{ needs.build-validation.result }}' },
              { name: 'Code Quality', status: '${{ needs.code-quality.result }}' },
              { name: 'Supabase Health', status: '${{ needs.supabase-health.result }}' }
            ];

            const passed = jobs.filter(j => j.status === 'success').length;
            const total = jobs.length;
            const status = passed === total ? '‚úÖ' : '‚ùå';

            let summary = `## ${status} Validation PR - ${passed}/${total} jobs r√©ussis\n\n`;
            summary += `${jobs.map(j => `- ${j.status === 'success' ? '‚úÖ' : '‚ùå'} ${j.name}`).join('\n')}\n\n`;

            // Ajouter le r√©sum√© E2E d√©taill√© si disponible
            const summaryPath = path.join(process.cwd(), 'regression-summary.md');
            if (fs.existsSync(summaryPath)) {
              const e2eSummary = fs.readFileSync(summaryPath, 'utf-8');
              summary += `\n---\n\n## üîç D√©tails des Tests E2E\n\n${e2eSummary}\n`;
            }

            summary += `\n---\n\n`;
            summary += passed === total ? 
              'üöÄ **Toutes les validations sont pass√©es ! Cette PR peut √™tre merg√©e.**' : 
              '‚ö†Ô∏è **Des validations ont √©chou√©. Veuillez corriger avant de merger.**\n\n';
            summary += `üìã **Rapports d√©taill√©s disponibles dans les artefacts GitHub Actions**`;

            // Only create comment if this is a pull_request event (context.issue exists)
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } else {
              console.log('‚ö†Ô∏è Skipping comment creation: not a pull_request event');
              console.log('Summary:', summary);
            }
