name: 1Ô∏è‚É£ PR Complete Validation

on:
  pull_request:
    branches: [main, pre-main]
  push:
    branches: [test/workflows-validation]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Job 0: Tests Production Build (PRIORITAIRE - Bloque tout si √©chec)
  # üî• CRITIQUE: Teste le build de production AVANT tous les autres tests
  # Si ce job √©choue, tous les autres jobs sont bloqu√©s (le merge est impossible)
  production-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: üé≠ Cache Playwright browsers
        id: cache-playwright-smoke
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-
            ${{ runner.os }}-playwright-
      
      - name: üß≠ Install Playwright (Chromium only)
        if: steps.cache-playwright-smoke.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium
      
      - name: üì¶ Build production (avec base path local pour tests)
        run: npm run build
        env:
          NODE_ENV: production
          VITE_BASE_PATH: /
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
      
      - name: üöÄ Start preview server
        run: |
          npm run preview -- --port 4173 --host &
          echo $! > preview.pid
          sleep 5
      - name: ‚è≥ Wait for server to be ready
        run: npx wait-on http://localhost:4173/ --timeout 60000
      
      - name: üî• Run production smoke tests
        run: npx playwright test tests/e2e/production-smoke.spec.ts --project=chromium --reporter=html,json
        env:
          BASE_URL: http://localhost:4173/
          CI: true
      
      - name: üõë Stop preview server
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
            rm preview.pid
          fi
      
      - name: üìä Upload Playwright report (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-production-smoke
          path: playwright-report
          retention-days: 7
      
      - name: üì§ Upload test results (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-production-smoke
          path: |
            test-results
            test-results.json
          retention-days: 7

  # Job 5d: Supabase Health Check (APIs critiques uniquement)
  supabase-health:
    needs: [production-smoke]
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright-health
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright (Chromium only)
        if: steps.cache-playwright-health.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: üß™ Run Supabase Health Check (APIs critiques)
        run: npx playwright test tests/integration/api-security-performance.spec.ts --project=chromium --reporter=html,json
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          INTEGRATION_TEST_PASSWORD: ${{ secrets.INTEGRATION_TEST_PASSWORD }}

      - name: üìä Upload Playwright report (Supabase Health)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-supabase-health
          path: playwright-report
          retention-days: 7

  # Job 1: Tests Rapides (Parall√®le)
  quick-tests:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration, ux-regression]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}
      
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}
          path: test-results/
      
      - name: Upload coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # Job 2: Tests IA (Critique)
  ai-validation:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Run AI Tests (Quick)
        run: npm run test:gemini:quick
        env:
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
      
      - name: Validate AI Performance
        run: |
          if [ ! -f ./tests/reports/quick-report.json ]; then
            echo "Aucun rapport AI d√©tect√© (tests IA ignor√©s). Validation AI saut√©e."
            exit 0
          fi
          SCORE=$(node -e "
            const fs = require('fs');
            const report = require('./tests/reports/quick-report.json');
            console.log(report.percentage || 0);
          ")
          echo "Score IA: $SCORE%"
          if (( $(echo "$SCORE < 70" | bc -l) )); then
            echo "Performance IA insuffisante: $SCORE%"
            exit 1
          fi
          echo "Performance IA valid√©e: $SCORE%"
      
      - name: Upload AI test results
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-results
          path: tests/reports/

  # Job 3: Build & Type Check
  build-validation:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: TypeScript Check
        run: npm run type-check
      
      - name: Build production
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/

  # Job 4: Code Quality
  code-quality:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
      
      - name: Lint check
        run: npm run lint -- --max-warnings 1000
      
      - name: Format check
        run: npm run format:check
      
      - name: Security audit
        run: npm audit --audit-level moderate

  # Job 5: E2E Smoke (Chromium only - Tests critiques rapides)
  e2e-smoke:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: üî• Run Smoke Tests (Critical paths only)
        run: npm run test:e2e:smoke -- --reporter=html,json
        env:
          VITE_GEMINI_API_KEY: fake-key-for-e2e-tests  # Mock will intercept API calls

      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke
          path: playwright-report
          retention-days: 7

      - name: üì§ Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-smoke
          path: |
            test-results
            test-results.json
          retention-days: 7

  # Job 5b: E2E Functional (Chromium only - Tests fonctionnels complets)
  e2e-functional:
    needs: [production-smoke, e2e-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue, ex√©cuter apr√®s smoke tests
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üß≠ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ‚ö° Run Functional Tests (Complete user flows)
        run: npm run test:e2e:functional -- --reporter=html,json
        env:
          VITE_GEMINI_API_KEY: fake-key-for-e2e-tests  # Mock will intercept API calls

      - name: üìä Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-functional
          path: playwright-report
          retention-days: 7

      - name: üì§ Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-functional
          path: |
            test-results
            test-results.json
          retention-days: 7

  # Job 5c: E2E Matrix (Desktop + Mobile - Tests multi-navigateurs)
  e2e-matrix:
    needs: [production-smoke]  # ‚ö†Ô∏è Bloqu√© si production-smoke √©choue
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: [
          'chromium',
          'firefox',
          'webkit',
          'Mobile Chrome',
          'Mobile Safari'
        ]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ matrix.project }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-${{ matrix.project }}-
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright Browser (${{ matrix.project }})
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: |
          # D√©terminer le navigateur √† installer
          case "${{ matrix.project }}" in
            "chromium"|"Mobile Chrome")
              BROWSER="chromium"
              ;;
            "firefox")
              BROWSER="firefox"
              ;;
            "webkit"|"Mobile Safari")
              BROWSER="webkit"
              ;;
            *)
              BROWSER="chromium firefox webkit"
              ;;
          esac
          
          # Toujours installer avec --with-deps en CI (d√©pendances syst√®me non cach√©es)
          echo "üì¶ Installation de $BROWSER avec d√©pendances syst√®me..."
          npx playwright install --with-deps $BROWSER

      - name: üß™ Run Playwright E2E (${{ matrix.project }})
        # Exclure les tests RGPD (ex√©cut√©s s√©par√©ment dans 8-rgpd-compliance.yml)
        run: |
          npx playwright test --project="${{ matrix.project }}" --reporter=html,json --ignore-snapshots --grep-invert "Edge Cases and Error Handling|Guest User Workflow|Authenticated User Workflow|RGPD|RGPD-"

      - name: üìä Upload Playwright report (${{ matrix.project }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.project }}
          path: playwright-report
          retention-days: 7

      - name: üì§ Upload test results JSON (${{ matrix.project }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project }}
          path: |
            test-results
            test-results.json
          retention-days: 7

  # Job 6: Summary
  validation-summary:
    needs: [production-smoke, quick-tests, ai-validation, build-validation, code-quality, e2e-smoke, e2e-functional, e2e-matrix, supabase-health]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: üì• Download test results (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: üìä Generate E2E Summary (if failures)
        id: e2e-summary
        if: needs.e2e-smoke.result == 'failure' || needs.e2e-functional.result == 'failure' || needs.e2e-matrix.result == 'failure'
        run: |
          if [ -d test-results ]; then
            node scripts/generate-regression-summary.js pr || echo "Summary generation failed"
          else
            echo "No test results available"
          fi
        continue-on-error: true

      - name: üìä Validation Summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const jobs = [
              { name: 'üî• Production Smoke (CRITIQUE)', status: '${{ needs.production-smoke.result }}' },
              { name: 'Tests Rapides', status: '${{ needs.quick-tests.result }}' },
              { name: 'Validation IA', status: '${{ needs.ai-validation.result }}' },
              { name: 'Build & Types', status: '${{ needs.build-validation.result }}' },
              { name: 'Code Quality', status: '${{ needs.code-quality.result }}' },
              { name: 'E2E Smoke (Critical)', status: '${{ needs.e2e-smoke.result }}' },
              { name: 'E2E Functional (Complete)', status: '${{ needs.e2e-functional.result }}' },
              { name: 'E2E Matrix (All Browsers)', status: '${{ needs.e2e-matrix.result }}' },
              { name: 'Supabase Health Check (APIs critiques)', status: '${{ needs.supabase-health.result }}' }
            ];
            
            const passed = jobs.filter(j => j.status === 'success').length;
            const total = jobs.length;
            const status = passed === total ? '‚úÖ' : '‚ùå';
            
            let summary = `## ${status} Validation PR - ${passed}/${total} jobs r√©ussis\n\n`;
            summary += `${jobs.map(j => `- ${j.status === 'success' ? '‚úÖ' : '‚ùå'} ${j.name}`).join('\n')}\n\n`;
            
            // Ajouter le r√©sum√© E2E d√©taill√© si disponible
            const summaryPath = path.join(process.cwd(), 'regression-summary.md');
            if (fs.existsSync(summaryPath)) {
              const e2eSummary = fs.readFileSync(summaryPath, 'utf-8');
              summary += `\n---\n\n## üîç D√©tails des Tests E2E\n\n${e2eSummary}\n`;
            }
            
            summary += `\n---\n\n`;
            summary += passed === total ? 
              'üöÄ **Toutes les validations sont pass√©es ! Cette PR peut √™tre merg√©e.**' : 
              '‚ö†Ô∏è **Des validations ont √©chou√©. Veuillez corriger avant de merger.**\n\n';
            summary += `üìã **Rapports d√©taill√©s disponibles dans les artefacts GitHub Actions**`;
            
            // Only create comment if this is a pull_request event (context.issue exists)
            if (context.issue && context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } else {
              console.log('‚ö†Ô∏è Skipping comment creation: not a pull_request event');
              console.log('Summary:', summary);
            } 