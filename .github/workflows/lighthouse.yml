name: Lighthouse CI (Scheduled)

on:
  schedule:
    - cron: "0 3 * * *" # Tous les jours √† 3h UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run type-check

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Start preview server
        run: |
          npm run preview -- --port 4173 --host &
          echo $! > preview.pid
          sleep 5

      - name: Wait for server
        run: npx wait-on http://localhost:4173/DooDates/ --timeout 60000

      - name: Run Lighthouse CI
        run: npx -y @lhci/cli autorun --config=./lighthouserc.json

      - name: üìä Send Lighthouse metrics to Supabase
        if: always()
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Trouver le dernier rapport Lighthouse
          REPORT_FILE=$(find .lighthouseci -name "lhr-*.json" | head -1)
          if [ -f "$REPORT_FILE" ]; then
            echo "üìä Envoi des m√©triques Lighthouse √† Supabase..."
            node scripts/send-performance-metrics.js --source lighthouse --file "$REPORT_FILE"
          else
            echo "‚ö†Ô∏è Aucun rapport Lighthouse trouv√©"
          fi

      - name: Stop preview server
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
            rm preview.pid
          fi

      - name: Upload Lighthouse report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lhci-report
          retention-days: 30

      - name: üö® Check for Lighthouse Performance Regressions (>10%)
        id: lighthouse-regression
        run: node scripts/detect-lighthouse-regression.js
        continue-on-error: true

      - name: üìù Create Lighthouse Regression Issue
        if: steps.lighthouse-regression.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportPath = path.join(process.cwd(), 'lighthouse-regression-report.md');
            if (!fs.existsSync(reportPath)) {
              console.log('No Lighthouse regression report found');
              return;
            }

            const reportContent = fs.readFileSync(reportPath, 'utf-8');

            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `üö® Performance Regression Detected - Lighthouse CI - ${today}`;

            try {
              // Check for existing Lighthouse regression issue today
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'performance-regression,automated',
                per_page: 10
              });

              const todayIssue = issues.find(issue =>
                issue.title.includes('Lighthouse CI') &&
                (issue.title.includes(today) || issue.created_at.startsWith(today))
              );

              if (todayIssue) {
                // Update existing issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: `## üîÑ Nouvelle r√©gression Lighthouse d√©tect√©e - ${new Date().toISOString()}\n\n${reportContent}`
                });
                console.log(`‚úÖ Comment ajout√© √† l'issue Lighthouse existante #${todayIssue.number}`);
              } else {
                // Create new issue
                const { data: issue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: reportContent,
                  labels: ['performance-regression', 'automated', 'urgent', 'lighthouse-ci']
                });
                console.log(`‚úÖ Issue #${issue.number} cr√©√©e pour r√©gression performance Lighthouse CI`);
              }
            } catch (error) {
              console.error('‚ùå Erreur lors de la cr√©ation/mise √† jour de l\'issue Lighthouse:', error);
            }
