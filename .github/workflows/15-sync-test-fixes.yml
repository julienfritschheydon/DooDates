name: üîÑ Sync Test Fixes (Auto-propagate)

# Propage automatiquement les modifications de tests entre branches
# quand les tests passent sur une branche

on:
  push:
    branches:
      - bug
      - testing
      - staging
      - pre-prod
    paths:
      # D√©clench√© uniquement pour les fichiers de tests
      - 'tests/**'
      - 'src/**/__tests__/**'
      - 'src/**/*.test.ts'
      - 'src/**/*.test.tsx'
      - 'vitest.config.ts'
      - 'playwright.config.ts'

permissions:
  contents: write
  pull-requests: write

jobs:
  # ========================================
  # VALIDATION DES TESTS
  # ========================================
  validate-tests:
    runs-on: ubuntu-latest
    outputs:
      tests-passed: ${{ steps.test-result.outputs.passed }}
      test-files-changed: ${{ steps.changed-files.outputs.test_files }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üîç Identify changed test files
        id: changed-files
        run: |
          # R√©cup√©rer les fichiers de tests modifi√©s
          TEST_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(test|spec)\.(ts|tsx|js)$|tests/|__tests__/' || echo "")
          echo "test_files<<EOF" >> $GITHUB_OUTPUT
          echo "$TEST_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -n "$TEST_FILES" ]; then
            echo "üìù Test files changed:"
            echo "$TEST_FILES"
          else
            echo "‚ö†Ô∏è No test files detected in this commit"
          fi

      - name: üß™ Run unit tests
        id: unit-tests
        run: npm run test:unit:fast
        continue-on-error: true

      - name: üìä Set test result
        id: test-result
        run: |
          if [ "${{ steps.unit-tests.outcome }}" == "success" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Tests passed - ready to propagate"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Tests failed - propagation blocked"
          fi

  # ========================================
  # PROPAGATION: bug ‚Üí testing
  # ========================================
  propagate-bug-to-testing:
    needs: validate-tests
    if: |
      github.ref == 'refs/heads/bug' &&
      needs.validate-tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÄ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üîç Get test commits from bug
        id: get-commits
        run: |
          # R√©cup√©rer les commits r√©cents de bug qui touchent uniquement les tests
          git fetch origin bug
          
          # Trouver les commits de tests des derni√®res 24h
          TEST_COMMITS=$(git log origin/bug --oneline --since="24 hours ago" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx' \
            'vitest.config.ts' \
            'playwright.config.ts' | head -5)
          
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$TEST_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "üìù Test commits to propagate:"
          echo "$TEST_COMMITS"

      - name: üöÄ Cherry-pick test changes
        run: |
          # R√©cup√©rer le dernier commit de test de bug
          LAST_TEST_COMMIT=$(git log origin/bug -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Cherry-picking: $LAST_TEST_COMMIT"
            
            # Cherry-pick avec gestion des conflits
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              # V√©rifier s'il y a des changements
              if git diff --cached --quiet; then
                echo "‚ö†Ô∏è No changes to commit (already applied)"
              else
                git commit -m "chore(tests): sync test fixes from bug branch [auto]"
                git push origin testing
                echo "‚úÖ Test fixes propagated to testing"
              fi
            else
              echo "‚ö†Ô∏è Cherry-pick conflict - manual intervention required"
              git cherry-pick --abort
              exit 0  # Ne pas √©chouer, juste notifier
            fi
          else
            echo "‚ÑπÔ∏è No test commits to propagate"
          fi

  # ========================================
  # PROPAGATION: testing ‚Üí staging
  # ========================================
  propagate-testing-to-staging:
    needs: validate-tests
    if: |
      github.ref == 'refs/heads/testing' &&
      needs.validate-tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÄ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üöÄ Cherry-pick test changes from testing
        run: |
          git fetch origin testing
          
          LAST_TEST_COMMIT=$(git log origin/testing -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Cherry-picking: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if git diff --cached --quiet; then
                echo "‚ö†Ô∏è No changes to commit (already applied)"
              else
                git commit -m "chore(tests): sync test fixes from testing branch [auto]"
                git push origin staging
                echo "‚úÖ Test fixes propagated to staging"
              fi
            else
              echo "‚ö†Ô∏è Cherry-pick conflict - manual intervention required"
              git cherry-pick --abort
            fi
          fi

  # ========================================
  # PROPAGATION: staging ‚Üí pre-prod
  # ========================================
  propagate-staging-to-preprod:
    needs: validate-tests
    if: |
      github.ref == 'refs/heads/staging' &&
      needs.validate-tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout pre-prod branch
        uses: actions/checkout@v4
        with:
          ref: pre-prod
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÄ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üöÄ Cherry-pick test changes from staging
        run: |
          git fetch origin staging
          
          LAST_TEST_COMMIT=$(git log origin/staging -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Cherry-picking: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if git diff --cached --quiet; then
                echo "‚ö†Ô∏è No changes to commit (already applied)"
              else
                git commit -m "chore(tests): sync test fixes from staging branch [auto]"
                git push origin pre-prod
                echo "‚úÖ Test fixes propagated to pre-prod"
              fi
            else
              echo "‚ö†Ô∏è Cherry-pick conflict - manual intervention required"
              git cherry-pick --abort
            fi
          fi

  # ========================================
  # PROPAGATION INVERSE: pre-prod ‚Üí staging ‚Üí testing ‚Üí bug
  # (pour les hotfixes de tests sur pre-prod)
  # ========================================
  propagate-preprod-downstream:
    needs: validate-tests
    if: |
      github.ref == 'refs/heads/pre-prod' &&
      needs.validate-tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÄ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üîÑ Backport test fixes to staging
        run: |
          git fetch origin pre-prod
          
          LAST_TEST_COMMIT=$(git log origin/pre-prod -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Backporting to staging: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if ! git diff --cached --quiet; then
                git commit -m "chore(tests): backport test fixes from pre-prod [auto]"
                git push origin staging
                echo "‚úÖ Test fixes backported to staging"
              fi
            else
              git cherry-pick --abort
              echo "‚ö†Ô∏è Backport conflict - skipping"
            fi
          fi

      - name: üì• Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÑ Backport test fixes to testing
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin pre-prod
          
          LAST_TEST_COMMIT=$(git log origin/pre-prod -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Backporting to testing: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if ! git diff --cached --quiet; then
                git commit -m "chore(tests): backport test fixes from pre-prod [auto]"
                git push origin testing
                echo "‚úÖ Test fixes backported to testing"
              fi
            else
              git cherry-pick --abort
              echo "‚ö†Ô∏è Backport conflict - skipping"
            fi
          fi

      - name: üì• Checkout bug branch
        uses: actions/checkout@v4
        with:
          ref: bug
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÑ Backport test fixes to bug
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin pre-prod
          
          LAST_TEST_COMMIT=$(git log origin/pre-prod -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Backporting to bug: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if ! git diff --cached --quiet; then
                git commit -m "chore(tests): backport test fixes from pre-prod [auto]"
                git push origin bug
                echo "‚úÖ Test fixes backported to bug"
              fi
            else
              git cherry-pick --abort
              echo "‚ö†Ô∏è Backport conflict - skipping"
            fi
          fi

  # ========================================
  # PROPAGATION INVERSE: staging ‚Üí testing ‚Üí bug
  # (pour les hotfixes de tests sur staging)
  # ========================================
  propagate-staging-downstream:
    needs: validate-tests
    if: |
      github.ref == 'refs/heads/staging' &&
      needs.validate-tests.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout testing branch
        uses: actions/checkout@v4
        with:
          ref: testing
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÄ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üîÑ Backport test fixes to testing
        run: |
          git fetch origin staging
          
          LAST_TEST_COMMIT=$(git log origin/staging -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Backporting to testing: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if ! git diff --cached --quiet; then
                git commit -m "chore(tests): backport test fixes from staging [auto]"
                git push origin testing
                echo "‚úÖ Test fixes backported to testing"
              fi
            else
              git cherry-pick --abort
              echo "‚ö†Ô∏è Backport conflict - skipping"
            fi
          fi

      - name: üì• Checkout bug branch
        uses: actions/checkout@v4
        with:
          ref: bug
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üîÑ Backport test fixes to bug
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin staging
          
          LAST_TEST_COMMIT=$(git log origin/staging -1 --format="%H" -- \
            'tests/**' \
            'src/**/__tests__/**' \
            'src/**/*.test.ts' \
            'src/**/*.test.tsx')
          
          if [ -n "$LAST_TEST_COMMIT" ]; then
            echo "üçí Backporting to bug: $LAST_TEST_COMMIT"
            
            if git cherry-pick "$LAST_TEST_COMMIT" --no-commit; then
              if ! git diff --cached --quiet; then
                git commit -m "chore(tests): backport test fixes from staging [auto]"
                git push origin bug
                echo "‚úÖ Test fixes backported to bug"
              fi
            else
              git cherry-pick --abort
              echo "‚ö†Ô∏è Backport conflict - skipping"
            fi
          fi

  # ========================================
  # NOTIFICATION
  # ========================================
  notify-propagation:
    needs: [validate-tests, propagate-bug-to-testing, propagate-testing-to-staging, propagate-staging-to-preprod, propagate-preprod-downstream, propagate-staging-downstream]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üì¢ Summary
        run: |
          echo "## üîÑ Test Sync Summary"
          echo ""
          echo "| Branch | Status |"
          echo "|--------|--------|"
          echo "| Source: ${{ github.ref_name }} | Tests: ${{ needs.validate-tests.outputs.tests-passed == 'true' && '‚úÖ' || '‚ùå' }} |"
          echo "| bug ‚Üí testing | ${{ needs.propagate-bug-to-testing.result || 'N/A' }} |"
          echo "| testing ‚Üí staging | ${{ needs.propagate-testing-to-staging.result || 'N/A' }} |"
          echo "| staging ‚Üí pre-prod | ${{ needs.propagate-staging-to-preprod.result || 'N/A' }} |"
          echo "| pre-prod ‚Üí downstream | ${{ needs.propagate-preprod-downstream.result || 'N/A' }} |"
          echo "| staging ‚Üí downstream | ${{ needs.propagate-staging-downstream.result || 'N/A' }} |"
