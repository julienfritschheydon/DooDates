name: 5ï¸âƒ£ Unified Smoke Tests (Pre & Post Deployment)

# ğŸ”¥ WORKFLOW UNIFIÃ‰ - Tests de smoke complets avec protection production
#
# Phase 1: PrÃ©-dÃ©ploiement - Tests sur build local
# Phase 2: Post-dÃ©ploiement - Tests sur application dÃ©ployÃ©e
#
# DÃ©clenchÃ© aprÃ¨s la validation complÃ¨te (workflow 3)
# DÃ©clenche le dÃ©ploiement (workflow 4) SEULEMENT si phase 1 rÃ©ussie
# Teste la production aprÃ¨s dÃ©ploiement pour validation finale

on:
  # DÃ©clenchÃ© aprÃ¨s validation complÃ¨te
  workflow_run:
    workflows: ["3ï¸âƒ£ Main Complete Validation (Production Protection)"]
    types: [completed]

  # Permet de lancer manuellement
  workflow_dispatch:
    inputs:
      skip_deployment:
        description: "Skip deployment and only run smoke tests"
        required: false
        type: boolean
        default: false
      production_url:
        description: "URL de production Ã  tester (manuelle)"
        required: false
        type: string

# Permissions nÃ©cessaires pour crÃ©er des issues et dÃ©clencher d'autres workflows
permissions:
  contents: read
  issues: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ========================================
  # PHASE 1: SMOKE TESTS PRÃ‰-DÃ‰PLOIEMENT
  # ========================================
  pre-deployment-smoke:
    name: ğŸ”¥ Phase 1 - Pre-Deployment Smoke Tests
    runs-on: ubuntu-latest

    # N'exÃ©cuter que si la validation a rÃ©ussi
    if: |
      github.event.workflow_run.conclusion == 'success' || 
      github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ğŸ§­ Install Playwright (Chromium only)
        run: |
          echo "ğŸ“¦ Installation de chromium avec dÃ©pendances systÃ¨me..."
          npx playwright install --with-deps chromium

      - name: ğŸ“¦ Build production (local preview)
        run: npm run build
        env:
          NODE_ENV: production
          VITE_BASE_PATH: /
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}

      - name: ğŸš€ Start preview server
        run: |
          npm run preview -- --port 4173 --host &
          echo $! > preview.pid
          sleep 5

      - name: â³ Wait for server to be ready
        run: npx wait-on http://localhost:4173/ --timeout 60000

      - name: ğŸ”¥ Run Pre-Deployment Smoke Tests
        id: pre-smoke-tests
        run: |
          echo "ğŸ”¥ Phase 1: Tests de smoke prÃ©-dÃ©ploiement..."
          echo "ğŸŒ URL: http://localhost:4173/"
          npx playwright test tests/e2e/production-smoke.spec.ts \
            --project=chromium \
            --reporter=html,json \
            --retries=2
        env:
          NODE_ENV: production
          CI: true
          BASE_URL: http://localhost:4173/
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}

      - name: ğŸ›‘ Stop preview server
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
            rm preview.pid
          fi

      - name: ğŸ“Š Upload Pre-Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pre-deployment
          path: playwright-report
          retention-days: 7

      - name: ğŸ“¤ Upload Pre-Deployment Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-pre-deployment
          path: |
            test-results
            test-results.json
          retention-days: 7

      - name: âŒ Create Issue on Pre-Deployment Failure
        if: steps.pre-smoke-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = `## ğŸš¨ CRITICAL: Pre-Deployment Smoke Tests Failed\n\n` +
              `**Phase:** PrÃ©-dÃ©ploiement (build local)\n` +
              `**Impact:** DÃ©ploiement bloquÃ© - protection production activÃ©e\n\n` +
              `**Details:**\n` +
              `- Commit: \`${{ github.sha }}\`\n` +
              `- Workflow: [View logs](${context.payload.repository.html_url}/actions/runs/${context.runId})\n` +
              `- Phase: Tests sur build local (preview server)\n\n` +
              `**Next Steps:**\n` +
              `1. Review test failures in artifacts\n` +
              `2. Fix issues on develop branch\n` +
              `3. Re-merge when fixed\n\n` +
              `**Status:** ğŸš« DEPLOYMENT BLOCKED - Production Protected`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ CRITICAL: Pre-Deployment Smoke Failed - Deployment Blocked',
              body: issueBody,
              labels: ['critical', 'production', 'pre-deployment', 'blocked', 'smoke-tests']
            });

  # ========================================
  # DÃ‰CLENCHEUR DÃ‰PLOIEMENT (si phase 1 rÃ©ussie)
  # ========================================
  trigger-deployment:
    name: ğŸš€ Trigger Deployment
    needs: pre-deployment-smoke
    runs-on: ubuntu-latest

    # Seulement si phase 1 rÃ©ussie ET pas de skip manuel
    if: |
      needs.pre-deployment-smoke.result == 'success' &&
      (github.event.inputs.skip_deployment != 'true' || github.event.inputs.skip_deployment == '')

    steps:
      - name: ğŸš€ Trigger Deployment Workflow
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ Triggering deployment workflow...');
            console.log('Pre-deployment smoke tests: âœ… PASSED');
            console.log('Ready for production deployment');

      - name: âœ… Deployment Ready Notification
        run: |
          echo "âœ… Pre-deployment smoke tests passed!"
          echo "ğŸš€ Triggering deployment to GitHub Pages..."
          echo "ğŸ›¡ï¸ Production protection maintained"

  # ========================================
  # PHASE 2: SMOKE TESTS POST-DÃ‰PLOIEMENT
  # ========================================
  post-deployment-smoke:
    name: ğŸ”¥ Phase 2 - Post-Deployment Smoke Tests
    needs: [pre-deployment-smoke, trigger-deployment]
    runs-on: ubuntu-latest

    # Attendre que le dÃ©ploiement soit terminÃ©
    if: |
      needs.pre-deployment-smoke.result == 'success' &&
      (needs.trigger-deployment.result == 'success' || needs.trigger-deployment.result == 'skipped')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ”§ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ğŸ§­ Install Playwright (Chromium only)
        run: |
          echo "ğŸ“¦ Installation de chromium avec dÃ©pendances systÃ¨me..."
          npx playwright install --with-deps chromium

      - name: â° Attendre propagation dÃ©ploiement
        run: |
          echo "â³ Attente de 30 secondes pour propagation GitHub Pages..."
          sleep 30

      - name: ğŸ” DÃ©terminer URL production
        id: production-url
        run: |
          if [ -n "${{ github.event.inputs.production_url }}" ]; then
            PROD_URL="${{ github.event.inputs.production_url }}"
          else
            REPO_NAME="${{ github.repository }}"
            REPO_NAME="${REPO_NAME#*/}"
            PROD_URL="https://${{ github.repository_owner }}.github.io/${REPO_NAME}"
          fi
          echo "url=${PROD_URL}" >> $GITHUB_OUTPUT
          echo "ğŸŒ URL de production: ${PROD_URL}"

      - name: ğŸ”¥ Run Post-Deployment Smoke Tests
        id: post-smoke-tests
        run: |
          echo "ğŸ”¥ Phase 2: Tests de smoke post-dÃ©ploiement..."
          echo "ğŸŒ URL: ${{ steps.production-url.outputs.url }}"
          npx playwright test tests/e2e/production-smoke.spec.ts \
            --project=chromium \
            --reporter=html,json \
            --retries=2
        env:
          NODE_ENV: production
          CI: true
          BASE_URL: ${{ steps.production-url.outputs.url }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        continue-on-error: true

      - name: ğŸ“Š Upload Post-Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-post-deployment
          path: playwright-report
          retention-days: 30

      - name: ğŸ“¤ Upload Post-Deployment Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-post-deployment
          path: |
            test-results
            test-results.json
          retention-days: 30

      - name: ğŸ“¸ Upload Screenshots (si Ã©chec)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: post-deployment-screenshots
          path: test-results/**/*.png
          if-no-files-found: ignore
          retention-days: 30

      - name: ğŸš¨ Create Critical Issue on Post-Deployment Failure
        if: steps.post-smoke-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const prodUrl = '${{ steps.production-url.outputs.url }}';
            const workflowUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;

            const issueBody = `## ğŸš¨ CRITICAL: Post-Deployment Smoke Tests Failed\n\n` +
              `**Phase:** Post-dÃ©ploiement (production dÃ©ployÃ©e)\n` +
              `**Impact:** Application en production potentiellement cassÃ©e\n\n` +
              `**Details:**\n` +
              `- URL testÃ©e: ${prodUrl}\n` +
              `- Commit: \`${{ github.sha }}\`\n` +
              `- Workflow: [View logs](${workflowUrl})\n\n` +
              `**Immediate Actions Required:**\n` +
              `1. [Check production app](${prodUrl})\n` +
              `2. [Review workflow logs](${workflowUrl})\n` +
              `3. Consider rollback if critical\n\n` +
              `**Rollback Command:**\n` +
              `\`\`\`bash\n` +
              `git revert ${{ github.sha }}\n` +
              `git push origin main\n` +
              `\`\`\`\n\n` +
              `**Status:** ğŸš¨ PRODUCTION ISSUE - Investigation Required`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ PRODUCTION ISSUE - Post-Deployment Smoke Failed',
              body: issueBody,
              labels: ['critical', 'production', 'post-deployment', 'incident', 'urgent', 'smoke-tests']
            });

      - name: âŒ Mark as Failed
        if: steps.post-smoke-tests.outcome == 'failure'
        run: |
          echo "âŒ Post-deployment smoke tests failed!"
          echo "ğŸš¨ Production issue detected!"
          echo "ğŸ“‹ Critical issue created"
          exit 1

      - name: âœ… Production Deployment Success
        if: steps.post-smoke-tests.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('âœ… Complete smoke test suite passed!');
            console.log('ğŸš€ Production deployment verified and working');
            console.log('ğŸŒ URL: ${{ steps.production-url.outputs.url }}');
            console.log('ğŸ›¡ï¸ Production protection maintained');

  # ========================================
  # SUCCESS NOTIFICATION
  # ========================================
  success-notification:
    name: ğŸ‰ Deployment Complete
    needs: [pre-deployment-smoke, trigger-deployment, post-deployment-smoke]
    if: |
      always() &&
      needs.pre-deployment-smoke.result == 'success' &&
      (needs.trigger-deployment.result == 'success' || needs.trigger-deployment.result == 'skipped') &&
      needs.post-deployment-smoke.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ‰ Production Ready
        run: |
          echo "ğŸ‰ Unified smoke test suite completed successfully!"
          echo "âœ… Phase 1 (Pre-Deployment): PASSED"
          echo "âœ… Phase 2 (Post-Deployment): PASSED"
          echo "ğŸš€ Production deployment verified and working"
          echo "ğŸ›¡ï¸ Production protection maintained"
          echo "ğŸ“Š All smoke tests passed - Production is healthy"

# ========================================
# ğŸ“‹ NOTES SUR CE WORKFLOW UNIFIÃ‰
# ========================================
#
# Avantages:
# - Protection complÃ¨te: pas de dÃ©ploiement si phase 1 Ã©choue
# - Validation finale: tests post-dÃ©ploiement garantissent production fonctionnelle
# - Un workflow: plus simple Ã  maintenir et comprendre
# - Artefacts sÃ©parÃ©s: prÃ© et post-dÃ©ploiement
#
# Flux:
# 1. Validation complÃ¨te (workflow 3) âœ…
# 2. Phase 1: Smoke tests prÃ©-dÃ©ploiement ğŸ“¦
# 3. Si rÃ©ussi: DÃ©clencher dÃ©ploiement (workflow 4) ğŸš€
# 4. Phase 2: Smoke tests post-dÃ©ploiement ğŸ”¥
# 5. Si tout rÃ©ussi: Production validÃ©e âœ…
#
# Protection:
# - Phase 1 bloque le dÃ©ploiement si Ã©chec
# - Phase 2 alerte si production cassÃ©e
# - Issues critiques crÃ©Ã©es automatiquement
# - Rollback suggestions incluses
