name: 8Ô∏è‚É£ RGPD Compliance Tests (Weekly)

on:
  schedule:
    # Tous les dimanches √† 3h du matin (UTC)
    - cron: "0 3 * * 0"
  workflow_dispatch: # Permet ex√©cution manuelle
  push:
    branches: [main]
    paths:
      - "tests/e2e/rgpd/**"
      - "src/lib/security/**"
      - "src/services/DataRetentionService.ts"
      - "src/pages/DataControl.tsx"
      - "src/pages/products/date-polls/DatePollsDataControl.tsx"
      - ".github/workflows/8-rgpd-compliance.yml"

permissions:
  contents: read
  issues: write

jobs:
  rgpd-compliance:
    runs-on: ubuntu-latest
    # Ex√©cuter seulement sur chromium pour gagner du temps
    # Les tests RGPD sont fonctionnels, pas li√©s au navigateur

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: npm ci

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: üß≠ Install Playwright Browser (chromium only)
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: üîí Run RGPD Compliance Tests
        run: npx playwright test tests/e2e/rgpd --project=chromium --reporter=html,json --workers=1
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

          INTEGRATION_TEST_PASSWORD: ${{ secrets.INTEGRATION_TEST_PASSWORD }}

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-rgpd-compliance
          path: playwright-report
          retention-days: 30

      - name: üì§ Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-rgpd-compliance
          path: |
            test-results
            test-results.json
          retention-days: 30

      - name: üìã Generate RGPD Compliance Report
        if: always()
        run: |
          echo "# üîí Rapport de Conformit√© RGPD" > rgpd-compliance-report.md
          echo "" >> rgpd-compliance-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> rgpd-compliance-report.md
          echo "" >> rgpd-compliance-report.md

          if [ -f test-results.json ]; then
            echo "## R√©sultats des Tests" >> rgpd-compliance-report.md
            echo "" >> rgpd-compliance-report.md
            echo "- **Total de tests:** $(jq '.stats.total' test-results.json 2>/dev/null || echo 'N/A')" >> rgpd-compliance-report.md
            echo "- **Tests r√©ussis:** $(jq '.stats.passed' test-results.json 2>/dev/null || echo 'N/A')" >> rgpd-compliance-report.md
            echo "- **Tests √©chou√©s:** $(jq '.stats.failed' test-results.json 2>/dev/null || echo 'N/A')" >> rgpd-compliance-report.md
            echo "- **Temps d'ex√©cution:** $(jq '.stats.duration' test-results.json 2>/dev/null || echo 'N/A')s" >> rgpd-compliance-report.md
          fi

          echo "" >> rgpd-compliance-report.md
          echo "## Tests Couverts" >> rgpd-compliance-report.md
          echo "" >> rgpd-compliance-report.md
          echo "- ‚úÖ Droit d'acc√®s (Article 15) - 6 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Droit de rectification (Article 16) - 5 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Droit √† l'effacement (Article 17) - 6 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Droit √† la portabilit√© (Article 20) - 6 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Consentement et opt-out (Article 7) - 5 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Suppression automatique - 5 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Anonymisation Form Polls - 5 tests" >> rgpd-compliance-report.md
          echo "- ‚úÖ Logs et audit - 6 tests" >> rgpd-compliance-report.md
          echo "" >> rgpd-compliance-report.md
          echo "**Total: 44 tests RGPD**" >> rgpd-compliance-report.md
        continue-on-error: true

      - name: üì§ Upload Compliance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rgpd-compliance-report
          path: rgpd-compliance-report.md
          retention-days: 90

      - name: üìù Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            let reportContent = '';
            const reportPath = path.join(process.cwd(), 'rgpd-compliance-report.md');
            if (fs.existsSync(reportPath)) {
              reportContent = fs.readFileSync(reportPath, 'utf-8');
            } else {
              reportContent = '## üö® √âchec des Tests RGPD\n\nLes tests de conformit√© RGPD ont √©chou√©.';
            }

            reportContent += `\n\n---\n\n**üîó Lien vers le workflow:** [Voir les d√©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;

            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `üö® RGPD Compliance Tests - √âchec - ${today}`;

            try {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'rgpd,compliance,automated',
                per_page: 10
              });
              
              const todayIssue = issues.find(issue => 
                issue.title.includes('RGPD Compliance') &&
                (issue.title.includes(today) || issue.created_at.startsWith(today))
              );
              
              if (todayIssue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: `## üîÑ Nouvel √©chec d√©tect√© - ${new Date().toISOString()}\n\n${reportContent}`
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: reportContent,
                  labels: ['rgpd', 'compliance', 'automated', 'urgent']
                });
              }
            } catch (error) {
              console.error('‚ùå Erreur lors de la cr√©ation/mise √† jour de l\'issue:', error);
            }
