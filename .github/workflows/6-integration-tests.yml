name: 6. Production Integration Tests (Real Supabase)

# R√îLE UNIQUE : Tests r√©els sur Supabase production
# DIFF√âRENCE avec 2-develop-automerge.yml :
# - 2-develop-automerge : Tests locaux/mock√©s (rapide, pr√©-merge)
# - 6-integration-tests : Tests r√©els Supabase (lent, post-merge)
# √âvite la duplication en ayant des objectifs distincts

on:
  pull_request:
    branches: [pre-main]
  # push:
  #   branches: [pre-main]  # TEMPORAIREMENT D√âSACTIV√â - test manquant
  workflow_dispatch:

# Ex√©cution s√©quentielle pour √©viter conflits sur compte de test
concurrency:
  group: integration-tests
  cancel-in-progress: false

jobs:
  integration-tests:
    name: Tests d'Int√©gration R√©els
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      # Variables Supabase (production)
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      # Compte de test d√©di√©
      INTEGRATION_TEST_PASSWORD: ${{ secrets.INTEGRATION_TEST_PASSWORD }}
      
      # URL de l'application d√©ploy√©e
      BASE_URL: https://julienfritschheydon.github.io/DooDates

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json', 'playwright.config*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: üé≠ Install Playwright browsers
        run: |
          echo "üì¶ Installation de chromium avec d√©pendances syst√®me..."
          npx playwright install --with-deps chromium

      - name: üîç V√©rifier configuration Supabase
        run: |
          echo "üîß Configuration Supabase"
          if [ -z "$VITE_SUPABASE_URL" ]; then
            echo "‚ùå VITE_SUPABASE_URL manquant"
            exit 1
          fi
          if [ -z "$VITE_SUPABASE_ANON_KEY" ]; then
            echo "‚ùå VITE_SUPABASE_ANON_KEY manquant"
            exit 1
          fi
          if [ -z "$INTEGRATION_TEST_PASSWORD" ]; then
            echo "‚ùå INTEGRATION_TEST_PASSWORD manquant"
            exit 1
          fi
          echo "‚úÖ Configuration compl√®te"
          echo "üìç URL: ${VITE_SUPABASE_URL:0:30}..."
          echo "üîë Key: Configured"
          echo "üß™ Test account: test-integration@doodates.com"

      - name: üß™ Run Integration Tests
        run: |
          echo "üöÄ Ex√©cution des tests d'int√©gration r√©els..."
          npx playwright test tests/integration/api-security-performance.spec.ts \
            --project=chromium \
            --reporter=list \
            --max-failures=5
        continue-on-error: true
        id: integration_tests

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            playwright-report/
            test-results/
            test-results.json
          retention-days: 7

      - name: üìà Test Summary
        if: always()
        run: |
          echo "## üìä R√©sultats des Tests d'Int√©gration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** Tests r√©els sur Supabase Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Compte:** test-integration@doodates.com" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** $BASE_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.integration_tests.outcome }}" = "success" ]; then
            echo "### ‚úÖ Tous les tests passent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Le syst√®me Supabase fonctionne correctement :" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Authentification" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ CRUD Conversations" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ RLS (Row Level Security)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Messages" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Quotas" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ RPC Functions" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Des tests ont √©chou√©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è **ATTENTION:** Des probl√®mes d'int√©gration Supabase d√©tect√©s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Actions requises:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Consulter les logs ci-dessus" >> $GITHUB_STEP_SUMMARY
            echo "2. V√©rifier la configuration Supabase" >> $GITHUB_STEP_SUMMARY
            echo "3. Tester manuellement avec le compte de test" >> $GITHUB_STEP_SUMMARY
            echo "4. Corriger les probl√®mes avant merge" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Fail if tests failed
        if: steps.integration_tests.outcome != 'success'
        run: |
          echo "‚ùå Les tests d'int√©gration ont √©chou√©"
          echo "‚ö†Ô∏è Merge bloqu√© jusqu'√† correction"
          exit 1

  # Job de notification si √©chec
  notify-failure:
    name: Notifier √©chec
    runs-on: ubuntu-latest
    needs: integration-tests
    if: failure()
    
    steps:
      - name: üìß Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üî¥ √âchec Tests d\'Int√©gration Supabase',
              body: `## ‚ö†Ô∏è Tests d'int√©gration en √©chec

            **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            ### üîç D√©tails
            Les tests d'int√©gration r√©els sur Supabase ont √©chou√©. Cela indique un probl√®me potentiel avec :
            - L'authentification Supabase
            - Les permissions RLS
            - Les fonctions RPC
            - Les quotas utilisateurs
            - La structure de la base de donn√©es

            ### üö® Actions Imm√©diates
            1. Consulter les logs du workflow
            2. Tester manuellement avec test-integration@doodates.com
            3. V√©rifier la configuration Supabase en production
            4. Corriger le probl√®me AVANT le prochain d√©ploiement

            ### üìö Ressources
            - [Logs du workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Guide des tests](./Docs/TESTS/TESTS-GUIDE.md)
            - [Protection Production](./Docs/TESTS/PROTECTION-PRODUCTION.md)
            `,
              labels: ['bug', 'critical', 'integration-tests']
            });
            
            console.log('Issue cr√©√©e:', issue.data.html_url);

