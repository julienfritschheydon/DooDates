name: üß™ E2E Tests - Bug & Testing Branches

# Workflow d√©di√© pour tester les branches bug et testing
# Ex√©cution rapide avec suite smoke pour validation avant merge

on:
  push:
    branches: [bug, testing]
  pull_request:
    branches: [bug, testing]
  workflow_dispatch:
    inputs:
      test_suite:
        description: "Suite de tests √† ex√©cuter"
        required: false
        type: choice
        default: "smoke"
        options:
          - smoke
          - critical
      branch_name:
        description: "Nom de la branche √† tester (si diff√©rente)"
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ========================================
  # D√âTECTION DE LA BRANCHE
  # ========================================
  detect-branch:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.name }}
      is_bug_branch: ${{ steps.branch.outputs.is_bug }}
      is_testing_branch: ${{ steps.branch.outputs.is_testing }}
      test_suite: ${{ steps.config.outputs.suite }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Detect branch
        id: branch
        run: |
          BRANCH="${{ github.event.inputs.branch_name || github.ref_name }}"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "bug"* ]]; then
            echo "is_bug=true" >> $GITHUB_OUTPUT
            echo "üêõ Branch BUG d√©tect√©e: $BRANCH"
          elif [[ "$BRANCH" == "testing"* ]]; then
            echo "is_testing=true" >> $GITHUB_OUTPUT
            echo "üß™ Branch TESTING d√©tect√©e: $BRANCH"
          else
            echo "‚ö†Ô∏è Branch non reconnue: $BRANCH"
          fi

      - name: ‚öôÔ∏è Configure test suite
        id: config
        run: |
          SUITE="${{ github.event.inputs.test_suite || 'smoke' }}"

          # Branches bug = tests complets (critical)
          # Branches testing = tests rapides (smoke)
          if [[ "${{ steps.branch.outputs.is_bug }}" == "true" ]]; then
            SUITE="critical"
            echo "üêõ Branch BUG ‚Üí Suite CRITICAL (15 min)"
          elif [[ "${{ steps.branch.outputs.is_testing }}" == "true" ]]; then
            SUITE="smoke"
            echo "üß™ Branch TESTING ‚Üí Suite SMOKE (5 min)"
          fi

          echo "suite=$SUITE" >> $GITHUB_OUTPUT

  # ========================================
  # TESTS E2E
  # ========================================
  run-e2e-tests:
    needs: detect-branch
    runs-on: ubuntu-latest
    timeout-minutes: ${{ needs.detect-branch.outputs.test_suite == 'critical' && 20 || 10 }}

    env:
      CI: true
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üîß Install dependencies
        run: npm ci

      - name: üé≠ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ needs.detect-branch.outputs.branch_name }}-${{ hashFiles('package-lock.json', 'playwright.config.*.ts') }}
          restore-keys: |
            ${{ runner.os }}-playwright-
            ${{ runner.os }}-playwright-${{ needs.detect-branch.outputs.branch_name }}-

      - name: üß≠ Install Playwright browsers
        run: |
          if [ "${{ steps.cache-playwright.outputs.cache-hit }}" == "true" ]; then
            echo "‚úÖ Cache hit - installation rapide"
            if [[ "${{ needs.detect-branch.outputs.test_suite }}" == "critical" ]]; then
              npx playwright install chromium firefox --force
            else
              npx playwright install chromium --force
            fi
          else
            echo "‚ö†Ô∏è Cache miss - installation compl√®te"
            if [[ "${{ needs.detect-branch.outputs.test_suite }}" == "critical" ]]; then
              npx playwright install --with-deps chromium firefox
            else
              npx playwright install --with-deps chromium
            fi
          fi

      - name: üèóÔ∏è Build application
        run: npm run build

      - name: üöÄ Start preview server
        run: |
          npx http-server dist -p 4173 --cors &
          sleep 5

      - name: ‚è≥ Wait for application
        run: npx wait-on http://localhost:4173/ --timeout 60000

      - name: üéØ Run ${{ needs.detect-branch.outputs.test_suite }} Tests
        run: |
          echo "üéØ Branch: ${{ needs.detect-branch.outputs.branch_name }}"
          echo "üéØ Suite: ${{ needs.detect-branch.outputs.test_suite }}"

          if [[ "${{ needs.detect-branch.outputs.test_suite }}" == "critical" ]]; then
            echo "üêõ Ex√©cution suite CRITICAL (Chromium + Firefox)"
            npx playwright test \
              --config=playwright.config.critical.ts \
              --project=chromium \
              --reporter=html,json
            npx playwright test \
              --config=playwright.config.critical.ts \
              --project=firefox \
              --reporter=html,json
          else
            echo "üß™ Ex√©cution suite SMOKE (Chromium uniquement)"
            npx playwright test \
              --config=playwright.config.smoke.ts \
              --project=chromium \
              --reporter=html,json
          fi

      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ needs.detect-branch.outputs.branch_name }}-${{ needs.detect-branch.outputs.test_suite }}
          path: |
            playwright-report/
            test-results/
          retention-days: 3

      - name: üì§ Upload screenshots (si √©chec)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ needs.detect-branch.outputs.branch_name }}
          path: test-results/**/*.png
          retention-days: 3

  # ========================================
  # RAPPORT ET NOTIFICATION
  # ========================================
  generate-report:
    needs: [detect-branch, run-e2e-tests]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: üì• Download results
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-results-${{ needs.detect-branch.outputs.branch_name }}-*
          merge-multiple: true
          path: results
        continue-on-error: true

      - name: üìä Generate Branch Report
        run: |
          echo "# üß™ E2E Tests Report - Branch ${{ needs.detect-branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch Type:** ${{ needs.detect-branch.outputs.is_bug_branch == 'true' && 'üêõ Bug Fix' || needs.detect-branch.outputs.is_testing_branch == 'true' && 'üß™ Testing' || 'üîß Other' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ needs.detect-branch.outputs.test_suite }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìä Test Results" >> $GITHUB_STEP_SUMMARY

          if [ -f "results/results.json" ]; then
            PASSED=$(cat results/results.json | jq '.suites | map(select(.status == "passed"))) | length')
            FAILED=$(cat results/results.json | jq '.suites | map(select(.status == "failed"))) | length')
            TOTAL=$((PASSED + FAILED))
            
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| üìä Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## üö® Issues Found" >> $GITHUB_STEP_SUMMARY
              echo "Les tests ont √©chou√©. V√©rifier les artefacts pour d√©tails." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "## ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
              echo "La branche est pr√™te pour merge." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Results file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üè∑Ô∏è Add labels to PR (si applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = [];
            const testResult = '${{ needs.run-e2e-tests.result }}';
            const branchType = '${{ needs.detect-branch.outputs.is_bug_branch }}' === 'true' ? 'bug-fix' : 
                            '${{ needs.detect-branch.outputs.is_testing_branch }}' === 'true' ? 'testing' : 'other';

            if (testResult === 'success') {
              labels.push('tests-passed', branchType, 'ready-for-merge');
            } else {
              labels.push('tests-failed', branchType, 'needs-fixes');
            }

            // Ajouter les labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });

            console.log(`Labels ajout√©s: ${labels.join(', ')}`);

  # ========================================
  # CR√âATION ISSUE SI √âCHEC (BRANCHES BUG UNIQUEMENT)
  # ========================================
  create-issue-on-failure:
    needs: [detect-branch, run-e2e-tests]
    if: failure() && needs.detect-branch.outputs.is_bug_branch == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: üêõ Create Bug Report Issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.detect-branch.outputs.branch_name }}';
            const commitSha = '${{ github.sha }}';
            const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commitSha}`;

            const issueTitle = `üêõ Tests Failed on Branch: ${branchName}`;
            const issueBody = `## üêõ Bug Branch Test Failure\n\n**Branch:** \`${branchName}\`\n**Commit:** ${commitSha}\n**Commit URL:** ${commitUrl}\n**Test Suite:** ${{ needs.detect-branch.outputs.test_suite }}\n\n### üìä Test Results\nLes tests E2E ont √©chou√© sur cette branche de correction de bug.\n\n### üîç Next Steps\n1. V√©rifier les artefacts de test pour les d√©tails\n2. Corriger les probl√®mes identifi√©s\n3. Pousser les corrections sur la branche\n4. Les tests se relanceront automatiquement\n\n### üìã Checklist\n- [ ] Corriger les tests √©chou√©s\n- [ ] V√©rifier la correction localement\n- [ ] Pousser sur la branche \`${branchName}\`\n- [ ] Attendre validation CI\n\n---\n*Issue cr√©√©e automatiquement par le workflow E2E Bug Branch*`;

            try {
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['bug', 'tests-failed', 'automated'],
                assignees: ['${{ github.actor }}']
              });
              
              console.log(`Issue #${issue.number} cr√©√©e pour la branche ${branchName}`);
            } catch (error) {
              console.error('Erreur lors de la cr√©ation de l\'issue:', error);
            }
