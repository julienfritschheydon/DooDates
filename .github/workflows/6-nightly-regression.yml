name: 6Ô∏è‚É£ Nightly Full Regression

on:
  schedule:
    - cron: '0 2 * * *'  # Tous les jours √† 2h du matin (UTC)
  workflow_dispatch:  # Permet ex√©cution manuelle

jobs:
  full-regression:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ['chromium', 'firefox', 'webkit', 'Mobile Chrome', 'Mobile Safari']
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üß≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: üîç Run Full Regression Suite (${{ matrix.project }})
        run: npx playwright test --project="${{ matrix.project }}" --reporter=html,json

      - name: üìä Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nightly-${{ matrix.project }}
          path: playwright-report
          retention-days: 30

      - name: üì§ Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.project }}
          path: test-results
          retention-days: 7

  regression-summary:
    needs: [full-regression]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üîß Install dependencies
        run: npm ci

      - name: üì• Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: üì• Download Playwright reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-nightly-*
          merge-multiple: true
          path: artifacts

      - name: üìä Generate Regression Summary
        id: summary
        run: node scripts/generate-regression-summary.js
        continue-on-error: true

      - name: üìã Display Summary
        run: |
          if [ -f regression-summary.md ]; then
            cat regression-summary.md
          fi

      - name: üì§ Upload Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-summary
          path: regression-summary.md
          retention-days: 30

      - name: üìù Create or Update GitHub Issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let summaryContent = '';
            const summaryPath = path.join(process.cwd(), 'regression-summary.md');
            
            if (fs.existsSync(summaryPath)) {
              summaryContent = fs.readFileSync(summaryPath, 'utf-8');
            } else {
              // Fallback si le fichier n'existe pas
              summaryContent = `# üìä R√©sum√© des Tests de R√©gression Nocturne\n\n`;
              summaryContent += `**Date:** ${new Date().toISOString()}\n\n`;
              summaryContent += `‚ö†Ô∏è Impossible de g√©n√©rer le r√©sum√© complet. V√©rifiez les artefacts pour plus de d√©tails.\n\n`;
              summaryContent += `**Workflow:** ${context.payload.repository.html_url}/actions/runs/${context.runId}\n`;
            }
            
            // Ajouter le lien vers le workflow
            summaryContent += `\n\n---\n\n`;
            summaryContent += `**üîó Lien vers le workflow:** [Voir les d√©tails](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            
            // Chercher une issue existante pour aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `Nightly Regression Tests - ${today}`;
            
            try {
              // Chercher les issues ouvertes avec le label 'regression'
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'regression,automated',
                per_page: 10
              });
              
              // Chercher une issue cr√©√©e aujourd'hui
              const todayIssue = issues.find(issue => 
                issue.title.includes(today) || 
                issue.created_at.startsWith(today)
              );
              
              if (todayIssue) {
                // Mettre √† jour l'issue existante
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: summaryContent
                });
                
                // Ajouter un commentaire avec le nouveau r√©sum√©
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: todayIssue.number,
                  body: `## üîÑ R√©sum√© mis √† jour - ${new Date().toISOString()}\n\n${summaryContent}`
                });
                
                console.log(`‚úÖ Issue #${todayIssue.number} mise √† jour`);
              } else {
                // Cr√©er une nouvelle issue
                const hasFailures = summaryContent.includes('‚ùå Tests √©chou√©s') || 
                                  summaryContent.includes('Erreurs d√©tect√©es');
                
                const { data: issue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: summaryContent,
                  labels: hasFailures ? ['bug', 'regression', 'automated'] : ['regression', 'automated']
                });
                
                console.log(`‚úÖ Issue #${issue.number} cr√©√©e`);
              }
            } catch (error) {
              console.error('‚ùå Erreur lors de la cr√©ation/mise √† jour de l\'issue:', error);
              // Ne pas faire √©chouer le workflow si l'issue √©choue
            }
