# DooDates - Sp√©cifications Techniques Phase 2

**Document cr√©√© le 23 juin 2025**

## Vue d'Ensemble

### Objectif Phase 2
Transformer l'interface frontend actuelle (localStorage) en application compl√®te avec backend Supabase, IA conversationnelle, et syst√®me de vote en temps r√©el.

### Architecture Cible
```
Frontend (React + Vite)
‚îú‚îÄ‚îÄ Interface PollCreator (‚úÖ Termin√©e)
‚îú‚îÄ‚îÄ ChatInterface (üîÑ √Ä connecter avec IA)
‚îú‚îÄ‚îÄ VotingInterface (üÜï √Ä cr√©er)
‚îî‚îÄ‚îÄ Dashboard (üÜï √Ä cr√©er)

Backend (Supabase)
‚îú‚îÄ‚îÄ Database (PostgreSQL + RLS)
‚îú‚îÄ‚îÄ Authentication (Google OAuth + Email)
‚îú‚îÄ‚îÄ Real-time (WebSockets)
‚îî‚îÄ‚îÄ Storage (Files + Images)

IA Conversationnelle (Mistral)
‚îú‚îÄ‚îÄ API Integration
‚îú‚îÄ‚îÄ Function Calling
‚îú‚îÄ‚îÄ Context Management
‚îî‚îÄ‚îÄ Streaming Responses

Services Externes
‚îú‚îÄ‚îÄ Email (Resend/SendGrid)
‚îú‚îÄ‚îÄ Analytics (Supabase Analytics)
‚îî‚îÄ‚îÄ Monitoring (Sentry)
```

---

## Phase 2 : Sp√©cifications D√©taill√©es (8 semaines)

### Semaines 1-2 : Backend Foundation

#### 1.1 Setup Supabase
**Objectif :** Infrastructure backend op√©rationnelle

**Configuration Projet :**
- **Nom projet :** `doodates-prod`
- **R√©gion :** Europe (eu-west-1)
- **Plan :** Pro (25$/mois - n√©cessaire pour RLS avanc√©)
- **Environnements :**
  - `doodates-dev` (d√©veloppement)
  - `doodates-staging` (tests)
  - `doodates-prod` (production)

**S√©curit√© :**
- Row Level Security (RLS) activ√© sur toutes les tables
- Policies restrictives par d√©faut
- API Keys s√©par√©es par environnement
- CORS configur√© pour domaines autoris√©s

#### 1.2 Database Schema
**Objectif :** Structure de donn√©es compl√®te et √©volutive

```sql
-- Users (extends Supabase auth.users)
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  timezone TEXT DEFAULT 'Europe/Paris',
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Polls
CREATE TABLE polls (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  creator_id UUID REFERENCES profiles(id) NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  slug TEXT UNIQUE NOT NULL, -- pour URLs friendly
  settings JSONB DEFAULT '{}', -- config granularit√©, notifications, etc.
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'closed', 'archived')),
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Poll Options (dates s√©lectionn√©es)
CREATE TABLE poll_options (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  poll_id UUID REFERENCES polls(id) ON DELETE CASCADE,
  option_date DATE NOT NULL,
  time_slots JSONB, -- [{hour: 14, minute: 0, duration: 60}, ...]
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Votes
CREATE TABLE votes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  poll_id UUID REFERENCES polls(id) ON DELETE CASCADE,
  voter_email TEXT NOT NULL,
  voter_name TEXT,
  voter_id UUID REFERENCES profiles(id), -- NULL si anonyme
  selections JSONB NOT NULL, -- {option_id: "yes|no|maybe", ...}
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(poll_id, voter_email)
);

-- Messages IA (conversations)
CREATE TABLE conversations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),
  session_id TEXT NOT NULL, -- pour utilisateurs anonymes
  messages JSONB NOT NULL, -- [{role: "user|assistant", content: "...", timestamp}]
  context JSONB DEFAULT '{}', -- donn√©es extraites (dates, participants, etc.)
  poll_id UUID REFERENCES polls(id), -- NULL si pas encore cr√©√©
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Analytics
CREATE TABLE analytics_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  event_type TEXT NOT NULL,
  event_data JSONB NOT NULL,
  user_id UUID REFERENCES profiles(id),
  session_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Indexes :**
```sql
CREATE INDEX idx_polls_creator ON polls(creator_id);
CREATE INDEX idx_polls_slug ON polls(slug);
CREATE INDEX idx_poll_options_poll ON poll_options(poll_id);
CREATE INDEX idx_votes_poll ON votes(poll_id);
CREATE INDEX idx_conversations_user ON conversations(user_id);
CREATE INDEX idx_conversations_session ON conversations(session_id);
CREATE INDEX idx_analytics_type ON analytics_events(event_type);
```

**Row Level Security (RLS) :**
```sql
-- Profiles : utilisateur peut voir/modifier son profil uniquement
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);

-- Polls : cr√©ateur peut tout, autres peuvent voir si actif
ALTER TABLE polls ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Creator can manage polls" ON polls USING (auth.uid() = creator_id);
CREATE POLICY "Anyone can view active polls" ON polls FOR SELECT USING (status = 'active');

-- Poll Options : m√™me logique que polls
ALTER TABLE poll_options ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Poll options follow poll access" ON poll_options FOR SELECT 
  USING (EXISTS (SELECT 1 FROM polls WHERE polls.id = poll_id AND (polls.creator_id = auth.uid() OR polls.status = 'active')));

-- Votes : voter peut voir/modifier ses votes, cr√©ateur peut voir tous les votes
ALTER TABLE votes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Voters can manage own votes" ON votes USING (voter_email = auth.email() OR voter_id = auth.uid());
CREATE POLICY "Poll creators can view all votes" ON votes FOR SELECT 
  USING (EXISTS (SELECT 1 FROM polls WHERE polls.id = poll_id AND polls.creator_id = auth.uid()));

-- Conversations : utilisateur peut voir ses conversations
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own conversations" ON conversations USING (auth.uid() = user_id);
```

#### 1.3 Authentication
**Objectif :** Syst√®me d'auth flexible (connect√© + anonyme)

**Providers configur√©s :**
- **Google OAuth** (priorit√© - 80% des utilisateurs)
- **Email/Password** (backup - 20% des utilisateurs)
- **Anonymous** (pour votes sans inscription)

**Configuration Google OAuth :**
```javascript
// supabase/config.js
const supabaseConfig = {
  auth: {
    providers: {
      google: {
        redirectTo: `${window.location.origin}/auth/callback`
      }
    },
    flowType: 'pkce' // Plus s√©curis√©
  }
}
```

**Flux d'authentification :**
1. **Cr√©ateur de sondage** : Auth obligatoire (Google ou Email)
2. **Votant** : Auth optionnelle (peut voter avec juste email)
3. **Session anonyme** : UUID temporaire pour conversations IA

---

### Semaines 3-4 : IA Conversationnelle

#### 2.1 Mistral AI Integration
**Objectif :** Chat ‚Üí Sondage automatique

**Configuration Mistral :**
- **Mod√®le :** `mistral-large-latest` (meilleur reasoning)
- **Backup :** `mistral-medium` (co√ªt r√©duit)
- **Streaming :** Activ√© pour UX fluide
- **Context window :** 32k tokens (conversations longues)

**Variables d'environnement :**
```env
MISTRAL_API_KEY=your_key_here
MISTRAL_MODEL=mistral-large-latest
MISTRAL_MAX_TOKENS=1000
MISTRAL_TEMPERATURE=0.1
```

#### 2.2 Function Calling
**Objectif :** Conversion automatique langage naturel ‚Üí sondage

**Functions d√©finies :**
```typescript
// ai/functions.ts
export const mistralFunctions = [
  {
    name: "create_poll_draft",
    description: "Cr√©e un brouillon de sondage √† partir des informations extraites",
    parameters: {
      type: "object",
      properties: {
        title: {
          type: "string",
          description: "Titre du sondage g√©n√©r√© automatiquement"
        },
        dates: {
          type: "array",
          items: { type: "string", format: "date" },
          description: "Dates propos√©es extraites de la conversation"
        },
        timeSlots: {
          type: "object",
          description: "Cr√©neaux horaires par date si mentionn√©s"
        },
        participants: {
          type: "array",
          items: { type: "string", format: "email" },
          description: "Emails des participants mentionn√©s"
        },
        context: {
          type: "object",
          description: "Contexte additionnel (lieu, type de r√©union, etc.)"
        }
      },
      required: ["title", "dates"]
    }
  },
  {
    name: "ask_clarification",
    description: "Demande des clarifications √† l'utilisateur",
    parameters: {
      type: "object",
      properties: {
        question: {
          type: "string",
          description: "Question √† poser pour clarifier"
        },
        options: {
          type: "array",
          items: { type: "string" },
          description: "Options sugg√©r√©es si applicable"
        }
      },
      required: ["question"]
    }
  }
];
```

---

### Semaines 5-6 : Features Core

#### 3.1 Interface de Vote
**Objectif :** Interface responsive pour voter sur les sondages

**Composants √† cr√©er :**
```typescript
// components/voting/
‚îú‚îÄ‚îÄ VotingInterface.tsx     // Interface principale
‚îú‚îÄ‚îÄ DateTimeGrid.tsx        // Grille dates/heures
‚îú‚îÄ‚îÄ VoterForm.tsx          // Formulaire votant
‚îú‚îÄ‚îÄ VoteResults.tsx        // R√©sultats temps r√©el
‚îú‚îÄ‚îÄ VoteSummary.tsx        // R√©sum√© final
‚îî‚îÄ‚îÄ VoteActions.tsx        // Actions (partage, export)
```

**√âtats de vote :**
- **Yes** (‚úÖ) : Disponible
- **No** (‚ùå) : Pas disponible  
- **Maybe** (‚ùì) : Peut-√™tre
- **Empty** : Pas encore vot√©

#### 3.2 Real-time avec Supabase
**Objectif :** Synchronisation instantan√©e des votes

```typescript
// hooks/useRealTimeVotes.ts
export function useRealTimeVotes(pollId: string) {
  const [votes, setVotes] = useState<Vote[]>([]);
  
  useEffect(() => {
    const channel = supabase
      .channel(`poll-${pollId}`)
      .on('postgres_changes', 
        { 
          event: '*', 
          schema: 'public', 
          table: 'votes',
          filter: `poll_id=eq.${pollId}`
        }, 
        (payload) => {
          // Mise √† jour temps r√©el des votes
        }
      )
      .subscribe();

    return () => supabase.removeChannel(channel);
  }, [pollId]);

  return votes;
}
```

---

### Semaines 7-8 : Polish & Beta Launch

#### 4.1 Dashboard Utilisateur
**Objectif :** Interface de gestion des sondages

**Sections Dashboard :**
- **Brouillons** : Cr√©√©s mais pas encore envoy√©s
- **Actifs** : En cours de vote
- **Termin√©s** : Vote clos, r√©sultats disponibles
- **Archiv√©s** : Anciens sondages

#### 4.2 Tests E2E
**Objectif :** Validation compl√®te des flux utilisateur

**Sc√©narios de test (Playwright) :**
- Cr√©ation sondage (avec/sans horaires)
- Vote anonyme et connect√©
- Modifications temps r√©el
- Notifications email
- Responsive mobile
- Performance (< 2s chargement)

#### 4.3 Beta Launch
**Objectif :** Lancement avec 50 early adopters

**Strat√©gie de lancement :**
1. **Invitations priv√©es** : 50 contacts cibl√©s
2. **Onboarding guid√©** : Tutorial interactif
3. **Feedback loop** : Formulaire int√©gr√© + analytics
4. **Support r√©actif** : Discord/email pour bugs
5. **It√©rations rapides** : Hotfixes sous 24h

---

## Livrables Phase 2

### Fin Semaine 2
- ‚úÖ Supabase configur√© (dev/staging/prod)
- ‚úÖ Database schema d√©ploy√© avec RLS
- ‚úÖ Authentication Google + Email fonctionnelle
- ‚úÖ API routes basiques document√©es

### Fin Semaine 4  
- ‚úÖ IA conversationnelle op√©rationnelle
- ‚úÖ Function calling pour cr√©ation automatique
- ‚úÖ Context management et m√©moire
- ‚úÖ Integration frontend ‚Üî Mistral

### Fin Semaine 6
- ‚úÖ Interface de vote responsive
- ‚úÖ Real-time synchronisation votes
- ‚úÖ Email notifications automatiques
- ‚úÖ Dashboard utilisateur basique

### Fin Semaine 8
- ‚úÖ Tests E2E complets et passants
- ‚úÖ Performance optimis√©e (< 2s)
- ‚úÖ PWA installable
- ‚úÖ 50 beta testeurs onboard√©s
- ‚úÖ Feedback loop op√©rationnel

---

**Document cr√©√© le 23 juin 2025**  
**Status :** Sp√©cifications d√©taill√©es Phase 2  
**Prochaine √©tape :** Validation specs + d√©marrage d√©veloppement
