# DooDates - SpÃ©cifications Techniques Phase 2

**Document crÃ©Ã© le 23 juin 2025**

## Vue d'Ensemble

### Objectif Phase 2
Transformer l'interface frontend actuelle (localStorage) en application mobile-native avec backend Supabase et interface de vote rÃ©volutionnaire.

### Architecture Cible - Mobile-First
```
Frontend Mobile-Native (React + Vite)
â”œâ”€â”€ Interface PollCreator (âœ… TerminÃ©e Mobile)
â”œâ”€â”€ VotingInterface (ðŸŽ¯ PRIORITÃ‰ - Mobile RÃ©volutionnaire)
â”œâ”€â”€ Dashboard Mobile (ðŸ†• Ã€ crÃ©er)
â””â”€â”€ PWA Features (ðŸ†• Installable + Offline)

Backend (Supabase Mobile-Optimized)
â”œâ”€â”€ Database (PostgreSQL + RLS Mobile)
â”œâ”€â”€ Authentication (Google OAuth Mobile)
â”œâ”€â”€ IA Conversationnelle (OpenAI GPT-4)
â””â”€â”€ Push Notifications (PWA)

Interface de Vote Mobile (PRIORITÃ‰ #2)
â”œâ”€â”€ Touch Gestures AvancÃ©es
â”œâ”€â”€ Haptic Feedback
â”œâ”€â”€ Micro-animations
â””â”€â”€ Synchronisation Automatique

IA Conversationnelle (PRIORITÃ‰ #4)
â”œâ”€â”€ OpenAI GPT-4 Integration
â”œâ”€â”€ Parser Langage Naturel
â”œâ”€â”€ Interface Chat Mobile
â””â”€â”€ Fallback CrÃ©ation Manuelle

Services Externes
â”œâ”€â”€ Push Notifications (PWA)
â”œâ”€â”€ Analytics Mobile (Supabase)
â””â”€â”€ Monitoring (Sentry Mobile)
```

---

## Phase 2 : SpÃ©cifications DÃ©taillÃ©es (8 semaines)

### Semaines 1-2 : Backend Foundation

#### 1.1 Setup Supabase
**Objectif :** Infrastructure backend opÃ©rationnelle

**Configuration Projet :**
- **Nom projet :** `doodates-prod`
- **RÃ©gion :** Europe (eu-west-1)
- **Plan :** Pro (25$/mois - nÃ©cessaire pour RLS avancÃ©)
- **Environnements :**
  - `doodates-dev` (dÃ©veloppement)
  - `doodates-staging` (tests)
  - `doodates-prod` (production)

**SÃ©curitÃ© :**
- Row Level Security (RLS) activÃ© sur toutes les tables
- Policies restrictives par dÃ©faut
- API Keys sÃ©parÃ©es par environnement
- CORS configurÃ© pour domaines autorisÃ©s

#### 1.2 Database Schema
**Objectif :** Structure de donnÃ©es complÃ¨te et Ã©volutive

```sql
-- Users (extends Supabase auth.users)
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  timezone TEXT DEFAULT 'Europe/Paris',
  preferences JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Polls
CREATE TABLE polls (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  creator_id UUID REFERENCES profiles(id) NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  slug TEXT UNIQUE NOT NULL, -- pour URLs friendly
  settings JSONB DEFAULT '{}', -- config granularitÃ©, notifications, etc.
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'closed', 'archived')),
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Poll Options (dates sÃ©lectionnÃ©es)
CREATE TABLE poll_options (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  poll_id UUID REFERENCES polls(id) ON DELETE CASCADE,
  option_date DATE NOT NULL,
  time_slots JSONB, -- [{hour: 14, minute: 0, duration: 60}, ...]
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Votes
CREATE TABLE votes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  poll_id UUID REFERENCES polls(id) ON DELETE CASCADE,
  voter_email TEXT NOT NULL,
  voter_name TEXT,
  voter_id UUID REFERENCES profiles(id), -- NULL si anonyme
  selections JSONB NOT NULL, -- {option_id: "yes|no|maybe", ...}
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(poll_id, voter_email)
);

-- Messages IA (conversations)
CREATE TABLE conversations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),
  session_id TEXT NOT NULL, -- pour utilisateurs anonymes
  messages JSONB NOT NULL, -- [{role: "user|assistant", content: "...", timestamp}]
  context JSONB DEFAULT '{}', -- donnÃ©es extraites (dates, participants, etc.)
  poll_id UUID REFERENCES polls(id), -- NULL si pas encore crÃ©Ã©
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Analytics
CREATE TABLE analytics_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  event_type TEXT NOT NULL,
  event_data JSONB NOT NULL,
  user_id UUID REFERENCES profiles(id),
  session_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Indexes :**
```sql
CREATE INDEX idx_polls_creator ON polls(creator_id);
CREATE INDEX idx_polls_slug ON polls(slug);
CREATE INDEX idx_poll_options_poll ON poll_options(poll_id);
CREATE INDEX idx_votes_poll ON votes(poll_id);
CREATE INDEX idx_conversations_user ON conversations(user_id);
CREATE INDEX idx_conversations_session ON conversations(session_id);
CREATE INDEX idx_analytics_type ON analytics_events(event_type);
```

**Row Level Security (RLS) :**
```sql
-- Profiles : utilisateur peut voir/modifier son profil uniquement
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);

-- Polls : crÃ©ateur peut tout, autres peuvent voir si actif
ALTER TABLE polls ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Creator can manage polls" ON polls USING (auth.uid() = creator_id);
CREATE POLICY "Anyone can view active polls" ON polls FOR SELECT USING (status = 'active');

-- Poll Options : mÃªme logique que polls
ALTER TABLE poll_options ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Poll options follow poll access" ON poll_options FOR SELECT 
  USING (EXISTS (SELECT 1 FROM polls WHERE polls.id = poll_id AND (polls.creator_id = auth.uid() OR polls.status = 'active')));

-- Votes : voter peut voir/modifier ses votes, crÃ©ateur peut voir tous les votes
ALTER TABLE votes ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Voters can manage own votes" ON votes USING (voter_email = auth.email() OR voter_id = auth.uid());
CREATE POLICY "Poll creators can view all votes" ON votes FOR SELECT 
  USING (EXISTS (SELECT 1 FROM polls WHERE polls.id = poll_id AND polls.creator_id = auth.uid()));

-- Conversations : utilisateur peut voir ses conversations
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own conversations" ON conversations USING (auth.uid() = user_id);
```

#### 1.3 Authentication
**Objectif :** SystÃ¨me d'auth flexible (connectÃ© + anonyme)

**Providers configurÃ©s :**
- **Google OAuth** (prioritÃ© - 80% des utilisateurs)
- **Email/Password** (backup - 20% des utilisateurs)
- **Anonymous** (pour votes sans inscription)

**Configuration Google OAuth :**
```javascript
// supabase/config.js
const supabaseConfig = {
  auth: {
    providers: {
      google: {
        redirectTo: `${window.location.origin}/auth/callback`
      }
    },
    flowType: 'pkce' // Plus sÃ©curisÃ©
  }
}
```

**Flux d'authentification :**
1. **CrÃ©ateur de sondage** : Auth obligatoire (Google ou Email)
2. **Votant** : Auth optionnelle (peut voter avec juste email)
3. **Session anonyme** : UUID temporaire pour conversations IA

---

### Semaines 3-4 : Interface de Vote Mobile + IA Basique

#### 2.1 OpenAI Integration (NOUVELLE PRIORITÃ‰)
**Objectif :** Chat â†’ Sondage automatique

**Configuration OpenAI :**
- **ModÃ¨le :** `gpt-4-turbo` (meilleur reasoning)
- **Backup :** `gpt-3.5-turbo` (coÃ»t rÃ©duit)
- **Streaming :** ActivÃ© pour UX fluide
- **Context window :** 128k tokens (conversations longues)

**Variables d'environnement :**
```env
OPENAI_API_KEY=your_key_here
OPENAI_MODEL=gpt-4-turbo
OPENAI_MAX_TOKENS=1000
OPENAI_TEMPERATURE=0.1
```

#### 2.2 Interface de Vote Mobile
**Objectif :** Interface de vote mobile-native rÃ©volutionnaire

**Composants Vote Mobile :**
```typescript
// components/voting/mobile/
â”œâ”€â”€ VotingInterfaceTouch.tsx    // Interface tactile
â”œâ”€â”€ GesturesHandler.tsx         // Gestures avancÃ©es
â”œâ”€â”€ HapticFeedback.tsx         // Retour haptique
â””â”€â”€ VoteAnimations.tsx         // Micro-animations
```

#### 2.3 Function Calling IA Basique
**Objectif :** Conversion automatique langage naturel â†’ sondage

**Functions dÃ©finies :**
```typescript
// ai/functions.ts
export const openAIFunctions = [
  {
    name: "create_poll_draft",
    description: "CrÃ©e un brouillon de sondage Ã  partir des informations extraites",
    parameters: {
      type: "object",
      properties: {
        title: {
          type: "string",
          description: "Titre du sondage gÃ©nÃ©rÃ© automatiquement"
        },
        dates: {
          type: "array",
          items: { type: "string", format: "date" },
          description: "Dates proposÃ©es extraites de la conversation"
        },
        timeSlots: {
          type: "object",
          description: "CrÃ©neaux horaires par date si mentionnÃ©s"
        },
        participants: {
          type: "array",
          items: { type: "string", format: "email" },
          description: "Emails des participants mentionnÃ©s"
        },
        context: {
          type: "object",
          description: "Contexte additionnel (lieu, type de rÃ©union, etc.)"
        }
      },
      required: ["title", "dates"]
    }
  },
  {
    name: "ask_clarification",
    description: "Demande des clarifications Ã  l'utilisateur",
    parameters: {
      type: "object",
      properties: {
        question: {
          type: "string",
          description: "Question Ã  poser pour clarifier"
        },
        options: {
          type: "array",
          items: { type: "string" },
          description: "Options suggÃ©rÃ©es si applicable"
        }
      },
      required: ["question"]
    }
  }
];
```

---

### Semaines 5-6 : Dashboard & IA AvancÃ©e

#### 3.1 Dashboard Mobile
**Objectif :** Interface de gestion mobile-optimisÃ©e

**Composants Dashboard :**
```typescript
// components/dashboard/mobile/
â”œâ”€â”€ DashboardMobile.tsx     // Interface principale
â”œâ”€â”€ PollsListMobile.tsx     // Liste sondages tactile
â”œâ”€â”€ QuickActions.tsx        // Actions rapides
â”œâ”€â”€ StatsWidgets.tsx        // Statistiques visuelles
â””â”€â”€ MobileNavigation.tsx    // Navigation mobile
```

#### 3.2 IA Conversationnelle AvancÃ©e
**Objectif :** IA complÃ¨te avec parsing avancÃ©

**FonctionnalitÃ©s IA avancÃ©es :**
```typescript
// ai/advanced/
â”œâ”€â”€ ContextManager.ts       // Gestion contexte conversation
â”œâ”€â”€ DateTimeParser.ts       // Parsing dates/heures NLP
â”œâ”€â”€ SmartSuggestions.ts     // Suggestions intelligentes
â”œâ”€â”€ LearningEngine.ts       // Apprentissage prÃ©fÃ©rences
â””â”€â”€ ConversationFlow.ts     // Flow conversation optimisÃ©
```

**Parsing avancÃ© :**
- "mercredi prochain" â†’ date exacte
- "15h-17h" â†’ crÃ©neaux horaires
- "Paul et Marie" â†’ participants
- "rÃ©union Ã©quipe" â†’ contexte mÃ©tier
```

---

### Semaines 7-8 : Polish & Beta Launch

#### 4.1 Dashboard Utilisateur
**Objectif :** Interface de gestion des sondages

**Sections Dashboard :**
- **Brouillons** : CrÃ©Ã©s mais pas encore envoyÃ©s
- **Actifs** : En cours de vote
- **TerminÃ©s** : Vote clos, rÃ©sultats disponibles
- **ArchivÃ©s** : Anciens sondages

#### 4.2 Tests E2E
**Objectif :** Validation complÃ¨te des flux utilisateur

**ScÃ©narios de test (Playwright) :**
- CrÃ©ation sondage (avec/sans horaires)
- Vote anonyme et connectÃ©
- Modifications temps rÃ©el
- Notifications email
- Responsive mobile
- Performance (< 2s chargement)

#### 4.3 Beta Launch
**Objectif :** Lancement avec 50 early adopters

**StratÃ©gie de lancement :**
1. **Invitations privÃ©es** : 50 contacts ciblÃ©s
2. **Onboarding guidÃ©** : Tutorial interactif
3. **Feedback loop** : Formulaire intÃ©grÃ© + analytics
4. **Support rÃ©actif** : Discord/email pour bugs
5. **ItÃ©rations rapides** : Hotfixes sous 24h

---

## Livrables Phase 2

### Fin Semaine 2
- âœ… Supabase configurÃ© (dev/staging/prod)
- âœ… Database schema dÃ©ployÃ© avec RLS
- âœ… Authentication Google + Email fonctionnelle
- âœ… API routes basiques documentÃ©es

### Fin Semaine 4  
- âœ… Interface de vote mobile rÃ©volutionnaire
- âœ… IA conversationnelle basique opÃ©rationnelle
- âœ… Function calling pour crÃ©ation automatique
- âœ… Integration frontend â†” OpenAI

### Fin Semaine 6
- âœ… Dashboard mobile complet
- âœ… IA conversationnelle avancÃ©e
- âœ… Parsing dates/heures intelligent
- âœ… Apprentissage prÃ©fÃ©rences utilisateur

### Fin Semaine 8
- âœ… Tests E2E complets et passants
- âœ… Performance optimisÃ©e (< 2s)
- âœ… PWA installable
- âœ… 50 beta testeurs onboardÃ©s
- âœ… Feedback loop opÃ©rationnel

---

**Document crÃ©Ã© le 23 juin 2025**  
**Status :** SpÃ©cifications dÃ©taillÃ©es Phase 2  
**Prochaine Ã©tape :** Validation specs + dÃ©marrage dÃ©veloppement
