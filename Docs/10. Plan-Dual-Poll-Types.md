# DooDates – Évolution "Sondage Dates" OU "Formulaire/Questions"

## État d'avancement

- __Fait__
  - E2E Playwright: parcours minimal FormPoll « création (titre + 1 question) → réponse → résultats » passe en CI/local.
  - UX FormEditor: à l’ajout, la nouvelle question est activée automatiquement et le champ « Intitulé de la question » est focalisé.

- __À faire (prochaines étapes)__

  - __Priorité 1 — Bloquants MVP FormPoll__
    - E2E Playwright: vérifier non-régression DatePoll (scénario existant).
    - E2E Playwright (détails restants):
      - Création FormPoll (titre + 3 questions), navigation `Q1..Qn`, sauvegarde, finalisation
      - Réponse (required + maxChoices), soumission
      - Résultats lisibles (agrégations simples)
    - Accessibilité (éditeur + vote): focus management, `aria-describedby`/`aria-live`, labels explicites.
    - Vote / Réponse — CTA “Envoyer mes réponses” (vérifier présence et cohérence UX).

  - __Priorité 2 — Qualité et UX mobile__
    - Densité mobile et QA multi-breakpoints sur l’éditeur de questions.
    - Accessibilité éditeur: focus management, ARIA live regions, tab order.
    - Performance: rendre uniquement la question active (déjà fait) + préparer la virtualisation si > 20 questions.
    - Histogrammes résultats FormPoll (mini barres) + pagination légère pour texte.
    - Analytics: taux de complétion, erreurs validation.
    - Documentation: capter les conventions UI dans `Docs/DooDates-UX-Flow.md` et README.

  - __Priorité 3 — Gouvernance et robustesse__
    - Feature flag `enableFormPoll`: gouvernance et bascule progressive.
    - Anti-doublons avancé (empreinte locale optionnelle, seuil anti double-submit).
    - Virtualisation si > 20 questions, debouncing autosave.
    - Reordering/Duplication robustes avec conservation du focus.
    - Partage: Même composant que DatePoll (lien, copier, envoyer email plus tard).

  - __Hors scope MVP (plus tard)__
    - Logique conditionnelle entre questions (branching).
    - Pages longues type Typeform.
    - Scoring, quotas.
    - Fichiers uploadés.
    - Auth forcée des répondants.


  
## 3) Modèle de domaine unifié (LATER)

- __Types principaux__
  - Poll { id, type, title, createdAt, ... }
  - For type `date`: options = Date + TimeSlots
  - For type `form`: questions[]
    - Question { id, kind: single|multiple|text, title, required, options?, maxChoices? }
  - Response { pollId, respondentName?, items[] }
    - ResponseItem { questionId|dateSlotId, value }

- __Règles__
  - Validation côté client pour types single/multiple (maxChoices) et required
  - Type-safety via TypeScript unions discriminants pour `kind`


## 4) Schéma DB (Supabase) et parité localStorage (LATER, sans migration)

- __Tables (proposition)__
  - polls(id, type, title, slug, created_at, ...)
  - date_options(poll_id, date)
  - time_slots(poll_id, date_option_id, start, end)
  - questions(poll_id, question_id, kind, title, required, max_choices)
  - question_options(poll_id, question_id, option_id, label)
  - responses(id, poll_id, respondent_name, created_at)
  - response_items(response_id, question_id?, date_option_id?, time_slot_id?, value_text?, option_id?)

- __Local dev__
  - Structure JSON miroir pour `dev-polls` dans localStorage afin de tester sans Supabase.
  - Migration legacy: les anciens brouillons de formulaires stockés sous `dev-form-polls` sont migrés automatiquement vers `dev-polls` à la lecture (voir `migrateFormDraftsIntoUnified()` interne à `src/lib/pollStorage.ts`). La clé legacy est nettoyée après fusion.

## 4.b) Stockage unifié & APIs (DEV)

- __Clé unique__
  - `dev-polls`: contient une liste de `Poll` où `poll.type` discrimine `"date"` ou `"form"`.

- __Helpers (`src/lib/pollStorage.ts`)__
  - `getAllPolls()` retourne la liste unifiée après migration; valide chaque entrée selon son type.
  - `getPolls()` retourne uniquement les sondages de type date (compat ascendante UI existante).
  - `addPoll(poll)` valide par type puis ajoute à l’unifié.
  - `deletePollById(id)`, `duplicatePoll(poll)`, `getPollBySlugOrId(key)`, `savePolls(polls)`, `buildPublicLink(slug)`, `copyToClipboard(text)`.

- __Validation__
  - Type `date`: `settings.selectedDates` doit être un tableau non vide de chaînes.
  - Type `form`: `title` non vide; `questions` libre (MVP). Des validations supplémentaires seront ajoutées avec le moteur de questions.

- __Comportements UI clés__
  - Dashboard consomme `getAllPolls()` pour lister tous les sondages.
  - Création Date poll (dev) pose `type: "date"` dans les objets persistés localement.
  - Création Form poll (dev) persiste les brouillons et finalisations via la liste unifiée avec `type: "form"`.


## 5) Impact API & composants (LATER)

- __Front__
  - `src/components/polls/`: créateur FormPoll (questions); persistance via stockage unifié.
  - `src/components/Dashboard.tsx`: liste l’unifié via `getAllPolls()` (plus de lecture `dev-form-polls`).
  - `src/components/voting/`: rendu FormPoll (single/multiple/text).
  - `src/hooks/usePolls.ts`: en dev, les créations locales de Date poll posent `type: 'date'`.
  - `src/pages/Results.tsx`: afficher aggrégations FormPoll.
  - Feature flag léger: `enableFormPoll` pour gating UI.

- __Tests existants__
  - Vérifier `data-testid` sur nouveaux composants

- __Unit (ajout)__
  - `src/lib/__tests__/pollStorage.test.ts` couvre `getAllPolls()`, la migration `dev-form-polls` -> `dev-polls`, et la validation minimale des FormPolls.
