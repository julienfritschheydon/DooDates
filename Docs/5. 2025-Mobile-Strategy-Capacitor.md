# DooDates - Stratégie Mobile avec Capacitor

## Vue d'ensemble

**Objectif :** Transformer l'application web DooDates en application Android native en réutilisant 100% du code React existant via Capacitor.

**Principe :** Un seul codebase pour web, PWA et mobile natif.

---

## 1. Architecture Technique

### 1.1 Stack Technologique
```
DooDates React App (existant)
├── Web → Vercel (production)
├── PWA → Service Worker (existant)
└── Mobile → Capacitor → Android APK
```

### 1.2 Avantages Capacitor
- **Réutilisation complète** du code React/TypeScript existant
- **Maintenance unifiée** : un bug fixé = fixé partout
- **APIs natives** : notifications, appareil photo, contacts
- **Performance** : WebView optimisé avec accès natif
- **Déploiement rapide** : 1-2 semaines vs 2-3 mois Flutter

---

## 2. Plan d'Implémentation

### Phase 1 : Setup Initial (Semaine 1)

#### 2.1 Installation Capacitor
```bash
# Installation des dépendances
npm install @capacitor/core @capacitor/cli @capacitor/android

# Configuration projet
npx cap init DooDates app.doodates.com
npx cap add android

# Premier build
npm run build
npx cap copy
npx cap open android
```

#### 2.2 Configuration Android
```typescript
// capacitor.config.ts
import { CapacitorConfig } from '@capacitor/cli';

const config: CapacitorConfig = {
  appId: 'app.doodates.com',
  appName: 'DooDates',
  webDir: 'dist',
  server: {
    androidScheme: 'https'
  },
  plugins: {
    SplashScreen: {
      launchShowDuration: 2000,
      backgroundColor: "#3b82f6",
      showSpinner: false
    },
    PushNotifications: {
      presentationOptions: ["badge", "sound", "alert"]
    }
  }
};

export default config;
```

### Phase 2 : Optimisations Mobile (Semaine 2)

#### 2.1 Adaptations UI Spécifiques
```typescript
// hooks/useCapacitor.ts
import { Capacitor } from '@capacitor/core';

export const useCapacitor = () => {
  const isNative = Capacitor.isNativePlatform();
  const platform = Capacitor.getPlatform();
  
  return {
    isNative,
    isAndroid: platform === 'android',
    isIOS: platform === 'ios',
    isWeb: platform === 'web'
  };
};

// Adaptations conditionnelles
const { isNative } = useCapacitor();

return (
  <div className={`
    ${isNative ? 'pt-safe-area-top pb-safe-area-bottom' : ''}
    ${isNative ? 'select-none' : ''}
  `}>
    {/* Interface adaptée */}
  </div>
);
```

#### 2.2 APIs Natives Intégrées
```typescript
// services/native.ts
import { Camera, CameraResultType } from '@capacitor/camera';
import { LocalNotifications } from '@capacitor/local-notifications';
import { Share } from '@capacitor/share';

export class NativeService {
  // Partage natif
  static async shareUrl(url: string, title: string) {
    if (Capacitor.isNativePlatform()) {
      await Share.share({
        title,
        url,
        dialogTitle: 'Partager le sondage'
      });
    } else {
      // Fallback web
      navigator.share({ title, url });
    }
  }

  // Notifications locales
  static async scheduleNotification(poll: Poll) {
    await LocalNotifications.schedule({
      notifications: [{
        title: 'Rappel sondage',
        body: `N'oubliez pas de voter pour "${poll.title}"`,
        id: poll.id,
        schedule: { at: new Date(poll.reminder_date) }
      }]
    });
  }
}
```

### Phase 3 : Fonctionnalités Avancées (Semaine 3-4)

#### 3.1 Notifications Push
```typescript
// services/pushNotifications.ts
import { PushNotifications } from '@capacitor/push-notifications';

export class PushService {
  static async initialize() {
    // Demande permission
    const permission = await PushNotifications.requestPermissions();
    
    if (permission.receive === 'granted') {
      await PushNotifications.register();
    }

    // Écoute des tokens
    PushNotifications.addListener('registration', (token) => {
      // Envoyer token à Supabase
      this.saveTokenToSupabase(token.value);
    });

    // Gestion réception notifications
    PushNotifications.addListener('pushNotificationReceived', (notification) => {
      // Affichage notification in-app
      toast.success(notification.body);
    });
  }
}
```

#### 3.2 Intégration Calendrier Natif
```typescript
// services/calendar.ts
import { Calendar } from '@capacitor-community/calendar';

export class CalendarService {
  static async addPollToCalendar(poll: Poll, selectedSlot: TimeSlot) {
    if (Capacitor.isNativePlatform()) {
      await Calendar.createEvent({
        title: poll.title,
        location: poll.location || '',
        startDate: selectedSlot.start,
        endDate: selectedSlot.end,
        notes: `Créé via DooDates: ${poll.url}`
      });
    }
  }
}
```

---

## 3. Workflow de Développement

### 3.1 Structure Projet
```
DooDates/
├── src/                    # Code React (inchangé)
├── dist/                   # Build web
├── android/                # Projet Android généré
├── capacitor.config.ts     # Configuration Capacitor
└── package.json           # Dépendances mises à jour
```

### 3.2 Scripts NPM
```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:android": "npm run build && npx cap copy android",
    "android:dev": "npx cap run android",
    "android:build": "npx cap build android",
    "android:open": "npx cap open android"
  }
}
```

### 3.3 Workflow GitHub Actions
```yaml
# .github/workflows/android-build.yml
name: Android Build
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - uses: actions/setup-java@v3
        with:
          java-version: '17'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app
        run: npm run build
      
      - name: Build Android
        run: |
          npx cap copy android
          npx cap build android --prod
      
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release.apk
          path: android/app/build/outputs/apk/release/
```

---

## 4. Optimisations Spécifiques

### 4.1 Performance Mobile
```typescript
// Lazy loading adaptatif
const PollCreator = lazy(() => 
  import('./components/PollCreator').then(module => ({
    default: module.PollCreator
  }))
);

// Gestion mémoire
useEffect(() => {
  if (Capacitor.isNativePlatform()) {
    // Nettoyage agressif sur mobile
    return () => {
      // Cleanup listeners
    };
  }
}, []);
```

### 4.2 Gestion Offline
```typescript
// services/offline.ts
export class OfflineService {
  static async saveDraft(poll: PollDraft) {
    if (Capacitor.isNativePlatform()) {
      // Utilise SQLite natif
      await CapacitorSQLite.executeSet({
        database: 'doodates',
        set: [{
          statement: 'INSERT INTO drafts VALUES (?, ?)',
          values: [poll.id, JSON.stringify(poll)]
        }]
      });
    } else {
      // Fallback localStorage
      localStorage.setItem(`draft_${poll.id}`, JSON.stringify(poll));
    }
  }
}
```

---

## 5. Timeline et Ressources

### 5.1 Planning Détaillé
- **Jour 1-2** : Installation + premier build Android
- **Jour 3-5** : Tests + adaptations UI mobile
- **Semaine 2** : APIs natives + notifications
- **Semaine 3** : Optimisations + tests
- **Semaine 4** : Soumission Play Store

### 5.2 Ressources Nécessaires
- **Android Studio** : Pour build et debug
- **Compte Google Play** : 25$ one-time fee
- **Certificat de signature** : Génération automatique
- **Device Android** : Pour tests réels

### 5.3 Maintenance
- **Builds automatiques** : GitHub Actions
- **Tests** : Même suite que web + tests natifs
- **Déploiement** : Play Store via fastlane

---

## 6. Avantages Concurrentiels

### 6.1 vs Doodle/Framadate
- **App native** : Doodle n'a qu'une PWA basique
- **Notifications push** : Rappels automatiques
- **Intégration calendrier** : Ajout direct des événements
- **Offline** : Création brouillons hors ligne

### 6.2 Métriques Attendues
- **Engagement** : +40% vs web (notifications)
- **Rétention** : +25% (app installée)
- **Conversion** : +15% (UX native)
- **Temps de développement** : 4 semaines vs 12 semaines Flutter

---

## 7. Risques et Mitigation

### 7.1 Risques Identifiés
- **Performance WebView** : Tests sur devices bas de gamme
- **Taille APK** : Optimisation bundle (tree-shaking)
- **APIs manquantes** : Plugins communauté disponibles

### 7.2 Plan B
- Si problèmes majeurs Capacitor → Migration Flutter
- Code React reste utilisable comme référence UI
- Base Supabase compatible Flutter

---

## Conclusion

Capacitor offre le meilleur compromis pour DooDates :
- **Rapidité** : App Android en 1 mois
- **Maintenance** : Codebase unique
- **Fonctionnalités** : APIs natives complètes
- **Évolutivité** : Migration Flutter possible

**Prochaine étape :** Installation Capacitor et premier build Android.
