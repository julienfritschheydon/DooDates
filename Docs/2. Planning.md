# DooDates - Planning de Développement 

### A VOIR

## Prochaine étape
- **Interface chat améliorée**
  - Création de questionnaire par IA
  - Modification possible
  - Historique conversations
- **Exporter** → CSV/PDF des résultats
- **PWA Features** : Installable, notifications push, offline
### IA conversationnelle avancée
**Objectif :** IA complète avec parsing avancé

**Fonctionnalités IA avancées :**
```typescript
// ai/advanced/
├── ContextManager.ts       // Gestion contexte conversation
├── DateTimeParser.ts       // Parsing dates/heures NLP
├── SmartSuggestions.ts     // Suggestions intelligentes
├── LearningEngine.ts       // Apprentissage préférences
└── ConversationFlow.ts     // Flow conversation optimisé
```
**Parsing avancé :**
- "mercredi prochain" → date exacte
- "15h-17h" → créneaux horaires
- "Paul et Marie" → participants
- "réunion équipe" → contexte métier

## Backlog
- **Flux avec emails**
- **Templates d'emails professionnels** : Création, vote confirmation, notifications
- **Analytics** : Métriques usage + performance
- **Système de Paiement**
### Connexion Calendrier (Optionnelle et Discrète)
- **Proposition automatique** après sélection des dates
- **Lien direct** : "Connecter votre calendrier (optionnel)" cliquable
- **Fermeture discrète** : Croix pour masquer cette section
- **Interface minimaliste** : Une seule ligne avec lien et bouton fermer
- **Complètement optionnel** : peut être ignoré ou fermé
### Supabase
- **Supabase Integration** : Remplacement localStorage par vraie DB mobile-optimisée
    - **Configuration Projet :**
      - **Nom projet :** `doodates-prod`
      - **Région :** Europe (eu-west-1)
      - **Plan :** Pro (25$/mois - nécessaire pour RLS avancé)
      - **Environnements :**
        - `doodates-dev` (développement)
        - `doodates-staging` (tests)
        - `doodates-prod` (production)
- **Authentication** : Google OAuth + email/password mobile-friendly
- **API Routes** : CRUD optimisé pour mobile
- **Sécurité :**
- Row Level Security (RLS) activé sur toutes les tables
- Policies restrictives par défaut
- API Keys séparées par environnement
- CORS configuré pour domaines autorisés
- **Beta Launch** : 50+ early adopters focus mobile

### Authentication
**Objectif :** Système d'auth flexible (connecté + anonyme)
**Providers configurés :**
- **Google OAuth** (priorité - 80% des utilisateurs)
- **Email/Password** (backup - 20% des utilisateurs)
- **Anonymous** (pour votes sans inscription)
**Flux d'authentification :**
1. **Créateur de sondage** : Auth obligatoire (Google ou Email)
2. **Votant** : Auth optionnelle (peut voter avec juste email)
3. **Session anonyme** : UUID temporaire pour conversations IA

## Application mobile native (Capacitor)

### Setup Capacitor (Semaine 9)
**Objectif :** Transformer l'app web en application Android native

### APIs natives 
**Objectif :** Intégration fonctionnalités natives Android
**Services natifs implémentés :**
- Système de notifications push complet

## Polish & Beta Launch 
**1. Achat et Configuration du Nom de Domaine**
**2. Hébergement et Déploiement**
**3. Configuration Email & DNS**
**4. Configuration Base de Données Production**
**5. Sécurité et Performance**
**6. Tests de Production**
**7. Configuration Domaines et Redirections**
**8. Mise en Production**

## Plan Dual Poll Types (Dates vs Formulaire)

### État d'avancement

- __En cours__
    - [stabilize-selectors] Audit complémentaire pour généraliser `data-testid` (tous écrans/flows).
    - Consolidation E2E « Ultra Simple » (réduction flakiness, helpers robustClick/warmup, garde console).

- __À faire (prochaines étapes)__

  - __Priorité 1 — Bloquants MVP FormPoll__

    - Accessibilité (éditeur + vote): focus management, `aria-describedby`/`aria-live`, labels explicites.

  - __Priorité 2 — Qualité et UX mobile__
    - Performance: rendre uniquement la question active (déjà fait) + préparer la virtualisation si > 20 questions.
    - Histogrammes résultats FormPoll (mini barres) + pagination légère pour texte.
    - Analytics: taux de complétion, erreurs validation.
    - Documentation: capter les conventions UI dans `Docs/DooDates-UX-Flow.md` et README.

  - __Priorité 3 — Gouvernance et robustesse__
    - Feature flag `enableFormPoll`: gouvernance et bascule progressive.
    - Anti-doublons avancé (empreinte locale optionnelle, seuil anti double-submit).
    - Virtualisation si > 20 questions, debouncing autosave.
    - Reordering/Duplication robustes avec conservation du focus.
    - Partage: Même composant que DatePoll (lien, copier, envoyer email plus tard).

  - __Hors scope MVP (plus tard)__
    - Logique conditionnelle entre questions (branching).
    - Pages longues type Typeform.
    - Scoring, quotas.
    - Fichiers uploadés.
    - Auth forcée des répondants.

### 3) Modèle de domaine unifié (LATER)

- __Types principaux__
  - Poll { id, type, title, createdAt, ... }
  - For type `date`: options = Date + TimeSlots
  - For type `form`: questions[]
    - Question { id, kind: single|multiple|text, title, required, options?, maxChoices? }
  - Response { pollId, respondentName?, items[] }
    - ResponseItem { questionId|dateSlotId, value }

- __Règles__
  - Validation côté client pour types single/multiple (maxChoices) et required
  - Type-safety via TypeScript unions discriminants pour `kind`

### 4) Schéma DB (Supabase) et parité localStorage (LATER, sans migration)

- __Tables (proposition)__
  - polls(id, type, title, slug, created_at, ...)
  - date_options(poll_id, date)
  - time_slots(poll_id, date_option_id, start, end)
  - questions(poll_id, question_id, kind, title, required, max_choices)
  - question_options(poll_id, question_id, option_id, label)
  - responses(id, poll_id, respondent_name, created_at)
  - response_items(response_id, question_id?, date_option_id?, time_slot_id?, value_text?, option_id?)

- __Local dev__
  - Structure JSON miroir pour `dev-polls` dans localStorage afin de tester sans Supabase.
  - Migration legacy: les anciens brouillons de formulaires stockés sous `dev-form-polls` sont migrés automatiquement vers `dev-polls` à la lecture (voir `migrateFormDraftsIntoUnified()` interne à `src/lib/pollStorage.ts`). La clé legacy est nettoyée après fusion.

### 4.b) Stockage unifié & APIs (DEV)

- __Clé unique__
  - `dev-polls`: contient une liste de `Poll` où `poll.type` discrimine `"date"` ou `"form"`.

- __Helpers (`src/lib/pollStorage.ts`)__
  - `getAllPolls()` retourne la liste unifiée après migration; valide chaque entrée selon son type.
  - `getPolls()` retourne uniquement les sondages de type date (compat ascendante UI existante).
  - `addPoll(poll)` valide par type puis ajoute à l’unifié.
  - `deletePollById(id)`, `duplicatePoll(poll)`, `getPollBySlugOrId(key)`, `savePolls(polls)`, `buildPublicLink(slug)`, `copyToClipboard(text)`.

- __Validation__
  - Type `date`: `settings.selectedDates` doit être un tableau non vide de chaînes.
  - Type `form`: `title` non vide; `questions` libre (MVP). Des validations supplémentaires seront ajoutées avec le moteur de questions.

- __Comportements UI clés__
  - Dashboard consomme `getAllPolls()` pour lister tous les sondages.
  - Création Date poll (dev) pose `type: "date"` dans les objets persistés localement.
  - Création Form poll (dev) persiste les brouillons et finalisations via la liste unifiée avec `type: "form"`.

### 5) Impact API & composants (LATER)

- __Front__
  - `src/components/polls/`: créateur FormPoll (questions); persistance via stockage unifié.
  - `src/components/Dashboard.tsx`: liste l’unifié via `getAllPolls()` (plus de lecture `dev-form-polls`).
  - `src/components/voting/`: rendu FormPoll (single/multiple/text).
  - `src/hooks/usePolls.ts`: en dev, les créations locales de Date poll posent `type: 'date'`.
  - `src/pages/Results.tsx`: afficher aggrégations FormPoll.
  - Feature flag léger: `enableFormPoll` pour gating UI.

- __Tests existants__
  - Vérifier `data-testid` sur nouveaux composants

- __Unit (ajout)__
  - `src/lib/__tests__/pollStorage.test.ts` couvre `getAllPolls()`, la migration `dev-form-polls` -> `dev-polls`, et la validation minimale des FormPolls.
