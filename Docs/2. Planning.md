# DooDates - Planning de D√©veloppement 

### A VOIR

## Prochaine √©tape
- **Interface chat am√©lior√©e**
  - Cr√©ation de questionnaire par IA
  - Modification possible
  - Historique conversations
- **Exporter** ‚Üí CSV/PDF des r√©sultats
- **PWA Features** : Installable, notifications push, offline

### √âtat d'avancement

- __En cours__

- __√Ä faire__
solve Gemini test problems

 - __Dashboard__
    - Export: action ‚ÄúExporter CSV‚Äù (owner-only) depuis carte sondage (int√©grer √† PollActions), et depuis la page R√©sultats.
      - Not√© en bas de la page
    - Archive: support complet du statut archived:
        - Bouton ‚ÄúArchiver‚Äù dans PollActions.
        - Filtre ‚Äúarchived‚Äù (actuellement non propos√© dans les boutons de filtre alors que g√©r√© dans 
        getStatusColor()
        ).
    - Tri & pagination: tri par updated_at, votes_count, participants_count; pagination si > N √©l√©ments.
    - Partage rapide: bouton ‚ÄúCopier le lien public‚Äù visible; badge ‚ÄúLien copi√©‚Äù.
    - Indicateurs: meilleure(s) date(s) (r√©sum√© 1‚Äì2 chips) pour les DatePolls.
    - Claim de sondage: si cr√©√© sans compte, action ‚ÄúAssocier √† mon compte‚Äù (flow de claim via token).

- __R√©ponses aux formulaires__
    - Pages longues type Typeform.
      - Flow multi-√©tapes en pleine page avec transitions douces:
        - Une question par √©cran, navigation ¬´ Suivant/Pr√©c√©dent ¬ª, barre de progression.
        - Validation par √©tape, autosave, reprise.
        - Mobile-first, performances (√©viter re-renders lourds), ancrages si n√©cessaire.
     - QUESTION: Seuils/valeurs: fixer des seuils cibles pour pagination texte (ex: >50 r√©ponses ‚Üí ¬´ Voir plus ¬ª) et N pour pagination Dashboard.


- __Sans Compte Owner Token__
  - @Sans-Compte-OwnerToken.md

  - __Priorit√© 1 ‚Äî Bloquants MVP FormPoll__
    - Accessibilit√© (√©diteur + vote): focus management, `aria-describedby`/`aria-live`, labels explicites.

  - __Priorit√© 2 ‚Äî Qualit√© et UX mobile__

    - Performance: rendre uniquement la question active (d√©j√† fait) + pr√©parer la virtualisation si > 20 questions.
  
    - Histogrammes r√©sultats FormPoll (mini barres) + pagination l√©g√®re pour texte
      - Afficher les r√©sultats d‚Äôun sondage ¬´ formulaire ¬ª sous forme de petites barres horizontales (micro-histogrammes) par option ou champ.
      - UX: lisible en compact (cartes, section r√©cap).
      - Tech: composant de barre simple (width = pourcentage), gestion des √©galit√©s, couleurs accessibles.
      - Pagination l√©g√®re: si une question texte libre a beaucoup de r√©ponses, afficher par pages ou ¬´ Voir plus ¬ª pour n‚Äôen montrer qu‚Äôun √©chantillon √† la fois.    
      - QUESTION: Pr√©ciser l‚Äô√©chelle (pourcentage vs valeur brute), troncature des labels, et gestion des ex-aequo.


    - Analytics pour moi: taux de compl√©tion, erreurs validation.
      - Suivre les m√©triques cl√©s du flow de r√©ponse:
        - Taux de compl√©tion: r√©pondants ayant fini / ayant commenc√©.
        - Abandons par √©tape: o√π les gens quittent.
        - Erreurs de validation: volume et type (ex: champ requis manqu√©).
      - Tech: instrumentation d‚Äô√©v√©nements (start, next, submit, validation_error) + tableau de bord agr√©g√©.
  
  - __Priorit√© 3 ‚Äî Gouvernance et robustesse__

    - Anti-doublons avanc√© (empreinte locale optionnelle, seuil anti double-submit).
      - Emp√™cher soumissions r√©p√©t√©es accidentelles ou abus:
        - Double-submit: d√©sactiver le bouton apr√®s clic, idempotence c√¥t√© API (token de soumission), seuil de tempo (ex: 3‚Äì5 s).
        - Empreinte locale optionnelle: hash local (device + pollId + contenu) stock√© en localStorage pour alerter l‚Äôutilisateur si la m√™me r√©ponse est d√©j√† envoy√©e depuis ce navigateur.
        - Sans bloquer des cas l√©gitimes (option ¬´ envoyer quand m√™me ¬ª).
      - QUESTION: D√©cider si l‚Äôempreinte locale bloque ou alerte; d√©finir le d√©lai anti double-submit (ex: 3‚Äì5 s).

    - Reordering/Duplication robustes avec conservation du focus.
      - Obligatoire (MVP) ‚Äî focus apr√®s duplication: focus automatique sur l‚Äôinput titre de la question dupliqu√©e.
      - Obligatoire (MVP) ‚Äî focus apr√®s r√©ordonnancement: conserver exactement le focus (titre ou option) et la position de scroll.
      - Optionnel (post-MVP) ‚Äî raccourcis clavier et annonces ARIA:
        - Raccourcis productivit√©: Alt+Fl√®che Haut/Bas pour d√©placer la question active; Ctrl+D pour dupliquer.
        - Annonces ARIA via une r√©gion `aria-live="polite"` ("Question d√©plac√©e en position N").
        - Conserver la navigation Tab coh√©rente apr√®s op√©rations.
      - Stabilit√© des IDs/keys:
        - V√©rifier/garantir des IDs uniques pour les options lors d‚Äôune duplication (aujourd‚Äôhui les options sont recopi√©es telles quelles). D√©cider si l‚Äôunicit√© inter-questions est n√©cessaire; au minimum, √©viter collisions au sein d‚Äôune m√™me question.
      - UX mobile: indicateur visuel de focus, grandes zones de clic pour les boutons Monter/Descendre/Dupliquer, pas de saut intempestif de scroll.
      - Tests (RTL/Vitest):
        - Duplication (MVP): le focus arrive sur l‚Äôinput titre de la question clon√©e.
        - R√©ordonnancement (MVP): le focus reste sur le m√™me champ logique apr√®s move up/down.
        - Optionnel: annonce ARIA √©mise + raccourcis clavier (Alt+‚Üë/‚Üì, Ctrl+D).

  - __Hors scope MVP (plus tard)__

    - Logique conditionnelle entre questions (branching).

    - Scoring, quotas.
      - Scoring: attribuer des points/poids aux r√©ponses pour calculer un score (ex: priorisation, matching).
      - Quotas: limites par option/segment (ex: max 100 r√©ponses pour ¬´ cr√©neau A ¬ª), avec feedback temps-r√©el quand un quota est atteint.
      - Tech: validation c√¥t√© serveur, verrouillage optimiste, messages d‚Äô√©tat √† l‚ÄôUI.
      - Cas d‚Äôusage:
        - FormPoll: √©tudes, inscriptions limit√©es, matching/qualification.
        - DatePoll: plafonner des cr√©neaux, √©quilibrer des groupes.
        - Impl√©mentation typique: r√®gles c√¥t√© serveur (validation + verrouillage optimiste) et feedback UI temps r√©el.
      - QUESTION: D√©finir la source de v√©rit√© serveur + √©tats UI (complet, presque plein, ferm√©).


    - Fichiers upload√©s.

    - Auth forc√©e des r√©pondants.

### IA conversationnelle avanc√©e
**Objectif :** IA compl√®te avec parsing avanc√©

**Fonctionnalit√©s IA avanc√©es :**
```typescript
// ai/advanced/
‚îú‚îÄ‚îÄ ContextManager.ts       // Gestion contexte conversation
‚îú‚îÄ‚îÄ DateTimeParser.ts       // Parsing dates/heures NLP
‚îú‚îÄ‚îÄ SmartSuggestions.ts     // Suggestions intelligentes
‚îú‚îÄ‚îÄ LearningEngine.ts       // Apprentissage pr√©f√©rences
‚îî‚îÄ‚îÄ ConversationFlow.ts     // Flow conversation optimis√©
```
**Parsing avanc√© :**
- "mercredi prochain" ‚Üí date exacte
- "15h-17h" ‚Üí cr√©neaux horaires
- "Paul et Marie" ‚Üí participants
- "r√©union √©quipe" ‚Üí contexte m√©tier

## Backlog
- **Flux avec emails**
- **Templates d'emails professionnels** : Cr√©ation, vote confirmation, notifications
- **Analytics** : M√©triques usage + performance
- **Syst√®me de Paiement**

### Connexion Calendrier (Optionnelle et Discr√®te)
- **Proposition automatique** apr√®s s√©lection des dates
- **Lien direct** : "Connecter votre calendrier (optionnel)" cliquable
- **Fermeture discr√®te** : Croix pour masquer cette section
- **Interface minimaliste** : Une seule ligne avec lien et bouton fermer
- **Compl√®tement optionnel** : peut √™tre ignor√© ou ferm√©

### Supabase
- **Supabase Integration** : Remplacement localStorage par vraie DB mobile-optimis√©e
    - **Configuration Projet :**
      - **Nom projet :** `doodates-prod`
      - **R√©gion :** Europe (eu-west-1)
      - **Plan :** Pro (25$/mois - n√©cessaire pour RLS avanc√©)
      - **Environnements :**
        - `doodates-dev` (d√©veloppement)
        - `doodates-staging` (tests)
        - `doodates-prod` (production)

### Others
- **API Routes** : CRUD optimis√© pour mobile
- **S√©curit√© :**
- Row Level Security (RLS) activ√© sur toutes les tables
- Policies restrictives par d√©faut
- API Keys s√©par√©es par environnement
- CORS configur√© pour domaines autoris√©s
- **Beta Launch** : 50+ early adopters focus mobile

### Authentication
**Objectif :** Syst√®me d'auth flexible (connect√© + anonyme)
**Providers configur√©s :**
- **Google OAuth** (priorit√© - 80% des utilisateurs)
- **Email/Password** (backup - 20% des utilisateurs)
- **Anonymous** (pour votes sans inscription)
**Flux d'authentification :**
1. **Cr√©ateur de sondage** : Auth obligatoire (Google ou Email)
2. **Votant** : Auth optionnelle (peut voter avec juste email)
3. **Session anonyme** : UUID temporaire pour conversations IA

## Application mobile native (Capacitor)

### Setup Capacitor (Semaine 9)
**Objectif :** Transformer l'app web en application Android native

### APIs natives 
**Objectif :** Int√©gration fonctionnalit√©s natives Android
**Services natifs impl√©ment√©s :**
- Syst√®me de notifications push complet

## Polish & Beta Launch 
**1. Achat et Configuration du Nom de Domaine**
**2. H√©bergement et D√©ploiement**
**3. Configuration Email & DNS**
**4. Configuration Base de Donn√©es Production**
**5. S√©curit√© et Performance**
**6. Tests de Production**
**7. Configuration Domaines et Redirections**
**8. Mise en Production**


### 3) Mod√®le de domaine unifi√© (LATER)

- __Types principaux__
  - Poll { id, type, title, createdAt, ... }
  - For type `date`: options = Date + TimeSlots
  - For type `form`: questions[]
    - Question { id, kind: single|multiple|text, title, required, options?, maxChoices? }
  - Response { pollId, respondentName?, items[] }
    - ResponseItem { questionId|dateSlotId, value }

- __R√®gles__
  - Validation c√¥t√© client pour types single/multiple (maxChoices) et required
  - Type-safety via TypeScript unions discriminants pour `kind`

### 4) Sch√©ma DB (Supabase) et parit√© localStorage (LATER, sans migration)

- __Tables (proposition)__
  - polls(id, type, title, slug, created_at, ...)
  - date_options(poll_id, date)
  - time_slots(poll_id, date_option_id, start, end)
  - questions(poll_id, question_id, kind, title, required, max_choices)
  - question_options(poll_id, question_id, option_id, label)
  - responses(id, poll_id, respondent_name, created_at)
  - response_items(response_id, question_id?, date_option_id?, time_slot_id?, value_text?, option_id?)

- __Local dev__
  - Structure JSON miroir pour `dev-polls` dans localStorage afin de tester sans Supabase.
  - Migration legacy: les anciens brouillons de formulaires stock√©s sous `dev-form-polls` sont migr√©s automatiquement vers `dev-polls` √† la lecture (voir `migrateFormDraftsIntoUnified()` interne √† `src/lib/pollStorage.ts`). La cl√© legacy est nettoy√©e apr√®s fusion.

### 4.b) Stockage unifi√© & APIs (DEV)

- __Cl√© unique__
  - `dev-polls`: contient une liste de `Poll` o√π `poll.type` discrimine `"date"` ou `"form"`.

- __Helpers (`src/lib/pollStorage.ts`)__
  - `getAllPolls()` retourne la liste unifi√©e apr√®s migration; valide chaque entr√©e selon son type.
  - `getPolls()` retourne uniquement les sondages de type date (compat ascendante UI existante).
  - `addPoll(poll)` valide par type puis ajoute √† l‚Äôunifi√©.
  - `deletePollById(id)`, `duplicatePoll(poll)`, `getPollBySlugOrId(key)`, `savePolls(polls)`, `buildPublicLink(slug)`, `copyToClipboard(text)`.

- __Validation__
  - Type `date`: `settings.selectedDates` doit √™tre un tableau non vide de cha√Ænes.
  - Type `form`: `title` non vide; `questions` libre (MVP). Des validations suppl√©mentaires seront ajout√©es avec le moteur de questions.

- __Comportements UI cl√©s__
  - Dashboard consomme `getAllPolls()` pour lister tous les sondages.
  - Cr√©ation Date poll (dev) pose `type: "date"` dans les objets persist√©s localement.
  - Cr√©ation Form poll (dev) persiste les brouillons et finalisations via la liste unifi√©e avec `type: "form"`.

### 5) Impact API & composants (LATER)

- __Front__
  - `src/components/polls/`: cr√©ateur FormPoll (questions); persistance via stockage unifi√©.
  - `src/components/Dashboard.tsx`: liste l‚Äôunifi√© via `getAllPolls()` (plus de lecture `dev-form-polls`).
  - `src/components/voting/`: rendu FormPoll (single/multiple/text).
  - `src/hooks/usePolls.ts`: en dev, les cr√©ations locales de Date poll posent `type: 'date'`.
  - `src/pages/Results.tsx`: afficher aggr√©gations FormPoll.

- __Tests existants__
  - V√©rifier `data-testid` sur nouveaux composants

- __Unit (ajout)__
  - `src/lib/__tests__/pollStorage.test.ts` couvre `getAllPolls()`, la migration `dev-form-polls` -> `dev-polls`, et la validation minimale des FormPolls.

## Exports (CSV / PDF / XLSX)

- __D√©cision MVP__
  - CSV uniquement pour le MVP (rapide, interop, l√©ger).
  - PDF (r√©sum√© lisible) en "Later" pour partage humain.
  - XLSX r√©serv√© au palier Pro (align√© Doodle: export Excel = feature payante).

- __Points d‚Äôentr√©e UX__
  - Dashboard (`src/components/Dashboard.tsx`): action "Exporter" par sondage (menu `PollActions`).
  - R√©sultats (`/poll/:slug/results`): bouton "Exporter" visible propri√©taire.
  - √âtat: d√©sactiv√© si aucun vote/r√©ponse.

- __S√©curit√© & acc√®s__
  - Export r√©serv√© au propri√©taire (cl√© locale ownerToken ou session cr√©ateur).
  - Liens d‚Äôexport non indexables, aucune URL sign√©e c√¥t√© client en MVP.

- __Formats CSV__
  - Encodage UTF-8 avec BOM, s√©parateur ",".
  - Horodatages ISO 8601 (UTC) + colonne `timezone_display`.
  - __M√©tadonn√©es en t√™te__: `poll_id`, `poll_slug`, `poll_title`, `type`, `created_at`, `status`, `exported_at`.
  - __DatePoll (wide)__: 1 ligne par r√©pondant, 1 colonne par option (date/slot), valeurs: YES/MAYBE/NO/EMPTY.
  - __DatePoll (long)__: 1 ligne par (respondant, option) avec colonnes `choice` in {yes, maybe, no}.
  - __FormPoll (long)__: 1 ligne par (respondant, question), colonnes: `question_id`, `question_title`, `kind`, `value` (texte ou √©tiquettes jointes par `|`), `selected_count`.
  - Colonnes communes: `respondent_display`, `respondent_hash` (pseudo-ID stable local), `submitted_at`, `source` {link, email, qr}.

- __Comportements__
  - Noms de colonnes stables snake_case.
  - Valeurs √©chapp√©es (quotes) si virgules ou nouvelles lignes.
  - Fichiers nomm√©s: `doodates_{type}_{slug}_{YYYYMMDD-HHmmss}.csv`.

- __Technique (MVP client)__
  - G√©n√©ration c√¥t√© client via util `toCsv()` et `Blob` + `URL.createObjectURL`.
  - Largeur: limiter √† 10k lignes; au-del√†, proposer format long uniquement.
  - Pr√©parer hook `useExportCsv(poll)` dans `src/lib/exports.ts`.

- __√âvolutions__
  - PDF (r√©sum√©): tableau lisible + totaux + meilleures dates; rendu via `react-pdf` (later) ou serveur.
  - XLSX Pro: lib c√¥t√© client (SheetJS) ou serveur, avec onglets Wide/Long.

- __Tests__
  - Unit: snapshot CSV (small fixtures) + v√©rif BOM/encodage + valeurs YES/MAYBE/NO.
  - E2E: bouton visible/invisible selon droits, t√©l√©chargement d√©clench√©.

- __R√©f√©rences march√©__
  - Doodle: export Excel r√©serv√© aux offres payantes.
  - Framadate: export CSV accessible, format simple par option/date.

  ## Branch protection 
  - Settings ‚Üí Branches ‚Üí Branch protection rules ‚Üí Edit your main rule.
  - Enable ‚ÄúRequire status checks to pass before merging‚Äù.
  - Add required checks:
    - ‚Äúüåô Nightly E2E Matrix / e2e-matrix‚Äù
  - Optionally also require ‚Äúüåô Nightly E2E Matrix / publish-reports‚Äù to ensure Pages deploy completes.