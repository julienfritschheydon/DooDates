# DooDates - Planning de Développement 

### A VOIR

## Prochaine étape
- **Interface chat améliorée**
  - Création de questionnaire par IA
  - Modification possible
  - Historique conversations
- **Exporter** → CSV/PDF des résultats
- **PWA Features** : Installable, notifications push, offline

### État d'avancement

- __En cours__

- __À faire__
solve Gemini test problems

 - __Dashboard__
    - Export: action “Exporter CSV” (owner-only) depuis carte sondage (intégrer à PollActions), et depuis la page Résultats.
      - Noté en bas de la page
    - Archive: support complet du statut archived:
        - Bouton “Archiver” dans PollActions.
        - Filtre “archived” (actuellement non proposé dans les boutons de filtre alors que géré dans 
        getStatusColor()
        ).
    - Tri & pagination: tri par updated_at, votes_count, participants_count; pagination si > N éléments.
    - Partage rapide: bouton “Copier le lien public” visible; badge “Lien copié”.
    - Indicateurs: meilleure(s) date(s) (résumé 1–2 chips) pour les DatePolls.
    - Claim de sondage: si créé sans compte, action “Associer à mon compte” (flow de claim via token).

- __Réponses aux formulaires__
    - Pages longues type Typeform.
      - Flow multi-étapes en pleine page avec transitions douces:
        - Une question par écran, navigation « Suivant/Précédent », barre de progression.
        - Validation par étape, autosave, reprise.
        - Mobile-first, performances (éviter re-renders lourds), ancrages si nécessaire.
     - QUESTION: Seuils/valeurs: fixer des seuils cibles pour pagination texte (ex: >50 réponses → « Voir plus ») et N pour pagination Dashboard.


- __Sans Compte Owner Token__
  - @Sans-Compte-OwnerToken.md

  - __Priorité 1 — Bloquants MVP FormPoll__
    - Accessibilité (éditeur + vote): focus management, `aria-describedby`/`aria-live`, labels explicites.

  - __Priorité 2 — Qualité et UX mobile__

    - Performance: rendre uniquement la question active (déjà fait) + préparer la virtualisation si > 20 questions.
  
    - Histogrammes résultats FormPoll (mini barres) + pagination légère pour texte
      - Afficher les résultats d’un sondage « formulaire » sous forme de petites barres horizontales (micro-histogrammes) par option ou champ.
      - UX: lisible en compact (cartes, section récap).
      - Tech: composant de barre simple (width = pourcentage), gestion des égalités, couleurs accessibles.
      - Pagination légère: si une question texte libre a beaucoup de réponses, afficher par pages ou « Voir plus » pour n’en montrer qu’un échantillon à la fois.    
      - QUESTION: Préciser l’échelle (pourcentage vs valeur brute), troncature des labels, et gestion des ex-aequo.


    - Analytics pour moi: taux de complétion, erreurs validation.
      - Suivre les métriques clés du flow de réponse:
        - Taux de complétion: répondants ayant fini / ayant commencé.
        - Abandons par étape: où les gens quittent.
        - Erreurs de validation: volume et type (ex: champ requis manqué).
      - Tech: instrumentation d’événements (start, next, submit, validation_error) + tableau de bord agrégé.
  
  - __Priorité 3 — Gouvernance et robustesse__

    - Anti-doublons avancé (empreinte locale optionnelle, seuil anti double-submit).
      - Empêcher soumissions répétées accidentelles ou abus:
        - Double-submit: désactiver le bouton après clic, idempotence côté API (token de soumission), seuil de tempo (ex: 3–5 s).
        - Empreinte locale optionnelle: hash local (device + pollId + contenu) stocké en localStorage pour alerter l’utilisateur si la même réponse est déjà envoyée depuis ce navigateur.
        - Sans bloquer des cas légitimes (option « envoyer quand même »).
      - QUESTION: Décider si l’empreinte locale bloque ou alerte; définir le délai anti double-submit (ex: 3–5 s).

    - Reordering/Duplication robustes avec conservation du focus.
      - Obligatoire (MVP) — focus après duplication: focus automatique sur l’input titre de la question dupliquée.
      - Obligatoire (MVP) — focus après réordonnancement: conserver exactement le focus (titre ou option) et la position de scroll.
      - Optionnel (post-MVP) — raccourcis clavier et annonces ARIA:
        - Raccourcis productivité: Alt+Flèche Haut/Bas pour déplacer la question active; Ctrl+D pour dupliquer.
        - Annonces ARIA via une région `aria-live="polite"` ("Question déplacée en position N").
        - Conserver la navigation Tab cohérente après opérations.
      - Stabilité des IDs/keys:
        - Vérifier/garantir des IDs uniques pour les options lors d’une duplication (aujourd’hui les options sont recopiées telles quelles). Décider si l’unicité inter-questions est nécessaire; au minimum, éviter collisions au sein d’une même question.
      - UX mobile: indicateur visuel de focus, grandes zones de clic pour les boutons Monter/Descendre/Dupliquer, pas de saut intempestif de scroll.
      - Tests (RTL/Vitest):
        - Duplication (MVP): le focus arrive sur l’input titre de la question clonée.
        - Réordonnancement (MVP): le focus reste sur le même champ logique après move up/down.
        - Optionnel: annonce ARIA émise + raccourcis clavier (Alt+↑/↓, Ctrl+D).

  - __Hors scope MVP (plus tard)__

    - Logique conditionnelle entre questions (branching).

    - Scoring, quotas.
      - Scoring: attribuer des points/poids aux réponses pour calculer un score (ex: priorisation, matching).
      - Quotas: limites par option/segment (ex: max 100 réponses pour « créneau A »), avec feedback temps-réel quand un quota est atteint.
      - Tech: validation côté serveur, verrouillage optimiste, messages d’état à l’UI.
      - Cas d’usage:
        - FormPoll: études, inscriptions limitées, matching/qualification.
        - DatePoll: plafonner des créneaux, équilibrer des groupes.
        - Implémentation typique: règles côté serveur (validation + verrouillage optimiste) et feedback UI temps réel.
      - QUESTION: Définir la source de vérité serveur + états UI (complet, presque plein, fermé).


    - Fichiers uploadés.

    - Auth forcée des répondants.

### IA conversationnelle avancée
**Objectif :** IA complète avec parsing avancé

**Fonctionnalités IA avancées :**
```typescript
// ai/advanced/
├── ContextManager.ts       // Gestion contexte conversation
├── DateTimeParser.ts       // Parsing dates/heures NLP
├── SmartSuggestions.ts     // Suggestions intelligentes
├── LearningEngine.ts       // Apprentissage préférences
└── ConversationFlow.ts     // Flow conversation optimisé
```
**Parsing avancé :**
- "mercredi prochain" → date exacte
- "15h-17h" → créneaux horaires
- "Paul et Marie" → participants
- "réunion équipe" → contexte métier

## Backlog
- **Flux avec emails**
- **Templates d'emails professionnels** : Création, vote confirmation, notifications
- **Analytics** : Métriques usage + performance
- **Système de Paiement**

### Connexion Calendrier (Optionnelle et Discrète)
- **Proposition automatique** après sélection des dates
- **Lien direct** : "Connecter votre calendrier (optionnel)" cliquable
- **Fermeture discrète** : Croix pour masquer cette section
- **Interface minimaliste** : Une seule ligne avec lien et bouton fermer
- **Complètement optionnel** : peut être ignoré ou fermé

### Supabase
- **Supabase Integration** : Remplacement localStorage par vraie DB mobile-optimisée
    - **Configuration Projet :**
      - **Nom projet :** `doodates-prod`
      - **Région :** Europe (eu-west-1)
      - **Plan :** Pro (25$/mois - nécessaire pour RLS avancé)
      - **Environnements :**
        - `doodates-dev` (développement)
        - `doodates-staging` (tests)
        - `doodates-prod` (production)

### Others
- **API Routes** : CRUD optimisé pour mobile
- **Sécurité :**
- Row Level Security (RLS) activé sur toutes les tables
- Policies restrictives par défaut
- API Keys séparées par environnement
- CORS configuré pour domaines autorisés
- **Beta Launch** : 50+ early adopters focus mobile

### Authentication
**Objectif :** Système d'auth flexible (connecté + anonyme)
**Providers configurés :**
- **Google OAuth** (priorité - 80% des utilisateurs)
- **Email/Password** (backup - 20% des utilisateurs)
- **Anonymous** (pour votes sans inscription)
**Flux d'authentification :**
1. **Créateur de sondage** : Auth obligatoire (Google ou Email)
2. **Votant** : Auth optionnelle (peut voter avec juste email)
3. **Session anonyme** : UUID temporaire pour conversations IA

## Application mobile native (Capacitor)

### Setup Capacitor (Semaine 9)
**Objectif :** Transformer l'app web en application Android native

### APIs natives 
**Objectif :** Intégration fonctionnalités natives Android
**Services natifs implémentés :**
- Système de notifications push complet

## Polish & Beta Launch 
**1. Achat et Configuration du Nom de Domaine**
**2. Hébergement et Déploiement**
**3. Configuration Email & DNS**
**4. Configuration Base de Données Production**
**5. Sécurité et Performance**
**6. Tests de Production**
**7. Configuration Domaines et Redirections**
**8. Mise en Production**


### 3) Modèle de domaine unifié (LATER)

- __Types principaux__
  - Poll { id, type, title, createdAt, ... }
  - For type `date`: options = Date + TimeSlots
  - For type `form`: questions[]
    - Question { id, kind: single|multiple|text, title, required, options?, maxChoices? }
  - Response { pollId, respondentName?, items[] }
    - ResponseItem { questionId|dateSlotId, value }

- __Règles__
  - Validation côté client pour types single/multiple (maxChoices) et required
  - Type-safety via TypeScript unions discriminants pour `kind`

### 4) Schéma DB (Supabase) et parité localStorage (LATER, sans migration)

- __Tables (proposition)__
  - polls(id, type, title, slug, created_at, ...)
  - date_options(poll_id, date)
  - time_slots(poll_id, date_option_id, start, end)
  - questions(poll_id, question_id, kind, title, required, max_choices)
  - question_options(poll_id, question_id, option_id, label)
  - responses(id, poll_id, respondent_name, created_at)
  - response_items(response_id, question_id?, date_option_id?, time_slot_id?, value_text?, option_id?)

- __Local dev__
  - Structure JSON miroir pour `dev-polls` dans localStorage afin de tester sans Supabase.
  - Migration legacy: les anciens brouillons de formulaires stockés sous `dev-form-polls` sont migrés automatiquement vers `dev-polls` à la lecture (voir `migrateFormDraftsIntoUnified()` interne à `src/lib/pollStorage.ts`). La clé legacy est nettoyée après fusion.

### 4.b) Stockage unifié & APIs (DEV)

- __Clé unique__
  - `dev-polls`: contient une liste de `Poll` où `poll.type` discrimine `"date"` ou `"form"`.

- __Helpers (`src/lib/pollStorage.ts`)__
  - `getAllPolls()` retourne la liste unifiée après migration; valide chaque entrée selon son type.
  - `getPolls()` retourne uniquement les sondages de type date (compat ascendante UI existante).
  - `addPoll(poll)` valide par type puis ajoute à l’unifié.
  - `deletePollById(id)`, `duplicatePoll(poll)`, `getPollBySlugOrId(key)`, `savePolls(polls)`, `buildPublicLink(slug)`, `copyToClipboard(text)`.

- __Validation__
  - Type `date`: `settings.selectedDates` doit être un tableau non vide de chaînes.
  - Type `form`: `title` non vide; `questions` libre (MVP). Des validations supplémentaires seront ajoutées avec le moteur de questions.

- __Comportements UI clés__
  - Dashboard consomme `getAllPolls()` pour lister tous les sondages.
  - Création Date poll (dev) pose `type: "date"` dans les objets persistés localement.
  - Création Form poll (dev) persiste les brouillons et finalisations via la liste unifiée avec `type: "form"`.

### 5) Impact API & composants (LATER)

- __Front__
  - `src/components/polls/`: créateur FormPoll (questions); persistance via stockage unifié.
  - `src/components/Dashboard.tsx`: liste l’unifié via `getAllPolls()` (plus de lecture `dev-form-polls`).
  - `src/components/voting/`: rendu FormPoll (single/multiple/text).
  - `src/hooks/usePolls.ts`: en dev, les créations locales de Date poll posent `type: 'date'`.
  - `src/pages/Results.tsx`: afficher aggrégations FormPoll.

- __Tests existants__
  - Vérifier `data-testid` sur nouveaux composants

- __Unit (ajout)__
  - `src/lib/__tests__/pollStorage.test.ts` couvre `getAllPolls()`, la migration `dev-form-polls` -> `dev-polls`, et la validation minimale des FormPolls.

## Exports (CSV / PDF / XLSX)

- __Décision MVP__
  - CSV uniquement pour le MVP (rapide, interop, léger).
  - PDF (résumé lisible) en "Later" pour partage humain.
  - XLSX réservé au palier Pro (aligné Doodle: export Excel = feature payante).

- __Points d’entrée UX__
  - Dashboard (`src/components/Dashboard.tsx`): action "Exporter" par sondage (menu `PollActions`).
  - Résultats (`/poll/:slug/results`): bouton "Exporter" visible propriétaire.
  - État: désactivé si aucun vote/réponse.

- __Sécurité & accès__
  - Export réservé au propriétaire (clé locale ownerToken ou session créateur).
  - Liens d’export non indexables, aucune URL signée côté client en MVP.

- __Formats CSV__
  - Encodage UTF-8 avec BOM, séparateur ",".
  - Horodatages ISO 8601 (UTC) + colonne `timezone_display`.
  - __Métadonnées en tête__: `poll_id`, `poll_slug`, `poll_title`, `type`, `created_at`, `status`, `exported_at`.
  - __DatePoll (wide)__: 1 ligne par répondant, 1 colonne par option (date/slot), valeurs: YES/MAYBE/NO/EMPTY.
  - __DatePoll (long)__: 1 ligne par (respondant, option) avec colonnes `choice` in {yes, maybe, no}.
  - __FormPoll (long)__: 1 ligne par (respondant, question), colonnes: `question_id`, `question_title`, `kind`, `value` (texte ou étiquettes jointes par `|`), `selected_count`.
  - Colonnes communes: `respondent_display`, `respondent_hash` (pseudo-ID stable local), `submitted_at`, `source` {link, email, qr}.

- __Comportements__
  - Noms de colonnes stables snake_case.
  - Valeurs échappées (quotes) si virgules ou nouvelles lignes.
  - Fichiers nommés: `doodates_{type}_{slug}_{YYYYMMDD-HHmmss}.csv`.

- __Technique (MVP client)__
  - Génération côté client via util `toCsv()` et `Blob` + `URL.createObjectURL`.
  - Largeur: limiter à 10k lignes; au-delà, proposer format long uniquement.
  - Préparer hook `useExportCsv(poll)` dans `src/lib/exports.ts`.

- __Évolutions__
  - PDF (résumé): tableau lisible + totaux + meilleures dates; rendu via `react-pdf` (later) ou serveur.
  - XLSX Pro: lib côté client (SheetJS) ou serveur, avec onglets Wide/Long.

- __Tests__
  - Unit: snapshot CSV (small fixtures) + vérif BOM/encodage + valeurs YES/MAYBE/NO.
  - E2E: bouton visible/invisible selon droits, téléchargement déclenché.

- __Références marché__
  - Doodle: export Excel réservé aux offres payantes.
  - Framadate: export CSV accessible, format simple par option/date.
