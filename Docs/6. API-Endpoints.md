# DooDates - Spécifications API Endpoints

**Document créé le 23 juin 2025**

## Vue d'Ensemble

### Architecture API
- **Base URL :** `https://api.doodates.app` (prod) / `http://localhost:8080/api` (dev)
- **Authentication :** Bearer tokens (Supabase JWT)
- **Format :** JSON uniquement
- **Versioning :** `/v1/` dans l'URL
- **Rate Limiting :** 1000 req/h par utilisateur, 100 req/h par IP anonyme

### Standards
- **HTTP Status Codes :** Standard REST
- **Error Format :** RFC 7807 (Problem Details)
- **Pagination :** Cursor-based avec `limit` et `cursor`
- **Filtering :** Query parameters avec validation Zod
- **CORS :** Configuré pour domaines autorisés

---

## Authentication Endpoints

### POST `/api/v1/auth/signin`
Connexion utilisateur (email/password ou redirection OAuth).

**Request :**
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Response 200 :**
```json
{
  "user": {
    "id": "uuid-here",
    "email": "user@example.com",
    "full_name": "John Doe",
    "avatar_url": "https://...",
    "plan_type": "free"
  },
  "session": {
    "access_token": "jwt-token-here",
    "refresh_token": "refresh-token-here",
    "expires_at": "2025-06-24T14:30:00Z"
  }
}
```

**Errors :**
- `400` : Invalid credentials
- `429` : Too many attempts

---

### POST `/api/v1/auth/signup`
Inscription nouvel utilisateur.

**Request :**
```json
{
  "email": "user@example.com",
  "password": "securepassword123",
  "full_name": "John Doe"
}
```

**Response 201 :**
```json
{
  "user": {
    "id": "uuid-here",
    "email": "user@example.com",
    "full_name": "John Doe",
    "avatar_url": null,
    "plan_type": "free"
  },
  "message": "Confirmation email sent"
}
```

---

### POST `/api/v1/auth/signout`
Déconnexion utilisateur.

**Headers :** `Authorization: Bearer <token>`

**Response 200 :**
```json
{
  "message": "Successfully signed out"
}
```

---

### GET `/api/v1/auth/user`
Récupération du profil utilisateur connecté.

**Headers :** `Authorization: Bearer <token>`

**Response 200 :**
```json
{
  "user": {
    "id": "uuid-here",
    "email": "user@example.com",
    "full_name": "John Doe",
    "avatar_url": "https://...",
    "timezone": "Europe/Paris",
    "plan_type": "free",
    "preferences": {
      "language": "fr",
      "notifications": {
        "email_invitations": true,
        "email_reminders": true
      }
    },
    "created_at": "2025-01-15T10:00:00Z"
  }
}
```

---

## Polls Endpoints

### GET `/api/v1/polls`
Liste des sondages de l'utilisateur connecté.

**Headers :** `Authorization: Bearer <token>`

**Query Parameters :**
- `status` : `draft|active|closed|archived` (optionnel)
- `limit` : nombre max de résultats (défaut: 20, max: 100)
- `cursor` : pagination cursor
- `search` : recherche dans titre/description

**Response 200 :**
```json
{
  "polls": [
    {
      "id": "uuid-here",
      "title": "Réunion équipe",
      "description": "Planning de la réunion mensuelle",
      "slug": "reunion-equipe",
      "status": "active",
      "expires_at": "2025-07-01T18:00:00Z",
      "created_at": "2025-06-23T14:30:00Z",
      "updated_at": "2025-06-23T15:00:00Z",
      "stats": {
        "options_count": 3,
        "votes_count": 12,
        "unique_voters_count": 8
      }
    }
  ],
  "pagination": {
    "has_more": true,
    "next_cursor": "cursor-string",
    "total_count": 45
  }
}
```

---

### POST `/api/v1/polls`
Création d'un nouveau sondage.

**Headers :** `Authorization: Bearer <token>`

**Request :**
```json
{
  "title": "Réunion équipe",
  "description": "Planning de la réunion mensuelle",
  "options": [
    {
      "option_date": "2025-07-01",
      "time_slots": [
        {
          "start_hour": 14,
          "start_minute": 0,
          "end_hour": 15,
          "end_minute": 0,
          "label": "14h00 - 15h00"
        }
      ]
    },
    {
      "option_date": "2025-07-02",
      "time_slots": []
    }
  ],
  "participants": [
    "paul@example.com",
    "marie@example.com"
  ],
  "settings": {
    "time_granularity": 60,
    "allow_anonymous_votes": true,
    "allow_maybe_votes": true,
    "send_notifications": true,
    "expires_at": "2025-07-15T18:00:00Z"
  }
}
```

**Response 201 :**
```json
{
  "poll": {
    "id": "uuid-here",
    "title": "Réunion équipe",
    "slug": "reunion-equipe",
    "status": "draft",
    "share_url": "https://doodates.app/poll/reunion-equipe",
    "created_at": "2025-06-23T14:30:00Z"
  }
}
```

**Errors :**
- `400` : Validation error
- `402` : Plan limit exceeded
- `422` : Invalid date/time slots

---

### GET `/api/v1/polls/:slug`
Détail d'un sondage (public si actif, privé si propriétaire).

**Response 200 :**
```json
{
  "poll": {
    "id": "uuid-here",
    "title": "Réunion équipe",
    "description": "Planning de la réunion mensuelle",
    "slug": "reunion-equipe",
    "status": "active",
    "creator": {
      "name": "John Doe",
      "email": "john@example.com"
    },
    "options": [
      {
        "id": "option-uuid-1",
        "option_date": "2025-07-01",
        "time_slots": [
          {
            "id": "slot-1",
            "start_hour": 14,
            "start_minute": 0,
            "end_hour": 15,
            "end_minute": 0,
            "label": "14h00 - 15h00"
          }
        ]
      }
    ],
    "settings": {
      "allow_anonymous_votes": true,
      "allow_maybe_votes": true,
      "time_granularity": 60
    },
    "expires_at": "2025-07-15T18:00:00Z",
    "created_at": "2025-06-23T14:30:00Z"
  }
}
```

**Errors :**
- `404` : Poll not found
- `403` : Poll is private

---

### PUT `/api/v1/polls/:id`
Modification d'un sondage (propriétaire uniquement).

**Headers :** `Authorization: Bearer <token>`

**Request :** (mêmes champs que création, tous optionnels)
```json
{
  "title": "Nouveau titre",
  "status": "active"
}
```

**Response 200 :**
```json
{
  "poll": {
    "id": "uuid-here",
    "title": "Nouveau titre",
    "status": "active",
    "updated_at": "2025-06-23T15:30:00Z"
  }
}
```

---

### DELETE `/api/v1/polls/:id`
Suppression d'un sondage (propriétaire uniquement).

**Headers :** `Authorization: Bearer <token>`

**Response 204 :** No content

---

### POST `/api/v1/polls/:slug/share`
Partage d'un sondage (envoi d'invitations).

**Headers :** `Authorization: Bearer <token>`

**Request :**
```json
{
  "emails": [
    "new-participant@example.com"
  ],
  "message": "Message personnalisé optionnel"
}
```

**Response 200 :**
```json
{
  "sent_count": 1,
  "failed_emails": [],
  "message": "Invitations sent successfully"
}
```

---

## Votes Endpoints

### GET `/api/v1/polls/:slug/votes`
Liste des votes d'un sondage.

**Query Parameters :**
- `include_details` : `true|false` (inclure détails votants)

**Response 200 :**
```json
{
  "votes": [
    {
      "id": "vote-uuid",
      "voter_name": "Paul Dupont",
      "voter_email": "paul@example.com",
      "selections": {
        "option-uuid-1": {
          "vote": "yes",
          "time_slots": {
            "slot-1": "yes"
          }
        }
      },
      "comment": "Parfait pour moi !",
      "created_at": "2025-06-23T16:00:00Z"
    }
  ],
  "summary": {
    "total_votes": 8,
    "results": {
      "option-uuid-1": {
        "yes_count": 5,
        "no_count": 2,
        "maybe_count": 1
      }
    }
  }
}
```

---

### POST `/api/v1/polls/:slug/votes`
Création/mise à jour d'un vote.

**Request :**
```json
{
  "voter_name": "Paul Dupont",
  "voter_email": "paul@example.com",
  "selections": {
    "option-uuid-1": {
      "vote": "yes",
      "time_slots": {
        "slot-1": "yes",
        "slot-2": "maybe"
      }
    },
    "option-uuid-2": {
      "vote": "no"
    }
  },
  "comment": "Parfait pour moi !"
}
```

**Response 201/200 :**
```json
{
  "vote": {
    "id": "vote-uuid",
    "voter_name": "Paul Dupont",
    "voter_email": "paul@example.com",
    "created_at": "2025-06-23T16:00:00Z",
    "updated_at": "2025-06-23T16:00:00Z"
  }
}
```

**Errors :**
- `400` : Invalid selections
- `404` : Poll not found or expired
- `409` : Email already voted (si pas de mise à jour autorisée)

---

### DELETE `/api/v1/polls/:slug/votes/:email`
Suppression d'un vote (propriétaire du sondage ou votant).

**Response 204 :** No content

---

## Conversations Endpoints (IA)

### GET `/api/v1/conversations`
Liste des conversations de l'utilisateur.

**Headers :** `Authorization: Bearer <token>` (optionnel)

**Query Parameters :**
- `session_id` : ID de session pour utilisateurs anonymes
- `status` : `active|completed|abandoned`
- `limit` : nombre max de résultats

**Response 200 :**
```json
{
  "conversations": [
    {
      "id": "conv-uuid",
      "title": "Réunion équipe - Discussion",
      "status": "completed",
      "poll_id": "poll-uuid",
      "message_count": 8,
      "created_at": "2025-06-23T14:00:00Z",
      "updated_at": "2025-06-23T14:15:00Z"
    }
  ]
}
```

---

### POST `/api/v1/conversations`
Création d'une nouvelle conversation.

**Headers :** `Authorization: Bearer <token>` (optionnel)

**Request :**
```json
{
  "session_id": "session-uuid", // requis si pas connecté
  "initial_message": "Je veux organiser une réunion"
}
```

**Response 201 :**
```json
{
  "conversation": {
    "id": "conv-uuid",
    "session_id": "session-uuid",
    "status": "active",
    "created_at": "2025-06-23T14:00:00Z"
  }
}
```

---

### GET `/api/v1/conversations/:id`
Détail d'une conversation avec historique des messages.

**Response 200 :**
```json
{
  "conversation": {
    "id": "conv-uuid",
    "title": "Réunion équipe - Discussion",
    "status": "active",
    "poll_id": null,
    "messages": [
      {
        "id": "msg-1",
        "role": "user",
        "content": "Je veux organiser une réunion",
        "timestamp": "2025-06-23T14:00:00Z"
      },
      {
        "id": "msg-2",
        "role": "assistant",
        "content": "Parfait ! Pour quelle date souhaitez-vous organiser cette réunion ?",
        "timestamp": "2025-06-23T14:00:02Z"
      }
    ],
    "context": {
      "extracted_info": {
        "title": "Réunion équipe",
        "dates": [],
        "participants": []
      }
    }
  }
}
```

---

### POST `/api/v1/conversations/:id/messages`
Ajout d'un message à une conversation (déclenche réponse IA).

**Request :**
```json
{
  "content": "Mardi ou mercredi prochain"
}
```

**Response 200 :** (Streaming SSE ou WebSocket)
```json
{
  "user_message": {
    "id": "msg-3",
    "role": "user",
    "content": "Mardi ou mercredi prochain",
    "timestamp": "2025-06-23T14:05:00Z"
  },
  "assistant_message": {
    "id": "msg-4",
    "role": "assistant",
    "content": "Parfait ! Je propose mardi 25 juin et mercredi 26 juin. À quelle heure préférez-vous ?",
    "timestamp": "2025-06-23T14:05:03Z"
  },
  "updated_context": {
    "extracted_info": {
      "title": "Réunion équipe",
      "dates": ["2025-06-25", "2025-06-26"],
      "participants": []
    }
  }
}
```

---

## Real-time Endpoints (WebSocket)

### WebSocket `/api/v1/ws/polls/:slug`
Connexion temps réel pour un sondage.

**Events reçus :**
```json
{
  "type": "vote_created",
  "data": {
    "vote": { /* vote object */ },
    "updated_summary": { /* summary object */ }
  }
}

{
  "type": "vote_updated", 
  "data": { /* same as above */ }
}

{
  "type": "vote_deleted",
  "data": {
    "voter_email": "user@example.com",
    "updated_summary": { /* summary object */ }
  }
}

{
  "type": "poll_updated",
  "data": {
    "poll": { /* poll object */ }
  }
}
```

---

## Error Handling

### Format d'erreur standard (RFC 7807)
```json
{
  "type": "https://doodates.app/errors/validation-error",
  "title": "Validation Error",
  "status": 400,
  "detail": "The request body contains invalid data",
  "instance": "/api/v1/polls",
  "errors": [
    {
      "field": "title",
      "code": "required",
      "message": "Title is required"
    },
    {
      "field": "options",
      "code": "min_length",
      "message": "At least one option is required"
    }
  ]
}
```

### Codes d'erreur spécifiques
- `POLL_NOT_FOUND` : Sondage introuvable
- `POLL_EXPIRED` : Sondage expiré
- `VOTE_ALREADY_EXISTS` : Vote déjà existant
- `PLAN_LIMIT_EXCEEDED` : Limite du plan atteinte
- `INVALID_TIME_SLOTS` : Créneaux horaires invalides
- `EMAIL_ALREADY_INVITED` : Email déjà invité

---

## Rate Limiting

### Limites par endpoint
- **Auth endpoints** : 10 req/min par IP
- **Poll creation** : 5 req/min par utilisateur
- **Vote submission** : 20 req/min par IP
- **IA conversations** : 30 req/min par utilisateur
- **General API** : 1000 req/h par utilisateur

### Headers de réponse
```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1719154800
```

---

## Validation Schemas (Zod)

### Poll Creation Schema
```typescript
const PollCreateSchema = z.object({
  title: z.string().min(1).max(200),
  description: z.string().max(1000).optional(),
  options: z.array(z.object({
    option_date: z.string().date(),
    time_slots: z.array(z.object({
      start_hour: z.number().min(0).max(23),
      start_minute: z.number().min(0).max(59),
      end_hour: z.number().min(0).max(23),
      end_minute: z.number().min(0).max(59),
      label: z.string().optional()
    })).optional()
  })).min(1).max(30),
  participants: z.array(z.string().email()).max(100),
  settings: z.object({
    time_granularity: z.number().default(60),
    allow_anonymous_votes: z.boolean().default(true),
    allow_maybe_votes: z.boolean().default(true),
    send_notifications: z.boolean().default(true),
    expires_at: z.string().datetime().optional()
  }).optional()
});
```

---

**Document créé le 23 juin 2025**  
**Status :** Spécifications API complètes Phase 2  
**Prochaine étape :** Implémentation endpoints 